cscope 15 $HOME/venky/code               0000167173
	@debug.h

42 #iâdeà
_DEBUG_H_


43 
	#_DEBUG_H_


	)

45 
	~<lšux/k”Ãl.h
>

47 
	#USB_STORAGE
 "usb-¡Üage: "

	)

49 #ifdeà
CONFIG_USB_STORAGE_DEBUG


50 
usb_¡Ü_show_commªd
(cÚ¡ 
us_d©a
 *
us
, 
scsi_cmnd
 *
¤b
);

51 
usb_¡Ü_show_£n£
(cÚ¡ 
us_d©a
 *
us
, 
key
,

52 
asc
, 
ascq
);

53 
	$__´štf
(2, 3è
	`usb_¡Ü_dbg
(cÚ¡ 
us_d©a
 *
us
,

54 cÚ¡ *
fmt
, ...);

56 
	#US_DEBUGPX
(
fmt
, ...è
	`´štk
(fmt, ##
__VA_ARGS__
)

	)

57 
	#US_DEBUG
(
x
è
	)
x

59 
	$__´štf
(2, 3)

60 
šlše
 
	$_usb_¡Ü_dbg
(cÚ¡ 
us_d©a
 *
us
,

61 cÚ¡ *
fmt
, ...)

63 
	}
}

64 
	#usb_¡Ü_dbg
(
us
, 
fmt
, ...) \

65 dØ{ ià(0è
	`_usb_¡Ü_dbg
(
us
, 
fmt
, ##
__VA_ARGS__
); } 0)

	)

66 
	#US_DEBUGPX
(
fmt
, ...) \

67 dØ{ ià(0è
	`´štk
(
fmt
, ##
__VA_ARGS__
); } 0)

	)

68 
	#US_DEBUG
(
x
)

	)

	@driver.c

1 #ifdeà
CONFIG_USB_STORAGE_DEBUG


2 
	#DEBUG


	)

5 
	~<lšux/sched.h
>

6 
	~<lšux/sched.h
>

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/ä“z”.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/¦ab.h
>

11 
	~<lšux/kth»ad.h
>

12 
	~<lšux/mu‹x.h
>

13 
	~<lšux/ut¢ame.h
>

15 
	~<scsi/scsi.h
>

16 
	~<scsi/scsi_cmnd.h
>

17 
	~<scsi/scsi_deviû.h
>

19 
	~"usb.h
"

20 
	~"scsiglue.h
"

21 
	~"debug.h
"

22 
	~"Œª¥Üt.h
"

23 
	~"´ÙocŞ.h
"

25 #ià
IS_ENABLED
(
CONFIG_USB_UAS
)

29 
MODULE_AUTHOR
("Venkatesh");

30 
MODULE_DESCRIPTION
("USB Mass Storage Driver for Linux");

31 
MODULE_LICENSE
("GPL");

33 
	gd–ay_u£
 = 1;

34 
moduË_·¿m
(
d–ay_u£
, 
ušt
, 
S_IRUGO
 | 
S_IWUSR
);

35 
MODULE_PARM_DESC
(
d–ay_u£
, "secondso delay before using‡‚ew device");

38 
	#UNUSUAL_DEV
(
idV’dÜ
, 
idProduù
, 
bcdDeviûMš
, 
bcdDeviûMax
, \

39 
v’dÜ_Çme
, 
´oduù_Çme
, 
u£_´ÙocŞ
, 
u£_Œª¥Üt
, \

40 
š™_funùiÚ
, 
FÏgs
) \

42 .
v’dÜ_Çme
 = vendor_name, \

43 .
´oduùName
 = 
´oduù_Çme
, \

44 .
u£PrÙocŞ
 = 
u£_´ÙocŞ
, \

45 .
u£T¿n¥Üt
 = 
u£_Œª¥Üt
, \

46 .
š™FunùiÚ
 = 
š™_funùiÚ
, \

47 }

	)

49 
	#COMPLIANT_DEV
 
UNUSUAL_DEV


	)

51 
	#USUAL_DEV
(
u£_´ÙocŞ
, 
u£_Œª¥Üt
) \

53 .
u£PrÙocŞ
 = 
u£_´ÙocŞ
, \

54 .
u£T¿n¥Üt
 = 
u£_Œª¥Üt
, \

55 }

	)

58 
us_unusu®_dev
 
	gus_unusu®_dev_li¡
[] = {

63 
us_unusu®_dev
 
	gfÜ_dyÇmic_ids
 =

64 
USUAL_DEV
(
USB_SC_SCSI
, 
USB_PR_BULK
);

66 #undeà
UNUSUAL_DEV


67 #undeà
COMPLIANT_DEV


68 #undeà
USUAL_DEV


69 #undeà
UNUSUAL_VENDOR_INTF


71 #ifdeà
CONFIG_LOCKDEP


73 
lock_şass_key
 
	gus_š‹rçû_key
[
USB_MAXINTERFACES
];

75 
	$us_£t_lock_şass
(
mu‹x
 *mu‹x, 
usb_š‹rçû
 *
štf
)

77 
usb_deviû
 *
udev
 = 
	`š‹rçû_to_usbdev
(
štf
);

78 
usb_ho¡_cÚfig
 *
cÚfig
 = 
udev
->
aùcÚfig
;

79 
i
;

81 
i
 = 0; i < 
cÚfig
->
desc
.
bNumIÁ”çûs
; i++)

83 ià(
cÚfig
->
š‹rçû
[
i
] =ğ
štf
)

87 
	`BUG_ON
(
i
 =ğ
cÚfig
->
desc
.
bNumIÁ”çûs
);

88 
	`lockd•_£t_şass
(
mu‹x
, &
us_š‹rçû_key
[
i
]);

89 
	}
}

92 
	$us_£t_lock_şass
(
mu‹x
 *mu‹x, 
usb_š‹rçû
 *
štf
)

94 
	}
}

97 
	$usb_¡Ü_cÚŒŞ_th»ad
(* 
__us
)

99 
us_d©a
 *
us
 = (us_d©¨*)
__us
;

100 
Scsi_Ho¡
 *
ho¡
 = 
	`us_to_ho¡
(
us
);

104 
	`usb_¡Ü_dbg
(
us
, "***hread sleeping\n");

105 ià(
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË
(&
us
->
cmnd_»ady
))

107 
	`usb_¡Ü_dbg
(
us
, "***hread‡wakened\n");

110 
	`mu‹x_lock
(&(
us
->
dev_mu‹x
));

113 
	`scsi_lock
(
ho¡
);

116 ià(
us
->
¤b
 =ğ
NULL
)

118 
	`scsi_uÆock
(
ho¡
);

119 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

120 
	`usb_¡Ü_dbg
(
us
, "--ƒxiting\n");

125 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

126 
us
->
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

127 
SkFÜAbÜt
;

130 
	`scsi_uÆock
(
ho¡
);

133 ià(
us
->
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_BIDIRECTIONAL
) {

134 
	`usb_¡Ü_dbg
(
us
, "UNKNOWN data direction\n");

135 
us
->
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

140 ià(
us
->
¤b
->
deviû
->
id
 &&

141 !(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
))

143 
	`usb_¡Ü_dbg
(
us
, "Badarget‚umber (%d:%llu)\n",

144 
us
->
¤b
->
deviû
->
id
, us->¤b->deviû->
lun
);

145 
us
->
¤b
->
»suÉ
 = 
DID_BAD_TARGET
 << 16;

147 ià(
us
->
¤b
->
deviû
->
lun
 > us->
max_lun
) {

148 
	`usb_¡Ü_dbg
(
us
, "Bad LUN (%d:%llu)\n",

149 
us
->
¤b
->
deviû
->
id
, us->¤b->deviû->
lun
);

150 
us
->
¤b
->
»suÉ
 = 
DID_BAD_TARGET
 << 16;

155 ià((
us
->
¤b
->
cmnd
[0] =ğ
INQUIRY
) &&

156 (
us
->
fæags
 & 
US_FL_FIX_INQUIRY
)) {

160 
	`usb_¡Ü_dbg
(
us
, "Faking INQUIRY command\n");

161 
us
->
¤b
->
»suÉ
 = 
SAM_STAT_GOOD
;

165 
	`US_DEBUG
(
	`usb_¡Ü_show_commªd
(
us
, us->
¤b
));

166 
us
->
	`´Ùo_hªdËr
(us->
¤b
, us);

167 
	`usb_m¬k_Ï¡_busy
(
us
->
pusb_dev
);

171 
	`scsi_lock
(
ho¡
);

174 ià(
us
->
¤b
->
»suÉ
 !ğ
DID_ABORT
 << 16) {

175 
	`usb_¡Ü_dbg
(
us
, "scsi cmd done,„esult=0x%x\n",

176 
us
->
¤b
->
»suÉ
);

177 
us
->
¤b
->
	`scsi_dÚe
(us->srb);

179 
SkFÜAbÜt
:

180 
	`usb_¡Ü_dbg
(
us
, "scsi command‡borted\n");

188 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
))

190 
	`com¶‘e
(&
us
->
nÙify
);

192 
	`ş—r_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
);

193 
	`ş—r_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
);

197 
us
->
¤b
 = 
NULL
;

198 
	`scsi_uÆock
(
ho¡
);

200 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

205 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

206 ià(
	`kth»ad_should_¡İ
());

208 
	`scheduË
();

210 
	`__£t_cu¼’t_¡©e
(
TASK_RUNNING
);

212 
	}
}

214 
	$usb_¡Ü_sg_bËsize
(
usb_š‹rçû
 *
štf
)

216 
usb_deviû
 *
usb_dev
 = 
	`š‹rçû_to_usbdev
(
štf
);

218 ià(
usb_dev
->
bus
->
sg_bËsize
)

219  
usb_dev
->
bus
->
sg_bËsize
;

220  
SG_ALL
;

221 
	}
}

223 
	$assocŸ‹_dev
(
us_d©a
 *
us
, 
usb_š‹rçû
 *
štf
)

225 
us
->
pusb_dev
 = 
	`š‹rçû_to_usbdev
(
štf
);

226 
us
->
pusb_štf
 = 
štf
;

227 
us
->
iâum
 = 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
;

228 
	`usb_¡Ü_dbg
(
us
, "vendor: 0x%04x,…roduct: 0x%04x, Revision: 0x%04x\n",

229 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
idV’dÜ
),

230 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
idProduù
),

231 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
bcdDeviû
));

232 
	`usb_¡Ü_dbg
(
us
, "InterfaceSubClass: 0x%02x,…rotocol: 0x%02x\n",

233 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûSubCÏss
,

234 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûPrÙocŞ
);

237 
	`usb_£t_štfd©a
(
štf
, 
us
);

239 
	`´_šfo
("Hi dude\n");

241 
us
->
ü
 = 
	`km®loc
((*us->ü), 
GFP_KERNEL
);

242 ià(!
us
->
ü
)

243  -
ENOMEM
;

244 
us
->
iobuf
 = 
	`usb_®loc_coh”’t
(us->
pusb_dev
, 
US_IOBUF_SIZE
, 
GFP_KERNEL
,

245 &
us
->
iobuf_dma
);

246 ià(
us
->
iobuf
) {

247 
	`usb_¡Ü_dbg
(
us
, "I/O buffer‡llocation failed\n");

248  -
ENOMEM
;

251 
	}
}

253 
	$g‘_deviû_šfo
(
us_d©a
 *
us
, cÚ¡ 
usb_deviû_id
 *
id
,

254 
us_unusu®_dev
 *
unusu®_dev
)

256 
usb_deviû
 *
dev
 = 
us
->
pusb_dev
;

257 
usb_š‹rçû_desütÜ
 *
idesc
 =

258 &
us
->
pusb_štf
->
cur_®t£‰šg
->
desc
;

259 
deviû
 *
pdev
 = &
us
->
pusb_štf
->
dev
;

262 
us
->
unusu®_dev
 = unusual_dev;

263 
us
->
subşass
 = (
unusu®_dev
->
u£PrÙocŞ
 =ğ
USB_SC_DEVICE
) ?

264 
idesc
->
bIÁ”çûSubCÏss
: 
unusu®_dev
->
u£PrÙocŞ
;

265 
us
->
´ÙocŞ
 = (
unusu®_dev
->
u£T¿n¥Üt
 =ğ
USB_PR_DEVICE
) ?

266 
idesc
->
bIÁ”çûPrÙocŞ
: 
unusu®_dev
->
u£T¿n¥Üt
;

267 
us
->
fæags
 = 
id
->
driv”_šfo
;

269 ià(
us
->
fæags
 & 
US_FL_IGNORE_DEVICE
) {

270 
	`dev_šfo
(
pdev
, "Device ignored\n");

271  -
ENODEV
;

274 ià(
dev
->
¥“d
 !ğ
USB_SPEED_HIGH
)

275 
us
->
fæags
 &ğ~
US_FL_GO_SLOW
;

276 ià(
us
->
fæags
)

277 
	`dev_šfo
(
pdev
, "Quirks match for vid %04x…id %04x: %lx\n",

278 
	`Ë16_to_ıu
(
dev
->
desütÜ
.
idV’dÜ
),

279 
	`Ë16_to_ıu
(
dev
->
desütÜ
.
idProduù
),

280 
us
->
fæags
);

282 ià(
id
->
idV’dÜ
 || id->
idProduù
) {

283 cÚ¡ *
msgs
[3] = {

288 
usb_deviû_desütÜ
 *
ddesc
 = &
dev
->
desütÜ
;

289 
msg
 = -1;

291 ià(
unusu®_dev
->
u£PrÙocŞ
 !ğ
USB_SC_DEVICE
 &&

292 
us
->
subşass
 =ğ
idesc
->
bIÁ”çûSubCÏss
)

293 
msg
 += 1;

294 ià(
unusu®_dev
->
u£T¿n¥Üt
 !ğ
USB_PR_DEVICE
 &&

295 
us
->
´ÙocŞ
 =ğ
idesc
->
bIÁ”çûPrÙocŞ
)

296 
msg
 += 2;

297 ià(
msg
 > 0 && !(
us
->
fæags
 & 
US_FL_NEED_OVERRIDE
))

298 
	`dev_nÙiû
(
pdev
, "This device "

305 
	`Ë16_to_ıu
(
ddesc
->
idV’dÜ
),

306 
	`Ë16_to_ıu
(
ddesc
->
idProduù
),

307 
	`Ë16_to_ıu
(
ddesc
->
bcdDeviû
),

308 
idesc
->
bIÁ”çûSubCÏss
,

309 
idesc
->
bIÁ”çûPrÙocŞ
,

310 
msgs
[
msg
],

311 
	`ut¢ame
()->
»Ëa£
);

314 
	}
}

316 
	$g‘_Œª¥Üt
(
us_d©a
 *
us
)

318 
us
->
´ÙocŞ
) {

319 
USB_PR_BULK
:

320 
us
->
Œª¥Üt_Çme
 = "Bulk";

321 
us
->
Œª¥Üt
 = 
usb_¡Ü_Bulk_Œª¥Üt
;

322 
us
->
Œª¥Üt_»£t
 = 
usb_¡Ü_Bulk_»£t
;

325 
	}
}

327 
	$g‘_´ÙocŞ
(
us_d©a
 *
us
)

329 
us
->
subşass
)

331 
USB_SC_SCSI
:

332 
us
->
´ÙocŞ_Çme
 = "Transparent SCSI";

333 
us
->
´Ùo_hªdËr
 = 
usb_¡Ü_Œª¥¬’t_scsi_commªd
;

336 
	}
}

338 
	$g‘_pes
(
us_d©a
 *
us
)

340 
usb_ho¡_š‹rçû
 *
®t£‰šg
 = 
us
->
pusb_štf
->
cur_®t£‰šg
;

341 
i
;

342 
usb_’dpošt_desütÜ
 *
•
;

343 
usb_’dpošt_desütÜ
 *
•_š
 = 
NULL
;

344 
usb_’dpošt_desütÜ
 *
•_out
 = 
NULL
;

345 
usb_’dpošt_desütÜ
 *
•_št
 = 
NULL
;

350 
i
 = 0; i < 
®t£‰šg
->
desc
.
bNumEndpošts
; i++)

352 
•
 = &
®t£‰šg
->
’dpošt
[
i
].
desc
;

354 ià(
	`usb_’dpošt_xãr_bulk
(
•
))

356 ià(
	`usb_’dpošt_dœ_š
(
•
)) {

357 ià(!
•_š
)

358 
•_š
 = 
•
;

360 ià(!
•_out
)

361 
•_out
 = 
•
;

364 ià(
	`usb_’dpošt_is_št_š
(
•
)) {

365 ià(!
•_št
)

366 
•_št
 = 
•
;

370 ià(!
•_š
 || !
•_out
 || (
us
->
´ÙocŞ
 =ğ
USB_PR_CBI
 && !
•_št
)) {

371 
	`usb_¡Ü_dbg
(
us
,"endpoint sanity check failed!„ejecting dev\n");

372  -
EIO
;

376 
us
->
£nd_ù¾_pe
 = 
	`usb_¢dù¾pe
(us->
pusb_dev
, 0);

377 
us
->
»cv_ù¾_pe
 = 
	`usb_rcvù¾pe
(us->
pusb_dev
, 0);

378 
us
->
£nd_bulk_pe
 = 
	`usb_¢dbulkpe
(us->
pusb_dev
,

379 
	`usb_’dpošt_num
(
•_out
));

380 
us
->
»cv_bulk_pe
 = 
	`usb_rcvbulkpe
(us->
pusb_dev
,

381 
	`usb_’dpošt_num
(
•_š
));

382 ià(
•_št
) {

383 
us
->
»cv_šŒ_pe
 = 
	`usb_rcvše
(us->
pusb_dev
,

384 
	`usb_’dpošt_num
(
•_št
));

385 
us
->
•_bIÁ”v®
 = 
•_št
->
bIÁ”v®
;

388 
	}
}

390 
	$usb_¡Ü_acquœe_»sourûs
(
us_d©a
 *
us
)

392 
p
;

393 
sk_¡ruù
 *
th
;

395 
us
->
cu¼’t_urb
 = 
	`usb_®loc_urb
(0, 
GFP_KERNEL
);

396 ià(!
us
->
cu¼’t_urb
) {

397 
	`usb_¡Ü_dbg
(
us
, "URB‡llocation failed\n");

398  -
ENOMEM
;

402 ià(
us
->
unusu®_dev
->
š™FunùiÚ
) {

403 
p
 = 
us
->
unusu®_dev
->
	`š™FunùiÚ
(us);

404 ià(
p
)

405  
p
;

409 
th
 = 
	`kth»ad_run
(
usb_¡Ü_cÚŒŞ_th»ad
, 
us
, "usb-storage");

410 ià(
	`IS_ERR
(
th
)) {

411 
	`dev_w¬n
(&
us
->
pusb_štf
->
dev
,"Unableo start controlhread\n");

412  
	`PTR_ERR
(
th
);

414 
us
->
ùl_th»ad
 = 
th
;

416 
	}
}

418 
	$usb_¡Ü_»Ëa£_»sourûs
(
us_d©a
 *
us
)

420 
	`usb_¡Ü_dbg
(
us
, "-- Sendingƒxit commandohread\n");

421 
	`com¶‘e
(&
us
->
cmnd_»ady
);

422 ià(
us
->
ùl_th»ad
)

423 
	`kth»ad_¡İ
(
us
->
ùl_th»ad
);

424 ià(
us
->
exŒa_de¡ruùÜ
) {

425 
	`usb_¡Ü_dbg
(
us
, "--Callingƒxtra_destructor()\n");

426 
us
->
	`exŒa_de¡ruùÜ
(us->
exŒa
);

430 
	`kä“
(
us
->
exŒa
);

431 
	`usb_ä“_urb
(
us
->
cu¼’t_urb
);

432 
	}
}

434 
	$dissocŸ‹_dev
(
us_d©a
 *
us
)

437 
	`kä“
(
us
->
ü
);

438 
	`usb_ä“_coh”’t
(
us
->
pusb_dev
, 
US_IOBUF_SIZE
, us->
iobuf
, us->
iobuf_dma
);

440 
	`usb_£t_štfd©a
(
us
->
pusb_štf
, 
NULL
);

441 
	}
}

443 
	$»Ëa£_ev”ythšg
(
us_d©a
 *
us
)

445 
	`usb_¡Ü_»Ëa£_»sourûs
(
us
);

446 
	`dissocŸ‹_dev
(
us
);

449 
	`scsi_ho¡_put
(
	`us_to_ho¡
(
us
));

450 
	}
}

452 
	$usb_¡Ü_sÿn_dwÜk
(
wÜk_¡ruù
 *
wÜk
)

454 
us_d©a
 *
us
 = 
	`cÚš”_of
(
wÜk
, us_d©a, 
sÿn_dwÜk
.work);

455 
deviû
 *
dev
 = &
us
->
pusb_štf
->dev;

457 
	`dev_dbg
(
dev
, "start scanning\n");

460 ià(
us
->
´ÙocŞ
 =ğ
USB_PR_BULK
 && !(us->
fæags
 & 
US_FL_SINGLE_LUN
) &&

461 !(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
))

463 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

464 
us
->
max_lun
 = 
	`usb_¡Ü_Bulk_max_lun
(us);

468 ià(
us
->
max_lun
 >= 8)

469 
	`us_to_ho¡
(
us
)->
max_lun
 = us->max_lun + 1;

470 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

472 
	`scsi_sÿn_ho¡
(
	`us_to_ho¡
(
us
));

473 
	`dev_dbg
(
dev
, "scan complete \n");

476 
	`usb_autİm_put_š‹rçû
(
us
->
pusb_štf
);

477 
	`ş—r_b™
(
US_FLIDX_SCAN_PENDING
, &
us
->
dæags
);

478 
	}
}

480 
	$qu›sû_ªd_»move_ho¡
(
us_d©a
 *
us
)

482 
Scsi_Ho¡
 *
ho¡
 = 
	`us_to_ho¡
(
us
);

485 ià(
us
->
pusb_dev
->
¡©e
 =ğ
USB_STATE_NOTATTACHED
) {

486 
	`£t_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
);

487 
	`wake_up
(&
us
->
d–ay_wa™
);

491 
	`ÿnûl_d–ayed_wÜk_sync
(&
us
->
sÿn_dwÜk
);

494 ià(
	`‹¡_b™
(
US_FLIDX_SCAN_PENDING
, &
us
->
dæags
))

495 
	`usb_autİm_put_š‹rçû_no_su¥’d
(
us
->
pusb_štf
);

498 
	`scsi_»move_ho¡
(
ho¡
);

501 
	`scsi_lock
(
ho¡
);

502 
	`£t_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
);

503 
	`scsi_uÆock
(
ho¡
);

504 
	`wake_up
(&
us
->
d–ay_wa™
);

505 
	}
}

508 
	$´obe1
(
us_d©a
 **
pus
, 
usb_š‹rçû
 *
š‹rçû
,

509 cÚ¡ 
usb_deviû_id
 *
id
,

510 
us_unusu®_dev
 *
unusu®_dev
)

512 
Scsi_Ho¡
 *
ho¡
;

513 
us_d©a
 *
us
;

514 
»suÉ
;

516 
	`dev_šfo
(&
š‹rçû
->
dev
, "USB Mass Storage device detected\n");

519 
ho¡
 = 
	`scsi_ho¡_®loc
(&
usb_¡Ü_‹m¶©e
, (*
us
));

520 ià(!
ho¡
){

521 
	`dev_w¬n
(&
š‹rçû
->
dev
, "Unableo‡llocatehe scsi host\n");

522  -
ENOMEM
;

526 
ho¡
->
max_cmd_Ën
 = 16;

527 
ho¡
->
sg_bËsize
 = 
	`usb_¡Ü_sg_bËsize
(
š‹rçû
);

528 *
pus
 = 
us
 = 
	`ho¡_to_us
(
ho¡
);

529 
	`mu‹x_š™
(&(
us
->
dev_mu‹x
));

530 
	`us_£t_lock_şass
(&
us
->
dev_mu‹x
, 
š‹rçû
);

531 
	`š™_com¶‘iÚ
(&
us
->
cmnd_»ady
);

532 
	`š™_com¶‘iÚ
(&(
us
->
nÙify
));

533 
	`š™_wa™queue_h—d
(&
us
->
d–ay_wa™
);

534 
	`INIT_DELAYED_WORK
(&
us
->
sÿn_dwÜk
, 
usb_¡Ü_sÿn_dwÜk
);

537 
»suÉ
 = 
	`assocŸ‹_dev
(
us
, 
š‹rçû
);

538 ià(
»suÉ
)

539 
BadDeviû
;

541 
»suÉ
 = 
	`g‘_deviû_šfo
(
us
, 
id
, 
unusu®_dev
);

542 ià(
»suÉ
)

543 
BadDeviû
;

545 
	`g‘_Œª¥Üt
(
us
);

546 
	`g‘_´ÙocŞ
(
us
);

549 
BadDeviû
:

550 
	`usb_¡Ü_dbg
(
us
, "USB…robe() failed\n");

551 
	`»Ëa£_ev”ythšg
(
us
);

552  
»suÉ
;

553 
	}
}

555 
	$´obe2
(
us_d©a
 *
us
)

557 
»suÉ
;

558 
deviû
 *
dev
 = &
us
->
pusb_štf
->dev;

561 ià(!
us
->
Œª¥Üt
 || !us->
´Ùo_hªdËr
) {

562 
»suÉ
 = -
ENXIO
;

563 
BadDeviû
;

566 
	`usb_¡Ü_dbg
(
us
, "T¿n¥Üt: %s\n", us->
Œª¥Üt_Çme
);

567 
	`usb_¡Ü_dbg
(
us
, "PrÙocŞ: %s\n", us->
´ÙocŞ_Çme
);

569 ià(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
) {

570 
us
->
max_lun
 = 7;

571 
	`us_to_ho¡
(
us
)->
this_id
 = 7;

573 
	`us_to_ho¡
(
us
)->
max_id
 = 1;

575 ià(
us
->
Œª¥Üt
 =ğ
usb_¡Ü_Bulk_Œª¥Üt
)

576 
	`us_to_ho¡
(
us
)->
no_scsi2_lun_š_cdb
 = 1;

580 ià(
us
->
fæags
 & 
US_FL_SINGLE_LUN
)

581 
us
->
max_lun
 = 0;

583 ià((
»suÉ
 = 
	`g‘_pes
(
us
)))

584 
BadDeviû
;

588 ià(
us
->
fæags
 & 
US_FL_INITIAL_READ10
)

589 
	`£t_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
);

592 
»suÉ
 = 
	`usb_¡Ü_acquœe_»sourûs
(
us
);

593 ià(
»suÉ
)

594 
BadDeviû
;

595 
	`¢´štf
(
us
->
scsi_Çme
, (us->scsi_name), "usb-storage %s",

596 
	`dev_Çme
(&
us
->
pusb_štf
->
dev
));

597 
»suÉ
 = 
	`scsi_add_ho¡
(
	`us_to_ho¡
(
us
), 
dev
);

598 ià(
»suÉ
) {

599 
	`dev_w¬n
(
dev
, "Unableo‡ddhe scsi host\n");

600 
BadDeviû
;

604 
	`usb_autİm_g‘_š‹rçû_no_»sume
(
us
->
pusb_štf
);

605 
	`£t_b™
(
US_FLIDX_SCAN_PENDING
, &
us
->
dæags
);

607 ià(
d–ay_u£
 > 0)

610 
	`queue_d–ayed_wÜk
(
sy¡em_ä“zabË_wq
, &
us
->
sÿn_dwÜk
, 
d–ay_u£
*
HZ
);

612 
BadDeviû
:

613 
	`usb_¡Ü_dbg
(
us
, "Storage_probe() failed\n");

614 
	`»Ëa£_ev”ythšg
(
us
);

615  
»suÉ
;

616 
	}
}

618 
	$¡Üage_´obe
(
usb_š‹rçû
 *
štf
, cÚ¡ 
usb_deviû_id
 *
id
)

620 
us_unusu®_dev
 *
unusu®_dev
;

621 
us_d©a
 *
us
;

622 
»suÉ
, 
size
;

625 ià(
	`usb_usu®_ignÜe_deviû
(
štf
))

626  -
ENXIO
;

631 
size
 = 
	`ARRAY_SIZE
(
us_unusu®_dev_li¡
);

632 ià(
id
 >ğ
usb_¡Üage_usb_ids
 && id < usb_¡Üage_usb_id + 
size
) {

633 
unusu®_dev
 = (
id
 - 
usb_¡Üage_usb_ids
è+ 
us_unusu®_dev_li¡
;

635 
unusu®_dev
 = &
fÜ_dyÇmic_ids
;

636 
	`dev_šfo
(&
štf
->
dev
, "U£ Bulk-OÆy¿n¥Üˆw™hhT¿n¥ÜˆSCSI…rÙocŞ fÜ dyÇmiøid: 0x%04x 0x%04x\n", 
id
->
idV’dÜ
, id->
idProduù
);

639 
»suÉ
 = 
	`´obe1
(&
us
, 
štf
, 
id
, 
unusu®_dev
);

640 ià(
»suÉ
)

641  
»suÉ
;

644 
»suÉ
 = 
	`´obe2
(
us
);

645  
»suÉ
;

646 
	}
}

648 
	$usb_¡Ü_discÚÃù
(
usb_š‹rçû
 *
š‹rçû
)

650 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
š‹rçû
);

651 
	`qu›sû_ªd_»move_ho¡
(
us
);

652 
	`»Ëa£_ev”ythšg
(
us
);

653 
	}
}

655 
usb_driv”
 
	gusb_¡Üage_driv”
 = {

656 .
Çme
 = "venky-storage",

657 .
	g´obe
 = 
¡Üage_´obe
,

658 .
	gdiscÚÃù
 = 
usb_¡Ü_discÚÃù
,

659 .
	gid_bË
 = 
usb_¡Üage_usb_ids
,

660 .
	gsuµÜts_autosu¥’d
 = 1,

661 .
	gsoá_unbšd
 = 1,

664 
__š™
 
	$usb_¡Üage_š™
()

666 
»tv®
;

668 
	`´_šfo
("Initalizinghe USB mass storage driver...\n");

670 
»tv®
 = 
	`usb_»gi¡”
(&
usb_¡Üage_driv”
);

671 ià(
»tv®
)

672 
	`´_šfo
("USB device„egistration failed\n");

674  
»tv®
;

675 
	}
}

677 
__ex™
 
	$usb_¡Üage_ex™
()

679 
	`´_šfo
("Deregisteringhe USB driver...\n");

680 
	`usb_d”egi¡”
(&
usb_¡Üage_driv”
);

681 
	}
}

683 
moduË_š™
(
usb_¡Üage_š™
);

684 
moduË_ex™
(
usb_¡Üage_ex™
);

	@protocol.c

1 
	~<lšux/highmem.h
>

2 
	~<lšux/expÜt.h
>

3 
	~<scsi/scsi.h
>

4 
	~<scsi/scsi_cmnd.h
>

6 
	~"usb.h
"

7 
	~"´ÙocŞ.h
"

8 
	~"Œª¥Üt.h
"

11 
	$usb_¡Ü_Œª¥¬’t_scsi_commªd
(
scsi_cmnd
 *
¤b
, 
us_d©a
 *
us
)

14 
	`usb_¡Ü_švoke_Œª¥Üt
(
¤b
, 
us
);

15 
	}
}

21 
	$usb_¡Ü_acûss_xãr_buf
(*
bufãr
,

22 
buæ’
, 
scsi_cmnd
 *
¤b
, 
sÿ‰”li¡
 **
sg±r
,

23 *
off£t
, 
xãr_buf_dœ
 
dœ
)

25 
út
 = 0;

26 
sÿ‰”li¡
 *
sg
 = *
sg±r
;

27 
sg_m­pšg_™”
 
m™”
;

28 
ÃÁs
 = 
	`scsi_sg_couÁ
(
¤b
);

30 ià(
sg
)

31 
ÃÁs
 = 
	`sg_ÃÁs
(
sg
);

33 
sg
 = 
	`scsi_sgli¡
(
¤b
);

35 
	`sg_m™”_¡¬t
(&
m™”
, 
sg
, 
ÃÁs
, 
dœ
 =ğ
FROM_XFER_BUF
 ?

36 
SG_MITER_FROM_SG
 : 
SG_MITER_TO_SG
);

38 ià(!
	`sg_m™”_sk
(&
m™”
, *
off£t
))

39  
út
;

41 
	`sg_m™”_Ãxt
(&
m™”
è&& 
út
 < 
buæ’
) {

42 
Ën
 = 
	`mš_t
(, 
m™”
.
Ëngth
,

43 
buæ’
 - 
út
);

44 ià(
dœ
 =ğ
FROM_XFER_BUF
)

45 
	`memıy
(
bufãr
 + 
út
, 
m™”
.
addr
, 
Ën
);

47 
	`memıy
(
m™”
.
addr
, 
bufãr
 + 
út
, 
Ën
);

48 ià(*
off£t
 + 
Ën
 < 
m™”
.
p™”
.
sg
->
Ëngth
) {

49 *
off£t
 +ğ
Ën
;

50 *
sg±r
 = 
m™”
.
p™”
.
sg
;

52 *
off£t
 = 0;

53 *
sg±r
 = 
	`sg_Ãxt
(
m™”
.
p™”
.
sg
);

55 
út
 +ğ
Ën
;

57 
	`sg_m™”_¡İ
(&
m™”
);

58  
út
;

59 
	}
}

	@protocol.h

39 #iâdeà
_PROTOCOL_H_


40 
	#_PROTOCOL_H_


	)

43 
usb_¡Ü_·d12_commªd
(
scsi_cmnd
*, 
us_d©a
*);

44 
usb_¡Ü_ufi_commªd
(
scsi_cmnd
*, 
us_d©a
*);

45 
usb_¡Ü_Œª¥¬’t_scsi_commªd
(
scsi_cmnd
*,

46 
us_d©a
*);

49 
	exãr_buf_dœ
 {
	mTO_XFER_BUF
, 
	mFROM_XFER_BUF
};

51 
usb_¡Ü_acûss_xãr_buf
(*
bufãr
,

52 
buæ’
, 
scsi_cmnd
 *
¤b
, 
sÿ‰”li¡
 **,

53 *
off£t
, 
xãr_buf_dœ
 
dœ
);

55 
usb_¡Ü_£t_xãr_buf
(*
bufãr
,

56 
buæ’
, 
scsi_cmnd
 *
¤b
);

	@scsiglue.c

46 
	~<lšux/moduË.h
>

47 
	~<lšux/mu‹x.h
>

49 
	~<scsi/scsi.h
>

50 
	~<scsi/scsi_cmnd.h
>

51 
	~<scsi/scsi_devšfo.h
>

52 
	~<scsi/scsi_deviû.h
>

53 
	~<scsi/scsi_eh.h
>

55 
	~"usb.h
"

56 
	~"scsiglue.h
"

57 
	~"debug.h
"

58 
	~"Œª¥Üt.h
"

59 
	~"´ÙocŞ.h
"

64 
	#VENDOR_ID_NOKIA
 0x0421

	)

65 
	#VENDOR_ID_NIKON
 0x04b0

	)

66 
	#VENDOR_ID_PENTAX
 0x0a17

	)

67 
	#VENDOR_ID_MOTOROLA
 0x22b8

	)

73 cÚ¡ * 
	$ho¡_šfo
(
Scsi_Ho¡
 *
ho¡
)

75 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
ho¡
);

76  
us
->
scsi_Çme
;

77 
	}
}

79 
	$¦ave_®loc
 (
scsi_deviû
 *
sdev
)

81 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
sdev
->
ho¡
);

88 
sdev
->
šquœy_Ën
 = 36;

105 
	`blk_queue_upd©e_dma_®ignm’t
(
sdev
->
»que¡_queue
, (512 - 1));

108 ià(
us
->
´ÙocŞ
 =ğ
USB_PR_BULK
 && us->
max_lun
 > 0)

109 
sdev
->
sdev_bæags
 |ğ
BLIST_FORCELUN
;

112 
	}
}

114 
	$¦ave_cÚfigu»
(
scsi_deviû
 *
sdev
)

116 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
sdev
->
ho¡
);

122 ià(
us
->
fæags
 & (
US_FL_MAX_SECTORS_64
 | 
US_FL_MAX_SECTORS_MIN
)) {

123 
max_£ùÜs
 = 64;

125 ià(
us
->
fæags
 & 
US_FL_MAX_SECTORS_MIN
)

126 
max_£ùÜs
 = 
PAGE_CACHE_SIZE
 >> 9;

127 ià(
	`queue_max_hw_£ùÜs
(
sdev
->
»que¡_queue
è> 
max_£ùÜs
)

128 
	`blk_queue_max_hw_£ùÜs
(
sdev
->
»que¡_queue
,

129 
max_£ùÜs
);

130 } ià(
sdev
->
ty³
 =ğ
TYPE_TAPE
) {

135 
	`blk_queue_max_hw_£ùÜs
(
sdev
->
»que¡_queue
, 0x7FFFFF);

143 ià(!
us
->
pusb_dev
->
bus
->
cÚŒŞËr
->
dma_mask
)

144 
	`blk_queue_bounû_lim™
(
sdev
->
»que¡_queue
, 
BLK_BOUNCE_HIGH
);

149 ià(
sdev
->
ty³
 =ğ
TYPE_DISK
) {

157 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
idV’dÜ
)) {

158 
VENDOR_ID_NOKIA
:

159 
VENDOR_ID_NIKON
:

160 
VENDOR_ID_PENTAX
:

161 
VENDOR_ID_MOTOROLA
:

162 ià(!(
us
->
fæags
 & (
US_FL_FIX_CAPACITY
 |

163 
US_FL_CAPACITY_OK
)))

164 
us
->
fæags
 |ğ
US_FL_CAPACITY_HEURISTICS
;

171 ià(
us
->
subşass
 !ğ
USB_SC_SCSI
 && us->subşas !ğ
USB_SC_CYP_ATACB
)

172 
sdev
->
u£_10_fÜ_ms
 = 1;

176 
sdev
->
u£_192_by‹s_fÜ_3f
 = 1;

185 ià(
us
->
fæags
 & 
US_FL_NO_WP_DETECT
)

186 
sdev
->
sk_ms_·ge_3f
 = 1;

190 
sdev
->
sk_ms_·ge_8
 = 1;

193 
sdev
->
sk_vpd_·ges
 = 1;

196 
sdev
->
no_»pÜt_İcodes
 = 1;

199 
sdev
->
no_wr™e_§me
 = 1;

204 ià(
us
->
fæags
 & 
US_FL_FIX_CAPACITY
)

205 
sdev
->
fix_ÿ·c™y
 = 1;

210 ià(
us
->
fæags
 & 
US_FL_CAPACITY_HEURISTICS
)

211 
sdev
->
guess_ÿ·c™y
 = 1;

214 ià(
us
->
fæags
 & 
US_FL_NO_READ_CAPACITY_16
)

215 
sdev
->
no_»ad_ÿ·c™y_16
 = 1;

223 ià(!(
us
->
fæags
 & 
US_FL_NEEDS_CAP16
))

224 
sdev
->
Œy_rc_10_fœ¡
 = 1;

227 ià(
sdev
->
scsi_Ëv–
 > 
SCSI_SPC_2
)

228 
us
->
fæags
 |ğ
US_FL_SANE_SENSE
;

236 
sdev
->
»Œy_hw”rÜ
 = 1;

240 
sdev
->
®low_»¡¬t
 = 1;

245 
sdev
->
Ï¡_£ùÜ_bug
 = 1;

250 ià(!(
us
->
fæags
 & (
US_FL_FIX_CAPACITY
 | 
US_FL_CAPACITY_OK
 |

251 
US_FL_SCM_MULT_TARG
)) &&

252 
us
->
´ÙocŞ
 =ğ
USB_PR_BULK
)

253 
us
->
u£_Ï¡_£ùÜ_hacks
 = 1;

256 ià(
us
->
fæags
 & 
US_FL_WRITE_CACHE
)

257 
sdev
->
wû_deçuÉ_Ú
 = 1;

260 ià(
us
->
fæags
 & 
US_FL_BROKEN_FUA
)

261 
sdev
->
brok’_fua
 = 1;

268 
sdev
->
u£_10_fÜ_ms
 = 1;

271 ià(
us
->
fæags
 & 
US_FL_NO_READ_DISC_INFO
)

272 
sdev
->
no_»ad_disc_šfo
 = 1;

281 ià((
us
->
´ÙocŞ
 =ğ
USB_PR_CB
 || us->´ÙocŞ =ğ
USB_PR_CBI
) &&

282 
sdev
->
scsi_Ëv–
 =ğ
SCSI_UNKNOWN
)

283 
us
->
max_lun
 = 0;

287 ià(
us
->
fæags
 & 
US_FL_NOT_LOCKABLE
)

288 
sdev
->
lockabË
 = 0;

293 
	}
}

295 
	$rg‘_®loc
(
scsi_rg‘
 *
¡¬g‘
)

297 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
	`dev_to_sho¡
(
¡¬g‘
->
dev
.
·»Á
));

305 
¡¬g‘
->
no_»pÜt_luns
 = 1;

316 ià(
us
->
subşass
 =ğ
USB_SC_UFI
)

317 
¡¬g‘
->
pdt_1f_fÜ_no_lun
 = 1;

320 
	}
}

324 
queuecommªd_lck
(
scsi_cmnd
 *
¤b
,

325 (*
dÚe
)(
scsi_cmnd
 *))

327 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
¤b
->
deviû
->
ho¡
);

330 ià(
us
->
¤b
 !ğ
NULL
) {

331 
	`´štk
(
KERN_ERR
 
USB_STORAGE
 "Error in %s: us->srb = %p\n",

332 
__func__
, 
us
->
¤b
);

333  
SCSI_MLQUEUE_HOST_BUSY
;

337 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

338 
	`usb_¡Ü_dbg
(
us
, "Fail command during disconnect\n");

339 
¤b
->
»suÉ
 = 
DID_NO_CONNECT
 << 16;

340 
	`dÚe
(
¤b
);

345 
¤b
->
scsi_dÚe
 = 
dÚe
;

346 
us
->
¤b
 = srb;

347 
	`com¶‘e
(&
us
->
cmnd_»ady
);

350 
	}
}

352 
	$DEF_SCSI_QCMD
(
queuecommªd
)

359 
	$commªd_abÜt
(
scsi_cmnd
 *
¤b
)

361 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
¤b
->
deviû
->
ho¡
);

363 
	`usb_¡Ü_dbg
(
us
, "% ÿÎed\n", 
__func__
);

367 
	`scsi_lock
(
	`us_to_ho¡
(
us
));

370 ià(
us
->
¤b
 != srb) {

371 
	`scsi_uÆock
(
	`us_to_ho¡
(
us
));

372 
	`usb_¡Ü_dbg
(
us
, "--‚othingo‡bort\n");

373  
FAILED
;

381 
	`£t_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
);

382 ià(!
	`‹¡_b™
(
US_FLIDX_RESETTING
, &
us
->
dæags
)) {

383 
	`£t_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
);

384 
	`usb_¡Ü_¡İ_Œª¥Üt
(
us
);

386 
	`scsi_uÆock
(
	`us_to_ho¡
(
us
));

389 
	`wa™_fÜ_com¶‘iÚ
(&
us
->
nÙify
);

390  
SUCCESS
;

391 
	}
}

395 
	$deviû_»£t
(
scsi_cmnd
 *
¤b
)

397 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
¤b
->
deviû
->
ho¡
);

398 
»suÉ
;

400 
	`usb_¡Ü_dbg
(
us
, "% ÿÎed\n", 
__func__
);

403 
	`mu‹x_lock
(&(
us
->
dev_mu‹x
));

404 
»suÉ
 = 
us
->
	`Œª¥Üt_»£t
(us);

405 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

407  
»suÉ
 < 0 ? 
FAILED
 : 
SUCCESS
;

408 
	}
}

411 
	$bus_»£t
(
scsi_cmnd
 *
¤b
)

413 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
¤b
->
deviû
->
ho¡
);

414 
»suÉ
;

416 
	`usb_¡Ü_dbg
(
us
, "% ÿÎed\n", 
__func__
);

418 
»suÉ
 = 
	`usb_¡Ü_pÜt_»£t
(
us
);

419  
»suÉ
 < 0 ? 
FAILED
 : 
SUCCESS
;

420 
	}
}

425 
	$usb_¡Ü_»pÜt_deviû_»£t
(
us_d©a
 *
us
)

427 
i
;

428 
Scsi_Ho¡
 *
ho¡
 = 
	`us_to_ho¡
(
us
);

430 
	`scsi_»pÜt_deviû_»£t
(
ho¡
, 0, 0);

431 ià(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
) {

432 
i
 = 1; i < 
ho¡
->
max_id
; ++i)

433 
	`scsi_»pÜt_deviû_»£t
(
ho¡
, 0, 
i
);

435 
	}
}

440 
	$usb_¡Ü_»pÜt_bus_»£t
(
us_d©a
 *
us
)

442 
Scsi_Ho¡
 *
ho¡
 = 
	`us_to_ho¡
(
us
);

444 
	`scsi_lock
(
ho¡
);

445 
	`scsi_»pÜt_bus_»£t
(
ho¡
, 0);

446 
	`scsi_uÆock
(
ho¡
);

447 
	}
}

453 
	$wr™e_šfo
(
Scsi_Ho¡
 *
ho¡
, *
bufãr
, 
Ëngth
)

456  
Ëngth
;

457 
	}
}

460 #undeà
SPRINTF


461 
	#SPRINTF
(
¬gs
...è
	`£q_´štf
(
m
, ##‡rgs)

	)

463 
	$show_šfo
 (
£q_fe
 *
m
, 
Scsi_Ho¡
 *
ho¡
)

465 
us_d©a
 *
us
 = 
	`ho¡_to_us
(
ho¡
);

466 cÚ¡ *
¡ršg
;

469 
	`SPRINTF
(" Ho¡ scsi%d: usb-¡Üage\n", 
ho¡
->
ho¡_no
);

472 ià(
us
->
pusb_dev
->
mªuçùu»r
)

473 
¡ršg
 = 
us
->
pusb_dev
->
mªuçùu»r
;

474 ià(
us
->
unusu®_dev
->
v’dÜName
)

475 
¡ršg
 = 
us
->
unusu®_dev
->
v’dÜName
;

477 
¡ršg
 = "Unknown";

478 
	`SPRINTF
(" V’dÜ: %s\n", 
¡ršg
);

479 ià(
us
->
pusb_dev
->
´oduù
)

480 
¡ršg
 = 
us
->
pusb_dev
->
´oduù
;

481 ià(
us
->
unusu®_dev
->
´oduùName
)

482 
¡ršg
 = 
us
->
unusu®_dev
->
´oduùName
;

484 
¡ršg
 = "Unknown";

485 
	`SPRINTF
(" Produù: %s\n", 
¡ršg
);

486 ià(
us
->
pusb_dev
->
£rŸl
)

487 
¡ršg
 = 
us
->
pusb_dev
->
£rŸl
;

489 
¡ršg
 = "None";

490 
	`SPRINTF
("S”ŸÈNumb”: %s\n", 
¡ršg
);

493 
	`SPRINTF
(" PrÙocŞ: %s\n", 
us
->
´ÙocŞ_Çme
);

494 
	`SPRINTF
(" T¿n¥Üt: %s\n", 
us
->
Œª¥Üt_Çme
);

497 
	`SPRINTF
(" Quirks:");

499 
	#US_FLAG
(
Çme
, 
v®ue
) \

500 ià(
us
->
fæags
 & 
v®ue
è
	`£q_´štf
(
m
, " " #Çme);

	)

501 
US_DO_ALL_FLAGS


502 #undeà
US_FLAG


503 
	`£q_putc
(
m
, '\n');

505 
	}
}

512 
ssize_t
 
	$max_£ùÜs_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

514 
scsi_deviû
 *
sdev
 = 
	`to_scsi_deviû
(
dev
);

516  
	`¥rštf
(
buf
, "%u\n", 
	`queue_max_hw_£ùÜs
(
sdev
->
»que¡_queue
));

517 
	}
}

520 
ssize_t
 
	$max_£ùÜs_¡Üe
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
,

521 
size_t
 
couÁ
)

523 
scsi_deviû
 *
sdev
 = 
	`to_scsi_deviû
(
dev
);

524 
ms
;

526 ià(
	`ssÿnf
(
buf
, "%hu", &
ms
) > 0) {

527 
	`blk_queue_max_hw_£ùÜs
(
sdev
->
»que¡_queue
, 
ms
);

528  
couÁ
;

530  -
EINVAL
;

531 
	}
}

532 
DEVICE_ATTR_RW
(
max_£ùÜs
);

534 
deviû_©Œibu‹
 *
	gsysfs_deviû_©Œ_li¡
[] = {

535 &
dev_©Œ_max_£ùÜs
,

536 
NULL
,

543 
scsi_ho¡_‹m¶©e
 
	gusb_¡Ü_‹m¶©e
 = {

545 .
Çme
 = "usb-storage",

546 .
	g´oc_Çme
 = "usb-storage",

547 .
	gshow_šfo
 = 
show_šfo
,

548 .
	gwr™e_šfo
 = 
wr™e_šfo
,

549 .
	gšfo
 = 
ho¡_šfo
,

552 .
	gqueuecommªd
 = 
queuecommªd
,

555 .
	geh_abÜt_hªdËr
 = 
commªd_abÜt
,

556 .
	geh_deviû_»£t_hªdËr
 = 
deviû_»£t
,

557 .
	geh_bus_»£t_hªdËr
 = 
bus_»£t
,

560 .
	gÿn_queue
 = 1,

561 .
	gcmd_³r_lun
 = 1,

564 .
	gthis_id
 = -1,

566 .
	g¦ave_®loc
 = 
¦ave_®loc
,

567 .
	g¦ave_cÚfigu»
 = 
¦ave_cÚfigu»
,

568 .
	grg‘_®loc
 = 
rg‘_®loc
,

571 .
	gsg_bËsize
 = 
SCSI_MAX_SG_CHAIN_SEGMENTS
,

574 .
	gmax_£ùÜs
 = 240,

580 .
	gu£_şu¡”šg
 = 1,

583 .
	gemuÏ‹d
 = 1,

586 .
	gsk_£‰Ë_d–ay
 = 1,

589 .
	gsdev_©Œs
 = 
sysfs_deviû_©Œ_li¡
,

592 .
	gmoduË
 = 
THIS_MODULE


596 
	gusb_¡Ü_£n£_šv®idCDB
[18] = {

598 [2] = 
ILLEGAL_REQUEST
,

602 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_£n£_šv®idCDB
);

	@scsiglue.h

39 #iâdeà
_SCSIGLUE_H_


40 
	#_SCSIGLUE_H_


	)

42 
usb_¡Ü_»pÜt_deviû_»£t
(
us_d©a
 *
us
);

43 
usb_¡Ü_»pÜt_bus_»£t
(
us_d©a
 *
us
);

45 
usb_¡Ü_£n£_šv®idCDB
[18];

46 
scsi_ho¡_‹m¶©e
 
usb_¡Ü_‹m¶©e
;

	@sd.h

1 #iâdeà
_SCSI_DISK_H


2 
	#_SCSI_DISK_H


	)

9 
	#SD_MAJORS
 16

	)

14 
	#SD_TIMEOUT
 (30 * 
HZ
)

	)

15 
	#SD_MOD_TIMEOUT
 (75 * 
HZ
)

	)

20 
	#SD_FLUSH_TIMEOUT_MULTIPLIER
 2

	)

21 
	#SD_WRITE_SAME_TIMEOUT
 (120 * 
HZ
)

	)

26 
	#SD_MAX_RETRIES
 5

	)

27 
	#SD_PASSTHROUGH_RETRIES
 1

	)

28 
	#SD_MAX_MEDIUM_TIMEOUTS
 2

	)

33 
	#SD_BUF_SIZE
 512

	)

39 
	#SD_LAST_BUGGY_SECTORS
 8

	)

42 
	mSD_EXT_CDB_SIZE
 = 32,

43 
	mSD_MEMPOOL_SIZE
 = 2,

47 
	mSD_DEF_XFER_BLOCKS
 = 0xffff,

48 
	mSD_MAX_XFER_BLOCKS
 = 0xffffffff,

49 
	mSD_MAX_WS10_BLOCKS
 = 0xffff,

50 
	mSD_MAX_WS16_BLOCKS
 = 0x7fffff,

54 
	mSD_LBP_FULL
 = 0,

55 
	mSD_LBP_UNMAP
,

56 
	mSD_LBP_WS16
,

57 
	mSD_LBP_WS10
,

58 
	mSD_LBP_ZERO
,

59 
	mSD_LBP_DISABLE
,

62 
	sscsi_disk
 {

63 
scsi_driv”
 *
	mdriv”
;

64 
scsi_deviû
 *
	mdeviû
;

65 
deviû
 
	mdev
;

66 
g’disk
 *
	mdisk
;

67 
©omic_t
 
	mİ’”s
;

68 
£ùÜ_t
 
	mÿ·c™y
;

69 
u32
 
	mmax_xãr_blocks
;

70 
u32
 
	mmax_ws_blocks
;

71 
u32
 
	mmax_unm­_blocks
;

72 
u32
 
	munm­_g¿nuÏr™y
;

73 
u32
 
	munm­_®ignm’t
;

74 
u32
 
	mšdex
;

75 
	mphysiÿl_block_size
;

76 
	mmax_medium_acûss_timeouts
;

77 
	mmedium_acûss_timed_out
;

78 
u8
 
	mmedŸ_´e£Á
;

79 
u8
 
	mwr™e_´Ù
;

80 
u8
 
	m´ÙeùiÚ_ty³
;

81 
u8
 
	m´ovisiÚšg_mode
;

82 
	mATO
 : 1;

83 
	mÿche_ov”ride
 : 1;

84 
	mWCE
 : 1;

85 
	mRCD
 : 1;

86 
	mDPOFUA
 : 1;

87 
	mfœ¡_sÿn
 : 1;

88 
	mlbpme
 : 1;

89 
	mlb´z
 : 1;

90 
	mlbpu
 : 1;

91 
	mlbpws
 : 1;

92 
	mlbpws10
 : 1;

93 
	mlbpvpd
 : 1;

94 
	mws10
 : 1;

95 
	mws16
 : 1;

97 
	#to_scsi_disk
(
obj
è
	`cÚš”_of
(obj,
scsi_disk
,
dev
)

	)

99 
šlše
 
scsi_disk
 *
	$scsi_disk
(
g’disk
 *
disk
)

101  
	`cÚš”_of
(
disk
->
´iv©e_d©a
, 
scsi_disk
, 
driv”
);

102 
	}
}

104 
	#sd_´štk
(
´efix
, 
sdsk
, 
fmt
, 
a
...) \

105 (
sdsk
)->
disk
 ? \

106 
	`sdev_´efix_´štk
(
´efix
, (
sdsk
)->
deviû
, \

107 (
sdsk
)->
disk
->
disk_Çme
, 
fmt
, ##
a
) : \

108 
	`sdev_´štk
(
´efix
, (
sdsk
)->
deviû
, 
fmt
, ##
a
)

	)

110 
	#sd_fœ¡_´štk
(
´efix
, 
sdsk
, 
fmt
, 
a
...) \

112 ià((
sdkp
)->
fœ¡_sÿn
) \

113 
	`sd_´štk
(
´efix
, 
sdsk
, 
fmt
, ##
a
); \

114 } 0)

	)

116 
šlše
 
	$scsi_medium_acûss_commªd
(
scsi_cmnd
 *
scmd
)

118 
scmd
->
cmnd
[0]) {

119 
READ_6
:

120 
READ_10
:

121 
READ_12
:

122 
READ_16
:

123 
SYNCHRONIZE_CACHE
:

124 
VERIFY
:

125 
VERIFY_12
:

126 
VERIFY_16
:

127 
WRITE_6
:

128 
WRITE_10
:

129 
WRITE_12
:

130 
WRITE_16
:

131 
WRITE_SAME
:

132 
WRITE_SAME_16
:

133 
UNMAP
:

135 
VARIABLE_LENGTH_CMD
:

136 
scmd
->
cmnd
[9]) {

137 
READ_32
:

138 
VERIFY_32
:

139 
WRITE_32
:

140 
WRITE_SAME_32
:

146 
	}
}

162 
	esd_dif_rg‘_´ÙeùiÚ_ty³s
 {

163 
	mSD_DIF_TYPE0_PROTECTION
 = 0x0,

164 
	mSD_DIF_TYPE1_PROTECTION
 = 0x1,

165 
	mSD_DIF_TYPE2_PROTECTION
 = 0x2,

166 
	mSD_DIF_TYPE3_PROTECTION
 = 0x3,

173 
šlše
 
	$sd_´Ù_İ
(
boŞ
 
wr™e
, boŞ 
dix
, boŞ 
dif
)

176 cÚ¡ 
İs
[] = {

177 
SCSI_PROT_NORMAL
,

178 
SCSI_PROT_READ_STRIP
,

179 
SCSI_PROT_READ_INSERT
,

180 
SCSI_PROT_READ_PASS
,

181 
SCSI_PROT_NORMAL
,

182 
SCSI_PROT_WRITE_INSERT
,

183 
SCSI_PROT_WRITE_STRIP
,

184 
SCSI_PROT_WRITE_PASS
,

187  
İs
[
wr™e
 << 2 | 
dix
 << 1 | 
dif
];

188 
	}
}

194 
šlše
 
	$sd_´Ù_æag_mask
(
´Ù_İ
)

196 cÚ¡ 
æag_mask
[] = {

197 [
SCSI_PROT_NORMAL
] = 0,

199 [
SCSI_PROT_READ_STRIP
] = 
SCSI_PROT_TRANSFER_PI
 |

200 
SCSI_PROT_GUARD_CHECK
 |

201 
SCSI_PROT_REF_CHECK
 |

202 
SCSI_PROT_REF_INCREMENT
,

204 [
SCSI_PROT_READ_INSERT
] = 
SCSI_PROT_REF_INCREMENT
 |

205 
SCSI_PROT_IP_CHECKSUM
,

207 [
SCSI_PROT_READ_PASS
] = 
SCSI_PROT_TRANSFER_PI
 |

208 
SCSI_PROT_GUARD_CHECK
 |

209 
SCSI_PROT_REF_CHECK
 |

210 
SCSI_PROT_REF_INCREMENT
 |

211 
SCSI_PROT_IP_CHECKSUM
,

213 [
SCSI_PROT_WRITE_INSERT
] = 
SCSI_PROT_TRANSFER_PI
 |

214 
SCSI_PROT_REF_INCREMENT
,

216 [
SCSI_PROT_WRITE_STRIP
] = 
SCSI_PROT_GUARD_CHECK
 |

217 
SCSI_PROT_REF_CHECK
 |

218 
SCSI_PROT_REF_INCREMENT
 |

219 
SCSI_PROT_IP_CHECKSUM
,

221 [
SCSI_PROT_WRITE_PASS
] = 
SCSI_PROT_TRANSFER_PI
 |

222 
SCSI_PROT_GUARD_CHECK
 |

223 
SCSI_PROT_REF_CHECK
 |

224 
SCSI_PROT_REF_INCREMENT
 |

225 
SCSI_PROT_IP_CHECKSUM
,

228  
æag_mask
[
´Ù_İ
];

229 
	}
}

234 
	ssd_dif_tu¶e
 {

235 
__be16
 
	mgu¬d_g
;

236 
__be16
 
	m­p_g
;

237 
__be32
 
	m»f_g
;

240 #ifdeà
CONFIG_BLK_DEV_INTEGRITY


242 
sd_dif_cÚfig_ho¡
(
scsi_disk
 *);

243 
sd_dif_´•¬e
(
scsi_cmnd
 *
scmd
);

244 
sd_dif_com¶‘e
(
scsi_cmnd
 *, );

248 
šlše
 
	$sd_dif_cÚfig_ho¡
(
scsi_disk
 *
disk
)

250 
	}
}

251 
šlše
 
	$sd_dif_´•¬e
(
scsi_cmnd
 *
scmd
)

254 
	}
}

255 
šlše
 
	$sd_dif_com¶‘e
(
scsi_cmnd
 *
cmd
, 
a
)

257 
	}
}

	@transport.c

1 
	~<lšux/sched.h
>

2 
	~<lšux/gå.h
>

3 
	~<lšux/”ºo.h
>

4 
	~<lšux/expÜt.h
>

6 
	~<lšux/usb/quœks.h
>

8 
	~<scsi/scsi.h
>

9 
	~<scsi/scsi_eh.h
>

10 
	~<scsi/scsi_deviû.h
>

12 
	~"usb.h
"

13 
	~"Œª¥Üt.h
"

14 
	~"´ÙocŞ.h
"

15 
	~"scsiglue.h
"

16 
	~"debug.h
"

18 
	~<lšux/blkdev.h
>

19 
	~"sd.h
"

23 
	$usb_¡Ü_blockšg_com¶‘iÚ
(
urb
 *urb)

25 
com¶‘iÚ
 *
urb_dÚe_±r
 = 
urb
->
cÚ‹xt
;

26 
	`com¶‘e
(
urb_dÚe_±r
);

27 
	}
}

29 
	$usb_¡Ü_msg_commÚ
(
us_d©a
 *
us
, 
timeout
)

31 
com¶‘iÚ
 
urb_dÚe
;

32 
tim–eá
;

33 
¡©us
;

36 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
))

37  -
EIO
;

40 
	`š™_com¶‘iÚ
(&
urb_dÚe
);

43 
us
->
cu¼’t_urb
->
cÚ‹xt
 = &
urb_dÚe
;

44 
us
->
cu¼’t_urb
->
Œªsãr_æags
 = 0;

50 ià(
us
->
cu¼’t_urb
->
Œªsãr_bufãr
 =ğus->
iobuf
)

51 
us
->
cu¼’t_urb
->
Œªsãr_æags
 |ğ
URB_NO_TRANSFER_DMA_MAP
;

52 
us
->
cu¼’t_urb
->
Œªsãr_dma
 = us->
iobuf_dma
;

55 
¡©us
 = 
	`usb_subm™_urb
(
us
->
cu¼’t_urb
, 
GFP_NOIO
);

56 ià(
¡©us
)

57  
¡©us
;

59 
	`£t_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
);

62 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
)) {

64 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
))

66 
	`usb_¡Ü_dbg
(
us
, "--Cancellinghe URB\n");

67 
	`usb_uÆšk_urb
(
us
->
cu¼’t_urb
);

72 
tim–eá
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(

73 &
urb_dÚe
, 
timeout
 ? : 
MAX_SCHEDULE_TIMEOUT
);

74 
	`ş—r_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
);

76 ià(
tim–eá
 <= 0) {

77 
	`usb_¡Ü_dbg
(
us
, "% -- CªûÎšg URB\n", 
tim–eá
 == 0 ? "Timeout" : "Signal");

78 
	`usb_kl_urb
(
us
->
cu¼’t_urb
);

82  
us
->
cu¼’t_urb
->
¡©us
;

83 
	}
}

85 
	$usb_¡Ü_cÚŒŞ_msg
(
us_d©a
 *
us
, 
pe
,

86 
u8
 
»que¡
, u8 
»que¡ty³
, 
u16
 
v®ue
,

87 
u16
 
šdex
, *
d©a
, u16 
size
, 
timeout
)

89 
¡©us
;

91 
	`usb_¡Ü_dbg
(
us
, "rq=%02x„qtype=%02x value=%04x index=%02x†en=%u\n",

92 
»que¡
, 
»que¡ty³
, 
v®ue
, 
šdex
, 
size
);

96 
us
->
ü
->
bReque¡Ty³
 = 
»que¡ty³
;

97 
us
->
ü
->
bReque¡
 = 
»que¡
;

98 
us
->
ü
->
wV®ue
 = 
	`ıu_to_Ë16
(
v®ue
);

99 
us
->
ü
->
wIndex
 = 
	`ıu_to_Ë16
(
šdex
);

100 
us
->
ü
->
wL’gth
 = 
	`ıu_to_Ë16
(
size
);

103 
	`usb_fl_cÚŒŞ_urb
(
us
->
cu¼’t_urb
, us->
pusb_dev
,

104 
pe
, (*è
us
->
ü
,

105 
d©a
, 
size
, 
usb_¡Ü_blockšg_com¶‘iÚ
, 
NULL
);

106 
¡©us
 = 
	`usb_¡Ü_msg_commÚ
(
us
, 
timeout
);

109 ià(
¡©us
 == 0)

110 
¡©us
 = 
us
->
cu¼’t_urb
->
aùu®_Ëngth
;

111  
¡©us
;

112 
	}
}

117 
	$usb_¡Ü_Bulk_max_lun
(
us_d©a
 *
us
)

119 
»suÉ
;

122 
us
->
iobuf
[0] = 0;

123 
»suÉ
 = 
	`usb_¡Ü_cÚŒŞ_msg
(
us
, us->
»cv_ù¾_pe
,
US_BULK_GET_MAX_LUN
,

124 
USB_DIR_IN
 | 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
,

125 0, 
us
->
iâum
, us->
iobuf
, 1, 10*
HZ
);

126 
	`usb_¡Ü_dbg
(
us
, "GetMaxLUN command„esult is %d, data is %d\n",

127 
»suÉ
, 
us
->
iobuf
[0]);

133 ià(
»suÉ
 > 0) {

134 ià(
us
->
iobuf
[0] < 16) {

135  
us
->
iobuf
[0];

137 
	`dev_šfo
(&
us
->
pusb_štf
->
dev
,

138 "Max LUN %d i nÙ v®id, usšg 0 in¡—d", 
us
->
iobuf
[0]);

151 
	}
}

158 
	$Ï¡_£ùÜ_hacks
(
us_d©a
 *
us
, 
scsi_cmnd
 *
¤b
)

160 
g’disk
 *
disk
;

161 
scsi_disk
 *
sdkp
;

162 
u32
 
£ùÜ
;

165 
»cÜd_nÙ_found
[18] = {

167 [2] = 
MEDIUM_ERROR
,

175 ià(!
us
->
u£_Ï¡_£ùÜ_hacks
)

178 ià(
¤b
->
cmnd
[0] !ğ
READ_10
 && srb->cmnd[0] !ğ
WRITE_10
)

179 
dÚe
;

181 
£ùÜ
 = (
¤b
->
cmnd
[2] << 24) | (srb->cmnd[3] << 16) |

182 (
¤b
->
cmnd
[4] << 8) | (srb->cmnd[5]);

183 
disk
 = 
¤b
->
»que¡
->
rq_disk
;

184 ià(!
disk
)

185 
dÚe
;

186 
sdkp
 = 
	`scsi_disk
(
disk
);

187 ià(!
sdkp
)

188 
dÚe
;

189 ià(
£ùÜ
 + 1 !ğ
sdkp
->
ÿ·c™y
)

190 
dÚe
;

192 ià(
¤b
->
»suÉ
 =ğ
SAM_STAT_GOOD
 && 
	`scsi_g‘_»sid
(srb) == 0) {

193 
us
->
u£_Ï¡_£ùÜ_hacks
 = 0;

202 ià(++
us
->
Ï¡_£ùÜ_»Œ›s
 < 3)

204 
¤b
->
»suÉ
 = 
SAM_STAT_CHECK_CONDITION
;

205 
	`memıy
(
¤b
->
£n£_bufãr
, 
»cÜd_nÙ_found
,

206 (
»cÜd_nÙ_found
));

208 
dÚe
:

213 ià(
¤b
->
cmnd
[0] !ğ
TEST_UNIT_READY
)

214 
us
->
Ï¡_£ùÜ_»Œ›s
 = 0;

215 
	}
}

218 
	$usb_¡Ü_švoke_Œª¥Üt
(
scsi_cmnd
 *
¤b
, 
us_d©a
 *
us
)

220 
Ãed_auto_£n£
;

221 
»suÉ
;

224 
	`scsi_£t_»sid
(
¤b
, 0);

225 
»suÉ
 = 
us
->
	`Œª¥Üt
(
¤b
, us);

230 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

231 
	`usb_¡Ü_dbg
(
us
, "-- command was‡borted\b");

232 
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

233 
HªdË_E¼Üs
;

236 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_ERROR
) {

237 
	`usb_¡Ü_dbg
(
us
, "--Transport indicatesƒrror,„esetting \n");

238 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

239 
HªdË_E¼Üs
;

243 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_NO_SENSE
) {

244 
¤b
->
»suÉ
 = 
SAM_STAT_CHECK_CONDITION
;

245 
	`Ï¡_£ùÜ_hacks
(
us
, 
¤b
);

248 
¤b
->
»suÉ
 = 
SAM_STAT_GOOD
;

250 
Ãed_auto_£n£
 = 0;

252 ià((
us
->
´ÙocŞ
 =ğ
USB_PR_CB
 || us->´ÙocŞ =ğ
USB_PR_DPCM_USB
) &&

253 
¤b
->
sc_d©a_dœeùiÚ
 !ğ
DMA_FROM_DEVICE
) {

254 
	`usb_¡Ü_dbg
(
us
, "--CBransport device„equiring‡uto-sense\n");

255 
Ãed_auto_£n£
 = 1;

261 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_FAILED
) {

262 
	`usb_¡Ü_dbg
(
us
, "--ransport indicates command failure\n");

263 
Ãed_auto_£n£
 = 1;

269 ià(
	`uÆik–y
((
¤b
->
cmnd
[0] =ğ
ATA_16
 || srb->cmnd[0] =ğ
ATA_12
) &&

270 
»suÉ
 =ğ
USB_STOR_TRANSPORT_GOOD
 &&

271 !(
us
->
fæags
 & 
US_FL_SANE_SENSE
) &&

272 !(
us
->
fæags
 & 
US_FL_BAD_SENSE
) &&

273 !(
¤b
->
cmnd
[2] & 0x20))) {

274 
	`usb_¡Ü_dbg
(
us
, "--SAT supported, increasing‡uto-sens\n");

275 
us
->
fæags
 |ğ
US_FL_SANE_SENSE
;

279 ià((
	`scsi_g‘_»sid
(
¤b
è> 0è&& !((¤b->
cmnd
[0] =ğ
REQUEST_SENSE
) ||

280 (
¤b
->
cmnd
[0] =ğ
INQUIRY
è|| (¤b->cmnd[0] =ğ
MODE_SENSE
) ||

281 (
¤b
->
cmnd
[0] =ğ
LOG_SENSE
è|| (¤b->cmnd[0] =ğ
MODE_SENSE_10
)))

283 
	`usb_¡Ü_dbg
(
us
, "--unexpectedly shortransfer\n");

286 ià(
Ãed_auto_£n£
)

288 
‹mp_»suÉ
;

289 
scsi_eh_§ve
 
£s
;

290 
£n£_size
 = 
US_SENSE_SIZE
;

291 
scsi_£n£_hdr
 
sshdr
;

292 cÚ¡ 
u8
 *
scdd
;

293 
u8
 
fm_i
;

296 ià(
us
->
fæags
 & 
US_FL_SANE_SENSE
)

297 
£n£_size
 = ~0;

298 
R‘ry_S’£
:

299 
	`usb_¡Ü_dbg
(
us
, "Issuing‡uto-REQUEST_SENSE\n");

300 
	`scsi_eh_´•_cmnd
(
¤b
, &
£s
, 
NULL
, 0, 
£n£_size
);

302 ià(
us
->
subşass
 =ğ
USB_SC_RBC
 || us->subşas =ğ
USB_SC_SCSI
 ||

303 
us
->
subşass
 =ğ
USB_SC_CYP_ATACB
)

304 
¤b
->
cmd_Ën
 = 6;

306 
¤b
->
cmd_Ën
 = 12;

309 
	`scsi_£t_»sid
(
¤b
, 0);

310 
‹mp_»suÉ
 = 
us
->
	`Œª¥Üt
(us->
¤b
, us);

313 
	`scsi_eh_»¡Üe_cmnd
(
¤b
, &
£s
);

315 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

316 
	`usb_¡Ü_dbg
(
us
, "--auto-sense‡borted\n");

317 
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

319 ià(
£n£_size
 !ğ
US_SENSE_SIZE
) {

320 
us
->
fæags
 &ğ~
US_FL_SANE_SENSE
;

321 
us
->
fæags
 |ğ
US_FL_BAD_SENSE
;

323 
HªdË_E¼Üs
;

329 ià(
‹mp_»suÉ
 =ğ
USB_STOR_TRANSPORT_FAILED
 &&

330 
£n£_size
 !ğ
US_SENSE_SIZE
) {

331 
	`usb_¡Ü_dbg
(
us
, "--auto-sense failure,„etry small sense \n");

332 
£n£_size
 = 
US_SENSE_SIZE
;

333 
us
->
fæags
 &ğ~
US_FL_SANE_SENSE
;

334 
us
->
fæags
 |ğ
US_FL_BAD_SENSE
;

335 
R‘ry_S’£
;

339 ià(
‹mp_»suÉ
 !ğ
USB_STOR_TRANSPORT_GOOD
) {

340 
	`usb_¡Ü_dbg
(
us
, "--auto-sense failure\n");

344 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

345 ià(!(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
))

346 
HªdË_E¼Üs
;

353 ià(
¤b
->
£n£_bufãr
[7] > (
US_SENSE_SIZE
 - 8) &&

354 !(
us
->
fæags
 & 
US_FL_SANE_SENSE
) &&

355 !(
us
->
fæags
 & 
US_FL_BAD_SENSE
) &&

356 (
¤b
->
£n£_bufãr
[0] & 0x7C) == 0x70) {

357 
	`usb_¡Ü_dbg
(
us
,"--Sense dataruncatedo %i from %i\n",

358 
US_SENSE_SIZE
, 
¤b
->
£n£_bufãr
[7] + 8);

359 
¤b
->
£n£_bufãr
[7] = (
US_SENSE_SIZE
 - 8);

361 
	`scsi_nÜm®ize_£n£
(
¤b
->
£n£_bufãr
, 
SCSI_SENSE_BUFFERSIZE
,

362 &
sshdr
);

363 
	`usb_¡Ü_dbg
(
us
, "--ResuÉ from‡uto-£n£ i %d\n",
‹mp_»suÉ
);

364 
	`usb_¡Ü_dbg
(
us
,"--code: 0x%x, key: 0x%x, ASC: 0x%x, ASCQ: 0x%x",

365 
sshdr
.
»¥Ú£_code
, sshdr.
£n£_key
,

366 
sshdr
.
asc
, sshdr.
ascq
);

367 #ifdeà
CONFIG_USB_STORAGE_DEBUG


368 
	`usb_¡Ü_show_£n£
(
us
, 
sshdr
.
£n£_key
, sshdr.
asc
, sshdr.
ascq
);

371 
¤b
->
»suÉ
 = 
SAM_STAT_CHECK_CONDITION
;

372 
scdd
 = 
	`scsi_£n£_desc_fšd
(
¤b
->
£n£_bufãr
,

373 
SCSI_SENSE_BUFFERSIZE
, 4);

374 
fm_i
 = (
scdd
 ? scdd[3] : 
¤b
->
£n£_bufãr
[2]) & 0xA0;

378 ià(
sshdr
.
£n£_key
 =ğ0 && sshdr.
asc
 =ğ0 && sshdr.
ascq
 == 0 &&

379 
fm_i
 == 0) {

380 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_GOOD
) {

381 
¤b
->
»suÉ
 = 
SAM_STAT_GOOD
;

382 
¤b
->
£n£_bufãr
[0] = 0x0;

388 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

389 ià((
sshdr
.
»¥Ú£_code
 & 0x72) == 0x72)

390 
¤b
->
£n£_bufãr
[1] = 
HARDWARE_ERROR
;

392 
¤b
->
£n£_bufãr
[2] = 
HARDWARE_ERROR
;

403 ià(
	`uÆik–y
((
us
->
fæags
 & 
US_FL_INITIAL_READ10
) &&

404 
¤b
->
cmnd
[0] =ğ
READ_10
))

406 ià(
¤b
->
»suÉ
 =ğ
SAM_STAT_GOOD
) {

407 
	`£t_b™
(
US_FLIDX_READ10_WORKED
, &
us
->
dæags
);

408 } ià(
	`‹¡_b™
(
US_FLIDX_READ10_WORKED
, &
us
->
dæags
)) {

409 
	`ş—r_b™
(
US_FLIDX_READ10_WORKED
, &
us
->
dæags
);

410 
	`£t_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
);

416 ià(
	`‹¡_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
))

418 
	`ş—r_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
);

419 
¤b
->
»suÉ
 = 
DID_IMM_RETRY
 << 16;

420 
¤b
->
£n£_bufãr
[0] = 0;

424 ià((
¤b
->
»suÉ
 =ğ
SAM_STAT_GOOD
 || srb->
£n£_bufãr
[2] == 0) &&

425 
	`scsi_bufæ’
(
¤b
è- 
	`scsi_g‘_»sid
(¤bè< srb->
und”æow
)

426 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

427 
	`Ï¡_£ùÜ_hacks
(
us
, 
¤b
);

433 
HªdË_E¼Üs
:

436 
	`scsi_lock
(
	`us_to_ho¡
(
us
));

437 
	`£t_b™
(
US_FLIDX_RESETTING
, &
us
->
dæags
);

438 
	`ş—r_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
);

439 
	`scsi_uÆock
(
	`us_to_ho¡
(
us
));

443 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

444 
»suÉ
 = 
	`usb_¡Ü_pÜt_»£t
(
us
);

445 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

447 ià(
»suÉ
 < 0)

449 
	`scsi_lock
(
	`us_to_ho¡
(
us
));

450 
	`usb_¡Ü_»pÜt_deviû_»£t
(
us
);

451 
	`scsi_uÆock
(
	`us_to_ho¡
(
us
));

452 
us
->
	`Œª¥Üt_»£t
(us);

454 
	`ş—r_b™
(
US_FLIDX_RESETTING
, &
us
->
dæags
);

455 
	`Ï¡_£ùÜ_hacks
(
us
, 
¤b
);

456 
	}
}

462 
	$usb_¡Ü_ş—r_h®t
(
us_d©a
 *
us
, 
pe
)

464 
»suÉ
;

465 
’dp
 = 
	`usb_p“ndpošt
(
pe
);

467 ià(
	`usb_peš
 (
pe
))

468 
’dp
 |ğ
USB_DIR_IN
;

470 
»suÉ
 = 
	`usb_¡Ü_cÚŒŞ_msg
(
us
, us->
£nd_ù¾_pe
,

471 
USB_REQ_CLEAR_FEATURE
, 
USB_RECIP_ENDPOINT
,

472 
USB_ENDPOINT_HALT
, 
’dp
, 
NULL
, 0, 3*
HZ
);

473 ià(
»suÉ
 >= 0)

474 
	`usb_»£t_’dpošt
(
us
->
pusb_dev
, 
’dp
);

476 
	`usb_¡Ü_dbg
(
us
, "»suÉ = %d\n", 
»suÉ
);

477  
»suÉ
;

478 
	}
}

489 
	$usb_¡Ü_»£t_commÚ
(
us_d©a
 *
us
, 
u8
 
»que¡
, u8 
»que¡ty³
,

490 
u16
 
v®ue
, u16 
šdex
, *
d©a
, u16 
size
)

492 
»suÉ
;

493 
»suÉ2
;

495 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

496 
	`usb_¡Ü_dbg
(
us
, "No„eset during disconnect\n");

497  -
EIO
;

500 
»suÉ
 = 
	`usb_¡Ü_cÚŒŞ_msg
(
us
, us->
£nd_ù¾_pe
, 
»que¡
,

501 
»que¡ty³
, 
v®ue
, 
šdex
, 
d©a
, 
size
, 5*
HZ
);

502 ià(
»suÉ
 < 0) {

503 
	`usb_¡Ü_dbg
(
us
, "Soá„e£ˆçed: %d\n", 
»suÉ
);

504  
»suÉ
;

509 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
us
->
d–ay_wa™
,

510 
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
), 
HZ
*6);

511 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

512 
	`usb_¡Ü_dbg
(
us
, "Reset interrupted by disconnect\n");

513  -
EIO
;

516 
	`usb_¡Ü_dbg
(
us
, "Soft„eset: clearing bulk-inƒndpoint halt \n");

517 
»suÉ
 = 
	`usb_¡Ü_ş—r_h®t
(
us
, us->
»cv_bulk_pe
);

519 
	`usb_¡Ü_dbg
(
us
, "Soft„eset: Clearing bulk-outƒndPoint half \n");

520 
»suÉ2
 = 
	`usb_¡Ü_ş—r_h®t
(
us
, us->
£nd_bulk_pe
);

522 ià(
»suÉ
 >= 0)

523 
»suÉ
 = 
»suÉ2
;

524 ià(
»suÉ
 < 0)

525 
	`usb_¡Ü_dbg
(
us
, "Soft„eset failed\n");

527 
	`usb_¡Ü_dbg
(
us
, "Soft„eset done \n");

528  
»suÉ
;

529 
	}
}

531 
	$usb_¡Ü_Bulk_»£t
(
us_d©a
 *
us
)

533  
	`usb_¡Ü_»£t_commÚ
(
us
, 
US_BULK_RESET_REQUEST
,

534 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
,

535 0, 
us
->
iâum
, 
NULL
, 0);

536 
	}
}

543 
	$š‹½»t_urb_»suÉ
(
us_d©a
 *
us
, 
pe
,

544 
Ëngth
, 
»suÉ
, 
·¹Ÿl
)

546 
	`usb_¡Ü_dbg
(
us
, "Status code %d;ransferred %u/%u\n",

547 
»suÉ
, 
·¹Ÿl
, 
Ëngth
);

548 
»suÉ
)

552 ià(
·¹Ÿl
 !ğ
Ëngth
) {

553 
	`usb_¡Ü_dbg
(
us
, "-- shortransfer\n");

554  
USB_STOR_XFER_SHORT
;

556 
	`usb_¡Ü_dbg
(
us
, "--ransfer complete\n");

557  
USB_STOR_XFER_GOOD
;

560 -
EPIPE
:

561 ià(
	`usb_pecÚŒŞ
(
pe
)) {

562 
	`usb_¡Ü_dbg
(
us
, "-- stall on control…ipe\n");

563  
USB_STOR_XFER_STALLED
;

566 
	`usb_¡Ü_dbg
(
us
, "CË¬šgƒndpošˆh®ˆfÜ…0x%x\n", 
pe
);

567 ià(
	`usb_¡Ü_ş—r_h®t
(
us
, 
pe
) > 0)

568  
USB_STOR_XFER_ERROR
;

569  
USB_STOR_XFER_STALLED
;

572 -
EOVERFLOW
:

573 
	`usb_¡Ü_dbg
(
us
, "--babble\n");

574  
USB_STOR_XFER_LONG
;

578 -
ECONNRESET
:

579 
	`usb_¡Ü_dbg
(
us
, "-- Transfer cancelled\n");

580  
USB_STOR_XFER_ERROR
;

583 -
EREMOTEIO
:

584 
	`usb_¡Ü_dbg
(
us
, "--Short„eadransfer\n");

585  
USB_STOR_XFER_SHORT
;

588 -
EIO
:

589 
	`usb_¡Ü_dbg
(
us
, "--Abort or disconnect in…rogress\n");

590  
USB_STOR_XFER_ERROR
;

594 
	`usb_¡Ü_dbg
(
us
, "--Unknownƒrrors\n");

595  
USB_STOR_XFER_ERROR
;

597 
	}
}

606 
	$usb_¡Ü_bulk_Œªsãr_buf
(
us_d©a
 *
us
, 
pe
,

607 *
buf
, 
Ëngth
, *
aù_Ën
)

609 
»suÉ
;

611 
	`usb_¡Ü_dbg
(
us
, "xã¸%u by‹s\n", 
Ëngth
);

614 
	`usb_fl_bulk_urb
(
us
->
cu¼’t_urb
, us->
pusb_dev
, 
pe
, 
buf
, 
Ëngth
,

615 
usb_¡Ü_blockšg_com¶‘iÚ
, 
NULL
);

616 
»suÉ
 = 
	`usb_¡Ü_msg_commÚ
(
us
, 0);

619 ià(
aù_Ën
)

620 *
aù_Ën
 = 
us
->
cu¼’t_urb
->
aùu®_Ëngth
;

621  
	`š‹½»t_urb_»suÉ
(
us
, 
pe
, 
Ëngth
, 
»suÉ
,

622 
us
->
cu¼’t_urb
->
aùu®_Ëngth
);

623 
	}
}

628 
	$usb_¡Ü_bulk_Œªsãr_sgli¡
(
us_d©a
 *
us
, 
pe
,

629 
sÿ‰”li¡
 *
sg
, 
num_sg
, 
Ëngth
,

630 *
aù_Ën
)

632 
»suÉ
;

635 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
))

636  
USB_STOR_XFER_ERROR
;

638 
	`usb_¡Ü_dbg
(
us
, "xã¸%u by‹s, %dƒÁr›s\n", 
Ëngth
, 
num_sg
);

639 
»suÉ
 = 
	`usb_sg_š™
(&
us
->
cu¼’t_sg
, us->
pusb_dev
, 
pe
, 0,

640 
sg
, 
num_sg
, 
Ëngth
, 
GFP_NOIO
);

641 ià(
»suÉ
) {

642 
	`usb_¡Ü_dbg
(
us
, "usb_sg_š™„‘uºed %d\n", 
»suÉ
);

643  
USB_STOR_XFER_ERROR
;

648 
	`£t_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
);

651 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
)) {

653 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
)) {

654 
	`usb_¡Ü_dbg
(
us
, "-- cancelling sg„equest \n");

655 
	`usb_sg_ÿnûl
(&
us
->
cu¼’t_sg
);

659 
	`usb_sg_wa™
(&
us
->
cu¼’t_sg
);

660 
	`ş—r_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
);

661 
»suÉ
 = 
us
->
cu¼’t_sg
.
¡©us
;

662 ià(
aù_Ën
)

663 *
aù_Ën
 = 
us
->
cu¼’t_sg
.
by‹s
;

664  
	`š‹½»t_urb_»suÉ
(
us
, 
pe
, 
Ëngth
, 
»suÉ
,

665 
us
->
cu¼’t_sg
.
by‹s
);

666 
	}
}

672 
	$usb_¡Ü_bulk_¤b
(
us_d©a
* 
us
, 
pe
,

673 
scsi_cmnd
* 
¤b
)

675 
·¹Ÿl
;

676 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_sgli¡
(
us
, 
pe
, 
	`scsi_sgli¡
(
¤b
),

677 
	`scsi_sg_couÁ
(
¤b
), 
	`scsi_bufæ’
(srb),

678 &
·¹Ÿl
);

680 
	`scsi_£t_»sid
(
¤b
, 
	`scsi_bufæ’
(¤bè- 
·¹Ÿl
);

681  
»suÉ
;

682 
	}
}

684 
	$usb_¡Ü_Bulk_Œª¥Üt
(
scsi_cmnd
 *
¤b
, 
us_d©a
 *
us
)

686 
bulk_cb_w¿p
 *
bcb
 = (bulk_cb_w¿°*è
us
->
iobuf
;

687 
bulk_cs_w¿p
 *
bcs
 = (bulk_cs_w¿°*è
us
->
iobuf
;

688 
Œªsãr_Ëngth
 = 
	`scsi_bufæ’
(
¤b
);

689 
»sidue
;

690 
»suÉ
;

691 
çke_£n£
 = 0;

692 
cswËn
;

693 
cbwËn
 = 
US_BULK_CB_WRAP_LEN
;

696 ià(
	`uÆik–y
(
us
->
fæags
 & 
US_FL_BULK32
)) {

697 
cbwËn
 = 32;

698 
us
->
iobuf
[31] = 0;

702 
bcb
->
SigÇtu»
 = 
	`ıu_to_Ë32
(
US_BULK_CB_SIGN
);

703 
bcb
->
D©aT¿nsãrL’gth
 = 
	`ıu_to_Ë32
(
Œªsãr_Ëngth
);

704 
bcb
->
FÏgs
 = 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 ?

705 
US_BULK_FLAG_IN
 : 0;

706 
bcb
->
Tag
 = ++
us
->
g
;

707 
bcb
->
Lun
 = 
¤b
->
deviû
->
lun
;

708 ià(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
)

709 
bcb
->
Lun
 |ğ
¤b
->
deviû
->
id
 << 4;

710 
bcb
->
L’gth
 = 
¤b
->
cmd_Ën
;

713 
	`mem£t
(
bcb
->
CDB
, 0, (bcb->CDB));

714 
	`memıy
(
bcb
->
CDB
, 
¤b
->
cmnd
, bcb->
L’gth
);

717 
	`usb_¡Ü_dbg
(
us
, "Bulk command S 0x%x T 0x%x L %d F %d Trg %d LUN %d CL %d\n",

718 
	`Ë32_to_ıu
(
bcb
->
SigÇtu»
), bcb->
Tag
,

719 
	`Ë32_to_ıu
(
bcb
->
D©aT¿nsãrL’gth
), bcb->
FÏgs
,

720 (
bcb
->
Lun
 >> 4), (bcb->LuÀ& 0x0F), bcb->
L’gth
);

722 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
£nd_bulk_pe
,

723 
bcb
, 
cbwËn
, 
NULL
);

724 
	`usb_¡Ü_dbg
(
us
, "Bulk commªd¿nsã¸»suÉ=%d\n", 
»suÉ
);

725 ià(
»suÉ
 !ğ
USB_STOR_XFER_GOOD
)

726  
USB_STOR_TRANSPORT_ERROR
;

729 ià(
	`uÆik–y
(
us
->
fæags
 & 
US_FL_GO_SLOW
))

730 
	`ud–ay
(125);

732 ià(
Œªsãr_Ëngth
) {

733 
pe
 = 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 ?

734 
us
->
»cv_bulk_pe
 : us->
£nd_bulk_pe
;

735 
»suÉ
 = 
	`usb_¡Ü_bulk_¤b
(
us
, 
pe
, 
¤b
);

736 
	`usb_¡Ü_dbg
(
us
, "Bulk d©¨Œªsã¸»suÉ 0x%x\n", 
»suÉ
);

737 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_ERROR
)

738  
USB_STOR_TRANSPORT_ERROR
;

744 ià(
»suÉ
 =ğ
USB_STOR_XFER_LONG
)

745 
çke_£n£
 = 1;

751 ià(
»suÉ
 =ğ
USB_STOR_XFER_SHORT
 &&

752 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 &&

753 
Œªsãr_Ëngth
 - 
	`scsi_g‘_»sid
(
¤b
) ==

754 
US_BULK_CS_WRAP_LEN
)

756 
sÿ‰”li¡
 *
sg
 = 
NULL
;

757 
off£t
 = 0;

759 ià(
	`usb_¡Ü_acûss_xãr_buf
((*)
bcs
,

760 
US_BULK_CS_WRAP_LEN
, 
¤b
, &
sg
,

761 &
off£t
, 
FROM_XFER_BUF
) ==

762 
US_BULK_CS_WRAP_LEN
 && 
bcs
->
SigÇtu»
 ==

763 
	`ıu_to_Ë32
(
US_BULK_CS_SIGN
))

765 
	`usb_¡Ü_dbg
(
us
, "Device skipped data…hase\n");

766 
	`scsi_£t_»sid
(
¤b
, 
Œªsãr_Ëngth
);

767 
sk³d_d©a_pha£
;

775 
	`usb_¡Ü_dbg
(
us
, "Attemptingo get CSW..\n");

776 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
»cv_bulk_pe
,

777 
bcs
, 
US_BULK_CS_WRAP_LEN
, &
cswËn
);

783 ià(
»suÉ
 =ğ
USB_STOR_XFER_SHORT
 && 
cswËn
 == 0)

785 
	`usb_¡Ü_dbg
(
us
, "Received 0-length CSW;„etrying...\n");

786 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
»cv_bulk_pe
,

787 
bcs
, 
US_BULK_CS_WRAP_LEN
, &
cswËn
);

791 ià(
»suÉ
 =ğ
USB_STOR_XFER_STALLED
)

793 
	`usb_¡Ü_dbg
(
us
, "Attemptingo get CSW 2ndry...\n");

794 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
»cv_bulk_pe
,

795 
bcs
, 
US_BULK_CS_WRAP_LEN
, 
NULL
);

799 
	`usb_¡Ü_dbg
(
us
, "Bulk stu »suÉ = %d\n", 
»suÉ
);

800 ià(
»suÉ
 !ğ
USB_STOR_XFER_GOOD
)

801  
USB_STOR_TRANSPORT_ERROR
;

803 
sk³d_d©a_pha£
:

805 
»sidue
 = 
	`Ë32_to_ıu
(
bcs
->
Residue
);

806 
	`usb_¡Ü_dbg
(
us
, "Bulk status S 0x%x T 0x%x R %u Stat 0x%x\n",

807 
	`Ë32_to_ıu
(
bcs
->
SigÇtu»
), bcs->
Tag
, 
»sidue
,

808 
bcs
->
Stus
);

809 ià(!(
bcs
->
Tag
 =ğ
us
->
g
 || (us->
fæags
 & 
US_FL_BULK_IGNORE_TAG
)) ||

810 
bcs
->
Stus
 > 
US_BULK_STAT_PHASE
)

812 
	`usb_¡Ü_dbg
(
us
, "Bulk†ogicalƒrror\n");

813  
USB_STOR_TRANSPORT_ERROR
;

820 ià(!
us
->
bcs_sigÇtu»
) {

821 
us
->
bcs_sigÇtu»
 = 
bcs
->
SigÇtu»
;

822 ià(
us
->
bcs_sigÇtu»
 !ğ
	`ıu_to_Ë32
(
US_BULK_CS_SIGN
))

823 
	`usb_¡Ü_dbg
(
us
, "Learnt BCS signature 0x%08X\n",

824 
	`Ë32_to_ıu
(
us
->
bcs_sigÇtu»
));

825 } ià(
bcs
->
SigÇtu»
 !ğ
us
->
bcs_sigÇtu»
) {

826 
	`usb_¡Ü_dbg
(
us
,"Signature mismatch: got %08X,ƒxpecting %08X\n",

827 
	`Ë32_to_ıu
(
bcs
->
SigÇtu»
),

828 
	`Ë32_to_ıu
(
us
->
bcs_sigÇtu»
));

829  
USB_STOR_TRANSPORT_ERROR
;

834 ià(
»sidue
 && !(
us
->
fæags
 & 
US_FL_IGNORE_RESIDUE
)) {

838 ià(
bcs
->
Stus
 =ğ
US_BULK_STAT_OK
 && 
	`scsi_g‘_»sid
(
¤b
) == 0

839 && ((
¤b
->
cmnd
[0] =ğ
INQUIRY
 && 
Œªsãr_Ëngth
 == 36) ||

840 (
¤b
->
cmnd
[0] =ğ
READ_CAPACITY
 && 
Œªsãr_Ëngth
 == 8)))

842 
us
->
fæags
 |ğ
US_FL_IGNORE_RESIDUE
;

844 
»sidue
 = 
	`mš
Ôesidue, 
Œªsãr_Ëngth
);

845 
	`scsi_£t_»sid
(
¤b
, 
	`max
(
	`scsi_g‘_»sid
(srb),

846 (è
»sidue
 ));

851 
bcs
->
Stus
) {

852 
US_BULK_STAT_OK
:

854 ià(
çke_£n£
) {

855 
	`memıy
(
¤b
->
£n£_bufãr
,

856 
usb_¡Ü_£n£_šv®idCDB
,

857 (
usb_¡Ü_£n£_šv®idCDB
));

858  
USB_STOR_TRANSPORT_NO_SENSE
;

861  
USB_STOR_TRANSPORT_GOOD
;

862 
US_BULK_STAT_FAIL
:

864  
USB_STOR_TRANSPORT_FAILED
;

865 
US_BULK_STAT_PHASE
:

866  
USB_STOR_TRANSPORT_ERROR
;

868  
USB_STOR_TRANSPORT_ERROR
;

869 
	}
}

872 
	$usb_¡Ü_pÜt_»£t
(
us_d©a
 *
us
)

874 
»suÉ
;

877 ià(
us
->
pusb_dev
->
quœks
 & 
USB_QUIRK_RESET
)

878  -
EPERM
;

880 
»suÉ
 = 
	`usb_lock_deviû_fÜ_»£t
(
us
->
pusb_dev
, us->
pusb_štf
);

881 ià(
»suÉ
 < 0)

882 
	`usb_¡Ü_dbg
(
us
, "Unableo†ockhe device for„eset: %d\n",

883 
»suÉ
);

886 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

887 
»suÉ
 = -
EIO
;

888 
	`usb_¡Ü_dbg
(
us
, "No„eset during disconnect \n");

890 
»suÉ
 = 
	`usb_»£t_deviû
(
us
->
pusb_dev
);

891 
	`usb_¡Ü_dbg
(
us
,"usb_»£t_deviû„‘uº %d\n",
»suÉ
);

893 
	`usb_uÆock_deviû
(
us
->
pusb_dev
);

895  
»suÉ
;

896 
	}
}

899 
	$usb_¡Ü_¡İ_Œª¥Üt
(
us_d©a
 *
us
)

901 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
)) {

902 
	`usb_uÆšk_urb
(
us
->
cu¼’t_urb
);

903 
	`usb_¡Ü_dbg
(
us
, "--Cancelling URB\n");

906 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
)) {

907 
	`usb_¡Ü_dbg
(
us
, "--Cancelling sg„equest\n");

908 
	`usb_sg_ÿnûl
(&
us
->
cu¼’t_sg
);

910 
	}
}

	@transport.h

39 #iâdeà
_TRANSPORT_H_


40 
	#_TRANSPORT_H_


	)

42 
	~<lšux/blkdev.h
>

48 
	#USB_STOR_XFER_GOOD
 0

	)

49 
	#USB_STOR_XFER_SHORT
 1

	)

50 
	#USB_STOR_XFER_STALLED
 2

	)

51 
	#USB_STOR_XFER_LONG
 3

	)

52 
	#USB_STOR_XFER_ERROR
 4

	)

58 
	#USB_STOR_TRANSPORT_GOOD
 0

	)

59 
	#USB_STOR_TRANSPORT_FAILED
 1

	)

60 
	#USB_STOR_TRANSPORT_NO_SENSE
 2

	)

61 
	#USB_STOR_TRANSPORT_ERROR
 3

	)

75 
	#US_CBI_ADSC
 0

	)

77 
usb_¡Ü_CB_Œª¥Üt
(
scsi_cmnd
 *, 
us_d©a
*);

78 
usb_¡Ü_CB_»£t
(
us_d©a
*);

80 
usb_¡Ü_Bulk_Œª¥Üt
(
scsi_cmnd
 *, 
us_d©a
*);

81 
usb_¡Ü_Bulk_max_lun
(
us_d©a
*);

82 
usb_¡Ü_Bulk_»£t
(
us_d©a
*);

84 
usb_¡Ü_švoke_Œª¥Üt
(
scsi_cmnd
 *, 
us_d©a
*);

85 
usb_¡Ü_¡İ_Œª¥Üt
(
us_d©a
*);

87 
usb_¡Ü_cÚŒŞ_msg
(
us_d©a
 *
us
, 
pe
,

88 
u8
 
»que¡
, u8 
»que¡ty³
, 
u16
 
v®ue
, u16 
šdex
,

89 *
d©a
, 
u16
 
size
, 
timeout
);

90 
usb_¡Ü_ş—r_h®t
(
us_d©a
 *
us
, 
pe
);

92 
usb_¡Ü_ù¾_Œªsãr
(
us_d©a
 *
us
, 
pe
,

93 
u8
 
»que¡
, u8 
»que¡ty³
, 
u16
 
v®ue
, u16 
šdex
,

94 *
d©a
, 
u16
 
size
);

95 
usb_¡Ü_bulk_Œªsãr_buf
(
us_d©a
 *
us
, 
pe
,

96 *
buf
, 
Ëngth
, *
aù_Ën
);

97 
usb_¡Ü_bulk_Œªsãr_sg
(
us_d©a
 *
us
, 
pe
,

98 *
buf
, 
Ëngth
, 
u£_sg
, *
»sidu®
);

99 
usb_¡Ü_bulk_¤b
(
us_d©a
* 
us
, 
pe
,

100 
scsi_cmnd
* 
¤b
);

102 
usb_¡Ü_pÜt_»£t
(
us_d©a
 *
us
);

	@transport1.c

46 
	~<lšux/sched.h
>

47 
	~<lšux/gå.h
>

48 
	~<lšux/”ºo.h
>

49 
	~<lšux/expÜt.h
>

51 
	~<lšux/usb/quœks.h
>

53 
	~<scsi/scsi.h
>

54 
	~<scsi/scsi_eh.h
>

55 
	~<scsi/scsi_deviû.h
>

57 
	~"usb.h
"

58 
	~"Œª¥Üt.h
"

59 
	~"´ÙocŞ.h
"

60 
	~"scsiglue.h
"

61 
	~"debug.h
"

63 
	~<lšux/blkdev.h
>

64 
	~"sd.h
"

115 
	$usb_¡Ü_blockšg_com¶‘iÚ
(
urb
 *urb)

117 
com¶‘iÚ
 *
urb_dÚe_±r
 = 
urb
->
cÚ‹xt
;

119 
	`com¶‘e
(
urb_dÚe_±r
);

120 
	}
}

128 
	$usb_¡Ü_msg_commÚ
(
us_d©a
 *
us
, 
timeout
)

130 
com¶‘iÚ
 
urb_dÚe
;

131 
tim–eá
;

132 
¡©us
;

135 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
))

136  -
EIO
;

139 
	`š™_com¶‘iÚ
(&
urb_dÚe
);

142 
us
->
cu¼’t_urb
->
cÚ‹xt
 = &
urb_dÚe
;

143 
us
->
cu¼’t_urb
->
Œªsãr_æags
 = 0;

149 ià(
us
->
cu¼’t_urb
->
Œªsãr_bufãr
 =ğus->
iobuf
)

150 
us
->
cu¼’t_urb
->
Œªsãr_æags
 |ğ
URB_NO_TRANSFER_DMA_MAP
;

151 
us
->
cu¼’t_urb
->
Œªsãr_dma
 = us->
iobuf_dma
;

154 
¡©us
 = 
	`usb_subm™_urb
(
us
->
cu¼’t_urb
, 
GFP_NOIO
);

155 ià(
¡©us
) {

157  
¡©us
;

162 
	`£t_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
);

165 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
)) {

168 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
)) {

169 
	`usb_¡Ü_dbg
(
us
, "-- cancelling URB\n");

170 
	`usb_uÆšk_urb
(
us
->
cu¼’t_urb
);

175 
tim–eá
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË_timeout
(

176 &
urb_dÚe
, 
timeout
 ? : 
MAX_SCHEDULE_TIMEOUT
);

178 
	`ş—r_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
);

180 ià(
tim–eá
 <= 0) {

181 
	`usb_¡Ü_dbg
(
us
, "%s -- cancelling URB\n",

182 
tim–eá
 == 0 ? "Timeout" : "Signal");

183 
	`usb_kl_urb
(
us
->
cu¼’t_urb
);

187  
us
->
cu¼’t_urb
->
¡©us
;

188 
	}
}

194 
	$usb_¡Ü_cÚŒŞ_msg
(
us_d©a
 *
us
, 
pe
,

195 
u8
 
»que¡
, u8 
»que¡ty³
, 
u16
 
v®ue
, u16 
šdex
,

196 *
d©a
, 
u16
 
size
, 
timeout
)

198 
¡©us
;

200 
	`usb_¡Ü_dbg
(
us
, "rq=%02x„qtype=%02x value=%04x index=%02x†en=%u\n",

201 
»que¡
, 
»que¡ty³
, 
v®ue
, 
šdex
, 
size
);

205 
us
->
ü
->
bReque¡Ty³
 = 
»que¡ty³
;

206 
us
->
ü
->
bReque¡
 = 
»que¡
;

207 
us
->
ü
->
wV®ue
 = 
	`ıu_to_Ë16
(
v®ue
);

208 
us
->
ü
->
wIndex
 = 
	`ıu_to_Ë16
(
šdex
);

209 
us
->
ü
->
wL’gth
 = 
	`ıu_to_Ë16
(
size
);

212 
	`usb_fl_cÚŒŞ_urb
(
us
->
cu¼’t_urb
, us->
pusb_dev
, 
pe
,

213 (*è
us
->
ü
, 
d©a
, 
size
,

214 
usb_¡Ü_blockšg_com¶‘iÚ
, 
NULL
);

215 
¡©us
 = 
	`usb_¡Ü_msg_commÚ
(
us
, 
timeout
);

218 ià(
¡©us
 == 0)

219 
¡©us
 = 
us
->
cu¼’t_urb
->
aùu®_Ëngth
;

220  
¡©us
;

221 
	}
}

222 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_cÚŒŞ_msg
);

236 
	$usb_¡Ü_ş—r_h®t
(
us_d©a
 *
us
, 
pe
)

238 
»suÉ
;

239 
’dp
 = 
	`usb_p“ndpošt
(
pe
);

241 ià(
	`usb_peš
 (
pe
))

242 
’dp
 |ğ
USB_DIR_IN
;

244 
»suÉ
 = 
	`usb_¡Ü_cÚŒŞ_msg
(
us
, us->
£nd_ù¾_pe
,

245 
USB_REQ_CLEAR_FEATURE
, 
USB_RECIP_ENDPOINT
,

246 
USB_ENDPOINT_HALT
, 
’dp
,

247 
NULL
, 0, 3*
HZ
);

249 ià(
»suÉ
 >= 0)

250 
	`usb_»£t_’dpošt
(
us
->
pusb_dev
, 
’dp
);

252 
	`usb_¡Ü_dbg
(
us
, "»suÉ = %d\n", 
»suÉ
);

253  
»suÉ
;

254 
	}
}

255 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_ş—r_h®t
);

265 
	$š‹½»t_urb_»suÉ
(
us_d©a
 *
us
, 
pe
,

266 
Ëngth
, 
»suÉ
, 
·¹Ÿl
)

268 
	`usb_¡Ü_dbg
(
us
, "Status code %d;ransferred %u/%u\n",

269 
»suÉ
, 
·¹Ÿl
, 
Ëngth
);

270 
»suÉ
) {

274 ià(
·¹Ÿl
 !ğ
Ëngth
) {

275 
	`usb_¡Ü_dbg
(
us
, "-- shortransfer\n");

276  
USB_STOR_XFER_SHORT
;

279 
	`usb_¡Ü_dbg
(
us
, "--ransfer complete\n");

280  
USB_STOR_XFER_GOOD
;

283 -
EPIPE
:

286 ià(
	`usb_pecÚŒŞ
(
pe
)) {

287 
	`usb_¡Ü_dbg
(
us
, "-- stall on control…ipe\n");

288  
USB_STOR_XFER_STALLED
;

292 
	`usb_¡Ü_dbg
(
us
, "clearingƒndpoint halt for…ipe 0x%x\n",

293 
pe
);

294 ià(
	`usb_¡Ü_ş—r_h®t
(
us
, 
pe
) < 0)

295  
USB_STOR_XFER_ERROR
;

296  
USB_STOR_XFER_STALLED
;

299 -
EOVERFLOW
:

300 
	`usb_¡Ü_dbg
(
us
, "-- babble\n");

301  
USB_STOR_XFER_LONG
;

304 -
ECONNRESET
:

305 
	`usb_¡Ü_dbg
(
us
, "--ransfer cancelled\n");

306  
USB_STOR_XFER_ERROR
;

309 -
EREMOTEIO
:

310 
	`usb_¡Ü_dbg
(
us
, "-- short„eadransfer\n");

311  
USB_STOR_XFER_SHORT
;

314 -
EIO
:

315 
	`usb_¡Ü_dbg
(
us
, "--‡bort or disconnect in…rogress\n");

316  
USB_STOR_XFER_ERROR
;

320 
	`usb_¡Ü_dbg
(
us
, "-- unknownƒrror\n");

321  
USB_STOR_XFER_ERROR
;

323 
	}
}

329 
	$usb_¡Ü_ù¾_Œªsãr
(
us_d©a
 *
us
, 
pe
,

330 
u8
 
»que¡
, u8 
»que¡ty³
, 
u16
 
v®ue
, u16 
šdex
,

331 *
d©a
, 
u16
 
size
)

333 
»suÉ
;

335 
	`usb_¡Ü_dbg
(
us
, "rq=%02x„qtype=%02x value=%04x index=%02x†en=%u\n",

336 
»que¡
, 
»que¡ty³
, 
v®ue
, 
šdex
, 
size
);

339 
us
->
ü
->
bReque¡Ty³
 = 
»que¡ty³
;

340 
us
->
ü
->
bReque¡
 = 
»que¡
;

341 
us
->
ü
->
wV®ue
 = 
	`ıu_to_Ë16
(
v®ue
);

342 
us
->
ü
->
wIndex
 = 
	`ıu_to_Ë16
(
šdex
);

343 
us
->
ü
->
wL’gth
 = 
	`ıu_to_Ë16
(
size
);

346 
	`usb_fl_cÚŒŞ_urb
(
us
->
cu¼’t_urb
, us->
pusb_dev
, 
pe
,

347 (*è
us
->
ü
, 
d©a
, 
size
,

348 
usb_¡Ü_blockšg_com¶‘iÚ
, 
NULL
);

349 
»suÉ
 = 
	`usb_¡Ü_msg_commÚ
(
us
, 0);

351  
	`š‹½»t_urb_»suÉ
(
us
, 
pe
, 
size
, 
»suÉ
,

352 
us
->
cu¼’t_urb
->
aùu®_Ëngth
);

353 
	}
}

354 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_ù¾_Œªsãr
);

363 
	$usb_¡Ü_šŒ_Œªsãr
(
us_d©a
 *
us
, *
buf
,

364 
Ëngth
)

366 
»suÉ
;

367 
pe
 = 
us
->
»cv_šŒ_pe
;

368 
maxp
;

370 
	`usb_¡Ü_dbg
(
us
, "xã¸%u by‹s\n", 
Ëngth
);

373 
maxp
 = 
	`usb_max·ck‘
(
us
->
pusb_dev
, 
pe
, 
	`usb_peout
(pipe));

374 ià(
maxp
 > 
Ëngth
)

375 
maxp
 = 
Ëngth
;

378 
	`usb_fl_št_urb
(
us
->
cu¼’t_urb
, us->
pusb_dev
, 
pe
, 
buf
,

379 
maxp
, 
usb_¡Ü_blockšg_com¶‘iÚ
, 
NULL
,

380 
us
->
•_bIÁ”v®
);

381 
»suÉ
 = 
	`usb_¡Ü_msg_commÚ
(
us
, 0);

383  
	`š‹½»t_urb_»suÉ
(
us
, 
pe
, 
Ëngth
, 
»suÉ
,

384 
us
->
cu¼’t_urb
->
aùu®_Ëngth
);

385 
	}
}

392 
	$usb_¡Ü_bulk_Œªsãr_buf
(
us_d©a
 *
us
, 
pe
,

393 *
buf
, 
Ëngth
, *
aù_Ën
)

395 
»suÉ
;

397 
	`usb_¡Ü_dbg
(
us
, "xã¸%u by‹s\n", 
Ëngth
);

400 
	`usb_fl_bulk_urb
(
us
->
cu¼’t_urb
, us->
pusb_dev
, 
pe
, 
buf
, 
Ëngth
,

401 
usb_¡Ü_blockšg_com¶‘iÚ
, 
NULL
);

402 
»suÉ
 = 
	`usb_¡Ü_msg_commÚ
(
us
, 0);

405 ià(
aù_Ën
)

406 *
aù_Ën
 = 
us
->
cu¼’t_urb
->
aùu®_Ëngth
;

407  
	`š‹½»t_urb_»suÉ
(
us
, 
pe
, 
Ëngth
, 
»suÉ
,

408 
us
->
cu¼’t_urb
->
aùu®_Ëngth
);

409 
	}
}

410 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_bulk_Œªsãr_buf
);

418 
	$usb_¡Ü_bulk_Œªsãr_sgli¡
(
us_d©a
 *
us
, 
pe
,

419 
sÿ‰”li¡
 *
sg
, 
num_sg
, 
Ëngth
,

420 *
aù_Ën
)

422 
»suÉ
;

425 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
))

426  
USB_STOR_XFER_ERROR
;

429 
	`usb_¡Ü_dbg
(
us
, "xã¸%u by‹s, %dƒÁr›s\n", 
Ëngth
, 
num_sg
);

430 
»suÉ
 = 
	`usb_sg_š™
(&
us
->
cu¼’t_sg
, us->
pusb_dev
, 
pe
, 0,

431 
sg
, 
num_sg
, 
Ëngth
, 
GFP_NOIO
);

432 ià(
»suÉ
) {

433 
	`usb_¡Ü_dbg
(
us
, "usb_sg_š™„‘uºed %d\n", 
»suÉ
);

434  
USB_STOR_XFER_ERROR
;

439 
	`£t_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
);

442 ià(
	`‹¡_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
)) {

445 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
)) {

446 
	`usb_¡Ü_dbg
(
us
, "-- cancelling sg„equest\n");

447 
	`usb_sg_ÿnûl
(&
us
->
cu¼’t_sg
);

452 
	`usb_sg_wa™
(&
us
->
cu¼’t_sg
);

453 
	`ş—r_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
);

455 
»suÉ
 = 
us
->
cu¼’t_sg
.
¡©us
;

456 ià(
aù_Ën
)

457 *
aù_Ën
 = 
us
->
cu¼’t_sg
.
by‹s
;

458  
	`š‹½»t_urb_»suÉ
(
us
, 
pe
, 
Ëngth
, 
»suÉ
,

459 
us
->
cu¼’t_sg
.
by‹s
);

460 
	}
}

466 
	$usb_¡Ü_bulk_¤b
(
us_d©a
* 
us
, 
pe
,

467 
scsi_cmnd
* 
¤b
)

469 
·¹Ÿl
;

470 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_sgli¡
(
us
, 
pe
, 
	`scsi_sgli¡
(
¤b
),

471 
	`scsi_sg_couÁ
(
¤b
), 
	`scsi_bufæ’
(srb),

472 &
·¹Ÿl
);

474 
	`scsi_£t_»sid
(
¤b
, 
	`scsi_bufæ’
(¤bè- 
·¹Ÿl
);

475  
»suÉ
;

476 
	}
}

477 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_bulk_¤b
);

488 
	$usb_¡Ü_bulk_Œªsãr_sg
(
us_d©a
* 
us
, 
pe
,

489 *
buf
, 
Ëngth_Ëá
, 
u£_sg
, *
»sidu®
)

491 
»suÉ
;

492 
·¹Ÿl
;

495 ià(
u£_sg
) {

497 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_sgli¡
(
us
, 
pe
,

498 (
sÿ‰”li¡
 *è
buf
, 
u£_sg
,

499 
Ëngth_Ëá
, &
·¹Ÿl
);

500 
Ëngth_Ëá
 -ğ
·¹Ÿl
;

503 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, 
pe
, 
buf
,

504 
Ëngth_Ëá
, &
·¹Ÿl
);

505 
Ëngth_Ëá
 -ğ
·¹Ÿl
;

509 ià(
»sidu®
)

510 *
»sidu®
 = 
Ëngth_Ëá
;

511  
»suÉ
;

512 
	}
}

513 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_bulk_Œªsãr_sg
);

523 
	$Ï¡_£ùÜ_hacks
(
us_d©a
 *
us
, 
scsi_cmnd
 *
¤b
)

525 
g’disk
 *
disk
;

526 
scsi_disk
 *
sdkp
;

527 
u32
 
£ùÜ
;

530 
»cÜd_nÙ_found
[18] = {

532 [2] = 
MEDIUM_ERROR
,

542 ià(!
us
->
u£_Ï¡_£ùÜ_hacks
)

546 ià(
¤b
->
cmnd
[0] !ğ
READ_10
 && srb->cmnd[0] !ğ
WRITE_10
)

547 
dÚe
;

550 
£ùÜ
 = (
¤b
->
cmnd
[2] << 24) | (srb->cmnd[3] << 16) |

551 (
¤b
->
cmnd
[4] << 8) | (srb->cmnd[5]);

552 
disk
 = 
¤b
->
»que¡
->
rq_disk
;

553 ià(!
disk
)

554 
dÚe
;

555 
sdkp
 = 
	`scsi_disk
(
disk
);

556 ià(!
sdkp
)

557 
dÚe
;

558 ià(
£ùÜ
 + 1 !ğ
sdkp
->
ÿ·c™y
)

559 
dÚe
;

561 ià(
¤b
->
»suÉ
 =ğ
SAM_STAT_GOOD
 && 
	`scsi_g‘_»sid
(srb) == 0) {

566 
us
->
u£_Ï¡_£ùÜ_hacks
 = 0;

577 ià(++
us
->
Ï¡_£ùÜ_»Œ›s
 < 3)

579 
¤b
->
»suÉ
 = 
SAM_STAT_CHECK_CONDITION
;

580 
	`memıy
(
¤b
->
£n£_bufãr
, 
»cÜd_nÙ_found
,

581 (
»cÜd_nÙ_found
));

584 
dÚe
:

589 ià(
¤b
->
cmnd
[0] !ğ
TEST_UNIT_READY
)

590 
us
->
Ï¡_£ùÜ_»Œ›s
 = 0;

591 
	}
}

598 
	$usb_¡Ü_švoke_Œª¥Üt
(
scsi_cmnd
 *
¤b
, 
us_d©a
 *
us
)

600 
Ãed_auto_£n£
;

601 
»suÉ
;

604 
	`scsi_£t_»sid
(
¤b
, 0);

605 
»suÉ
 = 
us
->
	`Œª¥Üt
(
¤b
, us);

610 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

611 
	`usb_¡Ü_dbg
(
us
, "-- command was‡borted\n");

612 
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

613 
HªdË_E¼Üs
;

617 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_ERROR
) {

618 
	`usb_¡Ü_dbg
(
us
, "--ransport indicatesƒrror,„esetting\n");

619 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

620 
HªdË_E¼Üs
;

624 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_NO_SENSE
) {

625 
¤b
->
»suÉ
 = 
SAM_STAT_CHECK_CONDITION
;

626 
	`Ï¡_£ùÜ_hacks
(
us
, 
¤b
);

630 
¤b
->
»suÉ
 = 
SAM_STAT_GOOD
;

637 
Ãed_auto_£n£
 = 0;

645 ià((
us
->
´ÙocŞ
 =ğ
USB_PR_CB
 || us->´ÙocŞ =ğ
USB_PR_DPCM_USB
) &&

646 
¤b
->
sc_d©a_dœeùiÚ
 !ğ
DMA_FROM_DEVICE
) {

647 
	`usb_¡Ü_dbg
(
us
, "-- CBransport device„equiring‡uto-sense\n");

648 
Ãed_auto_£n£
 = 1;

656 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_FAILED
) {

657 
	`usb_¡Ü_dbg
(
us
, "--ransport indicates command failure\n");

658 
Ãed_auto_£n£
 = 1;

667 ià(
	`uÆik–y
((
¤b
->
cmnd
[0] =ğ
ATA_16
 || srb->cmnd[0] =ğ
ATA_12
) &&

668 
»suÉ
 =ğ
USB_STOR_TRANSPORT_GOOD
 &&

669 !(
us
->
fæags
 & 
US_FL_SANE_SENSE
) &&

670 !(
us
->
fæags
 & 
US_FL_BAD_SENSE
) &&

671 !(
¤b
->
cmnd
[2] & 0x20))) {

672 
	`usb_¡Ü_dbg
(
us
, "-- SAT supported, increasing‡uto-sense\n");

673 
us
->
fæags
 |ğ
US_FL_SANE_SENSE
;

680 ià((
	`scsi_g‘_»sid
(
¤b
) > 0) &&

681 !((
¤b
->
cmnd
[0] =ğ
REQUEST_SENSE
) ||

682 (
¤b
->
cmnd
[0] =ğ
INQUIRY
) ||

683 (
¤b
->
cmnd
[0] =ğ
MODE_SENSE
) ||

684 (
¤b
->
cmnd
[0] =ğ
LOG_SENSE
) ||

685 (
¤b
->
cmnd
[0] =ğ
MODE_SENSE_10
))) {

686 
	`usb_¡Ü_dbg
(
us
, "-- unexpectedly shortransfer\n");

690 ià(
Ãed_auto_£n£
) {

691 
‹mp_»suÉ
;

692 
scsi_eh_§ve
 
£s
;

693 
£n£_size
 = 
US_SENSE_SIZE
;

694 
scsi_£n£_hdr
 
sshdr
;

695 cÚ¡ 
u8
 *
scdd
;

696 
u8
 
fm_i
;

699 ià(
us
->
fæags
 & 
US_FL_SANE_SENSE
)

700 
£n£_size
 = ~0;

701 
R‘ry_S’£
:

702 
	`usb_¡Ü_dbg
(
us
, "Issuing‡uto-REQUEST_SENSE\n");

704 
	`scsi_eh_´•_cmnd
(
¤b
, &
£s
, 
NULL
, 0, 
£n£_size
);

707 ià(
us
->
subşass
 =ğ
USB_SC_RBC
 || us->subşas =ğ
USB_SC_SCSI
 ||

708 
us
->
subşass
 =ğ
USB_SC_CYP_ATACB
)

709 
¤b
->
cmd_Ën
 = 6;

711 
¤b
->
cmd_Ën
 = 12;

714 
	`scsi_£t_»sid
(
¤b
, 0);

715 
‹mp_»suÉ
 = 
us
->
	`Œª¥Üt
(us->
¤b
, us);

718 
	`scsi_eh_»¡Üe_cmnd
(
¤b
, &
£s
);

720 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

721 
	`usb_¡Ü_dbg
(
us
, "--‡uto-sense‡borted\n");

722 
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

725 ià(
£n£_size
 !ğ
US_SENSE_SIZE
) {

726 
us
->
fæags
 &ğ~
US_FL_SANE_SENSE
;

727 
us
->
fæags
 |ğ
US_FL_BAD_SENSE
;

729 
HªdË_E¼Üs
;

737 ià(
‹mp_»suÉ
 =ğ
USB_STOR_TRANSPORT_FAILED
 &&

738 
£n£_size
 !ğ
US_SENSE_SIZE
) {

739 
	`usb_¡Ü_dbg
(
us
, "--‡uto-sense failure,„etry small sense\n");

740 
£n£_size
 = 
US_SENSE_SIZE
;

741 
us
->
fæags
 &ğ~
US_FL_SANE_SENSE
;

742 
us
->
fæags
 |ğ
US_FL_BAD_SENSE
;

743 
R‘ry_S’£
;

747 ià(
‹mp_»suÉ
 !ğ
USB_STOR_TRANSPORT_GOOD
) {

748 
	`usb_¡Ü_dbg
(
us
, "--‡uto-sense failure\n");

754 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

755 ià(!(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
))

756 
HªdË_E¼Üs
;

764 ià(
¤b
->
£n£_bufãr
[7] > (
US_SENSE_SIZE
 - 8) &&

765 !(
us
->
fæags
 & 
US_FL_SANE_SENSE
) &&

766 !(
us
->
fæags
 & 
US_FL_BAD_SENSE
) &&

767 (
¤b
->
£n£_bufãr
[0] & 0x7C) == 0x70) {

768 
	`usb_¡Ü_dbg
(
us
, "-- SANE_SENSE supportƒnabled\n");

769 
us
->
fæags
 |ğ
US_FL_SANE_SENSE
;

774 
	`usb_¡Ü_dbg
(
us
, "-- Sense dataruncatedo %i from %i\n",

775 
US_SENSE_SIZE
,

776 
¤b
->
£n£_bufãr
[7] + 8);

777 
¤b
->
£n£_bufãr
[7] = (
US_SENSE_SIZE
 - 8);

780 
	`scsi_nÜm®ize_£n£
(
¤b
->
£n£_bufãr
, 
SCSI_SENSE_BUFFERSIZE
,

781 &
sshdr
);

783 
	`usb_¡Ü_dbg
(
us
, "-- Result from‡uto-sense is %d\n",

784 
‹mp_»suÉ
);

785 
	`usb_¡Ü_dbg
(
us
, "-- code: 0x%x, key: 0x%x, ASC: 0x%x, ASCQ: 0x%x\n",

786 
sshdr
.
»¥Ú£_code
, sshdr.
£n£_key
,

787 
sshdr
.
asc
, sshdr.
ascq
);

788 #ifdeà
CONFIG_USB_STORAGE_DEBUG


789 
	`usb_¡Ü_show_£n£
(
us
, 
sshdr
.
£n£_key
, sshdr.
asc
, sshdr.
ascq
);

793 
¤b
->
»suÉ
 = 
SAM_STAT_CHECK_CONDITION
;

795 
scdd
 = 
	`scsi_£n£_desc_fšd
(
¤b
->
£n£_bufãr
,

796 
SCSI_SENSE_BUFFERSIZE
, 4);

797 
fm_i
 = (
scdd
 ? scdd[3] : 
¤b
->
£n£_bufãr
[2]) & 0xA0;

803 ià(
sshdr
.
£n£_key
 =ğ0 && sshdr.
asc
 =ğ0 && sshdr.
ascq
 == 0 &&

804 
fm_i
 == 0) {

809 ià(
»suÉ
 =ğ
USB_STOR_TRANSPORT_GOOD
) {

810 
¤b
->
»suÉ
 = 
SAM_STAT_GOOD
;

811 
¤b
->
£n£_bufãr
[0] = 0x0;

818 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

819 ià((
sshdr
.
»¥Ú£_code
 & 0x72) == 0x72)

820 
¤b
->
£n£_bufãr
[1] = 
HARDWARE_ERROR
;

822 
¤b
->
£n£_bufãr
[2] = 
HARDWARE_ERROR
;

835 ià(
	`uÆik–y
((
us
->
fæags
 & 
US_FL_INITIAL_READ10
) &&

836 
¤b
->
cmnd
[0] =ğ
READ_10
)) {

837 ià(
¤b
->
»suÉ
 =ğ
SAM_STAT_GOOD
) {

838 
	`£t_b™
(
US_FLIDX_READ10_WORKED
, &
us
->
dæags
);

839 } ià(
	`‹¡_b™
(
US_FLIDX_READ10_WORKED
, &
us
->
dæags
)) {

840 
	`ş—r_b™
(
US_FLIDX_READ10_WORKED
, &
us
->
dæags
);

841 
	`£t_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
);

849 ià(
	`‹¡_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
)) {

850 
	`ş—r_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
);

851 
¤b
->
»suÉ
 = 
DID_IMM_RETRY
 << 16;

852 
¤b
->
£n£_bufãr
[0] = 0;

857 ià((
¤b
->
»suÉ
 =ğ
SAM_STAT_GOOD
 || srb->
£n£_bufãr
[2] == 0) &&

858 
	`scsi_bufæ’
(
¤b
è- 
	`scsi_g‘_»sid
(¤bè< srb->
und”æow
)

859 
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

861 
	`Ï¡_£ùÜ_hacks
(
us
, 
¤b
);

867 
HªdË_E¼Üs
:

871 
	`scsi_lock
(
	`us_to_ho¡
(
us
));

872 
	`£t_b™
(
US_FLIDX_RESETTING
, &
us
->
dæags
);

873 
	`ş—r_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
);

874 
	`scsi_uÆock
(
	`us_to_ho¡
(
us
));

878 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

879 
»suÉ
 = 
	`usb_¡Ü_pÜt_»£t
(
us
);

880 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

882 ià(
»suÉ
 < 0) {

883 
	`scsi_lock
(
	`us_to_ho¡
(
us
));

884 
	`usb_¡Ü_»pÜt_deviû_»£t
(
us
);

885 
	`scsi_uÆock
(
	`us_to_ho¡
(
us
));

886 
us
->
	`Œª¥Üt_»£t
(us);

888 
	`ş—r_b™
(
US_FLIDX_RESETTING
, &
us
->
dæags
);

889 
	`Ï¡_£ùÜ_hacks
(
us
, 
¤b
);

890 
	}
}

893 
	$usb_¡Ü_¡İ_Œª¥Üt
(
us_d©a
 *
us
)

899 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_URB_ACTIVE
, &
us
->
dæags
)) {

900 
	`usb_¡Ü_dbg
(
us
, "-- cancelling URB\n");

901 
	`usb_uÆšk_urb
(
us
->
cu¼’t_urb
);

905 ià(
	`‹¡_ªd_ş—r_b™
(
US_FLIDX_SG_ACTIVE
, &
us
->
dæags
)) {

906 
	`usb_¡Ü_dbg
(
us
, "-- cancelling sg„equest\n");

907 
	`usb_sg_ÿnûl
(&
us
->
cu¼’t_sg
);

909 
	}
}

915 
	$usb_¡Ü_CB_Œª¥Üt
(
scsi_cmnd
 *
¤b
, 
us_d©a
 *
us
)

917 
Œªsãr_Ëngth
 = 
	`scsi_bufæ’
(
¤b
);

918 
pe
 = 0;

919 
»suÉ
;

923 
»suÉ
 = 
	`usb_¡Ü_ù¾_Œªsãr
(
us
, us->
£nd_ù¾_pe
,

924 
US_CBI_ADSC
,

925 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
, 0,

926 
us
->
iâum
, 
¤b
->
cmnd
, srb->
cmd_Ën
);

929 
	`usb_¡Ü_dbg
(
us
, "Callo usb_stor_ctrl_transfer()„eturned %d\n",

930 
»suÉ
);

933 ià(
»suÉ
 =ğ
USB_STOR_XFER_STALLED
) {

934  
USB_STOR_TRANSPORT_FAILED
;

938 ià(
»suÉ
 !ğ
USB_STOR_XFER_GOOD
) {

939  
USB_STOR_TRANSPORT_ERROR
;

944 ià(
Œªsãr_Ëngth
) {

945 
pe
 = 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 ?

946 
us
->
»cv_bulk_pe
 : us->
£nd_bulk_pe
;

947 
»suÉ
 = 
	`usb_¡Ü_bulk_¤b
(
us
, 
pe
, 
¤b
);

948 
	`usb_¡Ü_dbg
(
us
, "CBI d©¨¡ag»suÉ i 0x%x\n", 
»suÉ
);

951 ià(
»suÉ
 =ğ
USB_STOR_XFER_STALLED
)

952  
USB_STOR_TRANSPORT_FAILED
;

953 ià(
»suÉ
 > 
USB_STOR_XFER_STALLED
)

954  
USB_STOR_TRANSPORT_ERROR
;

962 ià(
us
->
´ÙocŞ
 !ğ
USB_PR_CBI
)

963  
USB_STOR_TRANSPORT_GOOD
;

965 
»suÉ
 = 
	`usb_¡Ü_šŒ_Œªsãr
(
us
, us->
iobuf
, 2);

966 
	`usb_¡Ü_dbg
(
us
, "Got interrupt data (0x%x, 0x%x)\n",

967 
us
->
iobuf
[0], us->iobuf[1]);

968 ià(
»suÉ
 !ğ
USB_STOR_XFER_GOOD
)

969  
USB_STOR_TRANSPORT_ERROR
;

978 ià(
us
->
subşass
 =ğ
USB_SC_UFI
) {

979 ià(
¤b
->
cmnd
[0] =ğ
REQUEST_SENSE
 ||

980 
¤b
->
cmnd
[0] =ğ
INQUIRY
)

981  
USB_STOR_TRANSPORT_GOOD
;

982 ià(
us
->
iobuf
[0])

983 
Faed
;

984  
USB_STOR_TRANSPORT_GOOD
;

993 ià(
us
->
iobuf
[0]) {

994 
	`usb_¡Ü_dbg
(
us
, "CBI IRQ data showed„eserved bType 0x%x\n",

995 
us
->
iobuf
[0]);

996 
Faed
;

1001 
us
->
iobuf
[1] & 0x0F) {

1003  
USB_STOR_TRANSPORT_GOOD
;

1005 
Faed
;

1007  
USB_STOR_TRANSPORT_ERROR
;

1012 
Faed
:

1013 ià(
pe
)

1014 
	`usb_¡Ü_ş—r_h®t
(
us
, 
pe
);

1015  
USB_STOR_TRANSPORT_FAILED
;

1016 
	}
}

1017 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_CB_Œª¥Üt
);

1024 
	$usb_¡Ü_Bulk_max_lun
(
us_d©a
 *
us
)

1026 
»suÉ
;

1029 
	`´_šfo
("Thi i % funùiÚ:0\n", 
__func__
);

1030 
us
->
iobuf
[0] = 0;

1031 
»suÉ
 = 
	`usb_¡Ü_cÚŒŞ_msg
(
us
, us->
»cv_ù¾_pe
,

1032 
US_BULK_GET_MAX_LUN
,

1033 
USB_DIR_IN
 | 
USB_TYPE_CLASS
 |

1034 
USB_RECIP_INTERFACE
,

1035 0, 
us
->
iâum
, us->
iobuf
, 1, 10*
HZ
);

1037 
	`usb_¡Ü_dbg
(
us
, "GetMaxLUN command„esult is %d, data is %d\n",

1038 
»suÉ
, 
us
->
iobuf
[0]);

1045 ià(
»suÉ
 > 0) {

1046 
	`´_šfo
("Thi i % funùiÚ:1\n", 
__func__
);

1047 ià(
us
->
iobuf
[0] < 16) {

1048  
us
->
iobuf
[0];

1050 
	`dev_šfo
(&
us
->
pusb_štf
->
dev
,

1052 
us
->
iobuf
[0]);

1064 
	}
}

1066 
	$usb_¡Ü_Bulk_Œª¥Üt
(
scsi_cmnd
 *
¤b
, 
us_d©a
 *
us
)

1068 
bulk_cb_w¿p
 *
bcb
 = (bulk_cb_w¿°*è
us
->
iobuf
;

1069 
bulk_cs_w¿p
 *
bcs
 = (bulk_cs_w¿°*è
us
->
iobuf
;

1070 
Œªsãr_Ëngth
 = 
	`scsi_bufæ’
(
¤b
);

1071 
»sidue
;

1072 
»suÉ
;

1073 
çke_£n£
 = 0;

1074 
cswËn
;

1075 
cbwËn
 = 
US_BULK_CB_WRAP_LEN
;

1078 ià(
	`uÆik–y
(
us
->
fæags
 & 
US_FL_BULK32
)) {

1079 
cbwËn
 = 32;

1080 
us
->
iobuf
[31] = 0;

1084 
bcb
->
SigÇtu»
 = 
	`ıu_to_Ë32
(
US_BULK_CB_SIGN
);

1085 
bcb
->
D©aT¿nsãrL’gth
 = 
	`ıu_to_Ë32
(
Œªsãr_Ëngth
);

1086 
bcb
->
FÏgs
 = 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 ?

1087 
US_BULK_FLAG_IN
 : 0;

1088 
bcb
->
Tag
 = ++
us
->
g
;

1089 
bcb
->
Lun
 = 
¤b
->
deviû
->
lun
;

1090 ià(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
)

1091 
bcb
->
Lun
 |ğ
¤b
->
deviû
->
id
 << 4;

1092 
bcb
->
L’gth
 = 
¤b
->
cmd_Ën
;

1095 
	`mem£t
(
bcb
->
CDB
, 0, (bcb->CDB));

1096 
	`memıy
(
bcb
->
CDB
, 
¤b
->
cmnd
, bcb->
L’gth
);

1099 
	`usb_¡Ü_dbg
(
us
, "Bulk Command S 0x%x T 0x%x L %d F %d Trg %d LUN %d CL %d\n",

1100 
	`Ë32_to_ıu
(
bcb
->
SigÇtu»
), bcb->
Tag
,

1101 
	`Ë32_to_ıu
(
bcb
->
D©aT¿nsãrL’gth
), bcb->
FÏgs
,

1102 (
bcb
->
Lun
 >> 4), (bcb->Lun & 0x0F),

1103 
bcb
->
L’gth
);

1104 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
£nd_bulk_pe
,

1105 
bcb
, 
cbwËn
, 
NULL
);

1106 
	`usb_¡Ü_dbg
(
us
, "Bulk commªd¿nsã¸»suÉ=%d\n", 
»suÉ
);

1107 ià(
»suÉ
 !ğ
USB_STOR_XFER_GOOD
)

1108  
USB_STOR_TRANSPORT_ERROR
;

1116 ià(
	`uÆik–y
(
us
->
fæags
 & 
US_FL_GO_SLOW
))

1117 
	`ud–ay
(125);

1119 ià(
Œªsãr_Ëngth
) {

1120 
pe
 = 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 ?

1121 
us
->
»cv_bulk_pe
 : us->
£nd_bulk_pe
;

1122 
»suÉ
 = 
	`usb_¡Ü_bulk_¤b
(
us
, 
pe
, 
¤b
);

1123 
	`usb_¡Ü_dbg
(
us
, "Bulk d©¨Œªsã¸»suÉ 0x%x\n", 
»suÉ
);

1124 ià(
»suÉ
 =ğ
USB_STOR_XFER_ERROR
)

1125  
USB_STOR_TRANSPORT_ERROR
;

1133 ià(
»suÉ
 =ğ
USB_STOR_XFER_LONG
)

1134 
çke_£n£
 = 1;

1142 ià(
»suÉ
 =ğ
USB_STOR_XFER_SHORT
 &&

1143 
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
 &&

1144 
Œªsãr_Ëngth
 - 
	`scsi_g‘_»sid
(
¤b
) ==

1145 
US_BULK_CS_WRAP_LEN
) {

1146 
sÿ‰”li¡
 *
sg
 = 
NULL
;

1147 
off£t
 = 0;

1149 ià(
	`usb_¡Ü_acûss_xãr_buf
((*è
bcs
,

1150 
US_BULK_CS_WRAP_LEN
, 
¤b
, &
sg
,

1151 &
off£t
, 
FROM_XFER_BUF
) ==

1152 
US_BULK_CS_WRAP_LEN
 &&

1153 
bcs
->
SigÇtu»
 ==

1154 
	`ıu_to_Ë32
(
US_BULK_CS_SIGN
)) {

1155 
	`usb_¡Ü_dbg
(
us
, "Device skipped data…hase\n");

1156 
	`scsi_£t_»sid
(
¤b
, 
Œªsãr_Ëngth
);

1157 
sk³d_d©a_pha£
;

1167 
	`usb_¡Ü_dbg
(
us
, "Attemptingo get CSW...\n");

1168 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
»cv_bulk_pe
,

1169 
bcs
, 
US_BULK_CS_WRAP_LEN
, &
cswËn
);

1175 ià(
»suÉ
 =ğ
USB_STOR_XFER_SHORT
 && 
cswËn
 == 0) {

1176 
	`usb_¡Ü_dbg
(
us
, "Received 0-length CSW;„etrying...\n");

1177 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
»cv_bulk_pe
,

1178 
bcs
, 
US_BULK_CS_WRAP_LEN
, &
cswËn
);

1182 ià(
»suÉ
 =ğ
USB_STOR_XFER_STALLED
) {

1185 
	`usb_¡Ü_dbg
(
us
, "Attemptingo get CSW (2ndry)...\n");

1186 
»suÉ
 = 
	`usb_¡Ü_bulk_Œªsãr_buf
(
us
, us->
»cv_bulk_pe
,

1187 
bcs
, 
US_BULK_CS_WRAP_LEN
, 
NULL
);

1191 
	`usb_¡Ü_dbg
(
us
, "Bulk stu »suÉ = %d\n", 
»suÉ
);

1192 ià(
»suÉ
 !ğ
USB_STOR_XFER_GOOD
)

1193  
USB_STOR_TRANSPORT_ERROR
;

1195 
sk³d_d©a_pha£
:

1197 
»sidue
 = 
	`Ë32_to_ıu
(
bcs
->
Residue
);

1198 
	`usb_¡Ü_dbg
(
us
, "Bulk Status S 0x%x T 0x%x R %u Stat 0x%x\n",

1199 
	`Ë32_to_ıu
(
bcs
->
SigÇtu»
), bcs->
Tag
,

1200 
»sidue
, 
bcs
->
Stus
);

1201 ià(!(
bcs
->
Tag
 =ğ
us
->
g
 || (us->
fæags
 & 
US_FL_BULK_IGNORE_TAG
)) ||

1202 
bcs
->
Stus
 > 
US_BULK_STAT_PHASE
) {

1203 
	`usb_¡Ü_dbg
(
us
, "Bulk†ogicalƒrror\n");

1204  
USB_STOR_TRANSPORT_ERROR
;

1211 ià(!
us
->
bcs_sigÇtu»
) {

1212 
us
->
bcs_sigÇtu»
 = 
bcs
->
SigÇtu»
;

1213 ià(
us
->
bcs_sigÇtu»
 !ğ
	`ıu_to_Ë32
(
US_BULK_CS_SIGN
))

1214 
	`usb_¡Ü_dbg
(
us
, "Learnt BCS signature 0x%08X\n",

1215 
	`Ë32_to_ıu
(
us
->
bcs_sigÇtu»
));

1216 } ià(
bcs
->
SigÇtu»
 !ğ
us
->
bcs_sigÇtu»
) {

1217 
	`usb_¡Ü_dbg
(
us
, "Signature mismatch: got %08X,ƒxpecting %08X\n",

1218 
	`Ë32_to_ıu
(
bcs
->
SigÇtu»
),

1219 
	`Ë32_to_ıu
(
us
->
bcs_sigÇtu»
));

1220  
USB_STOR_TRANSPORT_ERROR
;

1225 ià(
»sidue
 && !(
us
->
fæags
 & 
US_FL_IGNORE_RESIDUE
)) {

1231 ià(
bcs
->
Stus
 =ğ
US_BULK_STAT_OK
 &&

1232 
	`scsi_g‘_»sid
(
¤b
) == 0 &&

1233 ((
¤b
->
cmnd
[0] =ğ
INQUIRY
 &&

1234 
Œªsãr_Ëngth
 == 36) ||

1235 (
¤b
->
cmnd
[0] =ğ
READ_CAPACITY
 &&

1236 
Œªsãr_Ëngth
 == 8))) {

1237 
us
->
fæags
 |ğ
US_FL_IGNORE_RESIDUE
;

1240 
»sidue
 = 
	`mš
Ôesidue, 
Œªsãr_Ëngth
);

1241 
	`scsi_£t_»sid
(
¤b
, 
	`max
(
	`scsi_g‘_»sid
(srb),

1242 (è
»sidue
));

1247 
bcs
->
Stus
) {

1248 
US_BULK_STAT_OK
:

1250 ià(
çke_£n£
) {

1251 
	`memıy
(
¤b
->
£n£_bufãr
,

1252 
usb_¡Ü_£n£_šv®idCDB
,

1253 (
usb_¡Ü_£n£_šv®idCDB
));

1254  
USB_STOR_TRANSPORT_NO_SENSE
;

1258  
USB_STOR_TRANSPORT_GOOD
;

1260 
US_BULK_STAT_FAIL
:

1262  
USB_STOR_TRANSPORT_FAILED
;

1264 
US_BULK_STAT_PHASE
:

1268  
USB_STOR_TRANSPORT_ERROR
;

1272  
USB_STOR_TRANSPORT_ERROR
;

1273 
	}
}

1274 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_Bulk_Œª¥Üt
);

1288 
	$usb_¡Ü_»£t_commÚ
(
us_d©a
 *
us
,

1289 
u8
 
»que¡
, u8 
»que¡ty³
,

1290 
u16
 
v®ue
, u16 
šdex
, *
d©a
, u16 
size
)

1292 
»suÉ
;

1293 
»suÉ2
;

1295 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

1296 
	`usb_¡Ü_dbg
(
us
, "No„eset during disconnect\n");

1297  -
EIO
;

1300 
»suÉ
 = 
	`usb_¡Ü_cÚŒŞ_msg
(
us
, us->
£nd_ù¾_pe
,

1301 
»que¡
, 
»que¡ty³
, 
v®ue
, 
šdex
, 
d©a
, 
size
,

1302 5*
HZ
);

1303 ià(
»suÉ
 < 0) {

1304 
	`usb_¡Ü_dbg
(
us
, "Soá„e£ˆçed: %d\n", 
»suÉ
);

1305  
»suÉ
;

1310 
	`wa™_ev’t_š‹¼u±ibË_timeout
(
us
->
d–ay_wa™
,

1311 
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
),

1312 
HZ
*6);

1313 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

1314 
	`usb_¡Ü_dbg
(
us
, "Reset interrupted by disconnect\n");

1315  -
EIO
;

1318 
	`usb_¡Ü_dbg
(
us
, "Soft„eset: clearing bulk-inƒndpoint halt\n");

1319 
»suÉ
 = 
	`usb_¡Ü_ş—r_h®t
(
us
, us->
»cv_bulk_pe
);

1321 
	`usb_¡Ü_dbg
(
us
, "Soft„eset: clearing bulk-outƒndpoint halt\n");

1322 
»suÉ2
 = 
	`usb_¡Ü_ş—r_h®t
(
us
, us->
£nd_bulk_pe
);

1325 ià(
»suÉ
 >= 0)

1326 
»suÉ
 = 
»suÉ2
;

1327 ià(
»suÉ
 < 0)

1328 
	`usb_¡Ü_dbg
(
us
, "Soft„eset failed\n");

1330 
	`usb_¡Ü_dbg
(
us
, "Soft„eset done\n");

1331  
»suÉ
;

1332 
	}
}

1336 
	#CB_RESET_CMD_SIZE
 12

	)

1338 
	$usb_¡Ü_CB_»£t
(
us_d©a
 *
us
)

1340 
	`mem£t
(
us
->
iobuf
, 0xFF, 
CB_RESET_CMD_SIZE
);

1341 
us
->
iobuf
[0] = 
SEND_DIAGNOSTIC
;

1342 
us
->
iobuf
[1] = 4;

1343  
	`usb_¡Ü_»£t_commÚ
(
us
, 
US_CBI_ADSC
,

1344 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
,

1345 0, 
us
->
iâum
, us->
iobuf
, 
CB_RESET_CMD_SIZE
);

1346 
	}
}

1347 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_CB_»£t
);

1352 
	$usb_¡Ü_Bulk_»£t
(
us_d©a
 *
us
)

1354  
	`usb_¡Ü_»£t_commÚ
(
us
, 
US_BULK_RESET_REQUEST
,

1355 
USB_TYPE_CLASS
 | 
USB_RECIP_INTERFACE
,

1356 0, 
us
->
iâum
, 
NULL
, 0);

1357 
	}
}

1358 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_Bulk_»£t
);

1363 
	$usb_¡Ü_pÜt_»£t
(
us_d©a
 *
us
)

1365 
»suÉ
;

1368 ià(
us
->
pusb_dev
->
quœks
 & 
USB_QUIRK_RESET
)

1369  -
EPERM
;

1371 
»suÉ
 = 
	`usb_lock_deviû_fÜ_»£t
(
us
->
pusb_dev
, us->
pusb_štf
);

1372 ià(
»suÉ
 < 0)

1373 
	`usb_¡Ü_dbg
(
us
, "unableo†ock device for„eset: %d\n",

1374 
»suÉ
);

1377 ià(
	`‹¡_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
)) {

1378 
»suÉ
 = -
EIO
;

1379 
	`usb_¡Ü_dbg
(
us
, "No„eset during disconnect\n");

1381 
»suÉ
 = 
	`usb_»£t_deviû
(
us
->
pusb_dev
);

1382 
	`usb_¡Ü_dbg
(
us
, "usb_reset_device„eturns %d\n",

1383 
»suÉ
);

1385 
	`usb_uÆock_deviû
(
us
->
pusb_dev
);

1387  
»suÉ
;

1388 
	}
}

	@uas-detect.h

1 
	~<lšux/usb.h
>

2 
	~<lšux/usb/hcd.h
>

3 
	~"usb.h
"

5 
	$uas_is_š‹rçû
(
usb_ho¡_š‹rçû
 *
štf
)

7  (
štf
->
desc
.
bIÁ”çûCÏss
 =ğ
USB_CLASS_MASS_STORAGE
 &&

8 
štf
->
desc
.
bIÁ”çûSubCÏss
 =ğ
USB_SC_SCSI
 &&

9 
štf
->
desc
.
bIÁ”çûPrÙocŞ
 =ğ
USB_PR_UAS
);

10 
	}
}

12 
	$uas_fšd_uas_®t_£‰šg
(
usb_š‹rçû
 *
štf
)

14 
i
;

16 
i
 = 0; i < 
štf
->
num_®t£‰šg
; i++) {

17 
usb_ho¡_š‹rçû
 *
®t
 = &
štf
->
®t£‰šg
[
i
];

19 ià(
	`uas_is_š‹rçû
(
®t
))

20  
®t
->
desc
.
bAÉ”Ç‹S‘tšg
;

23  -
ENODEV
;

24 
	}
}

26 
	$uas_fšd_’dpošts
(
usb_ho¡_š‹rçû
 *
®t
,

27 
usb_ho¡_’dpošt
 *
•s
[])

29 
usb_ho¡_’dpošt
 *
’dpošt
 = 
®t
->endpoint;

30 
i
, 
n_’dpošts
 = 
®t
->
desc
.
bNumEndpošts
;

32 
i
 = 0; i < 
n_’dpošts
; i++) {

33 *
exŒa
 = 
’dpošt
[
i
].extra;

34 
Ën
 = 
’dpošt
[
i
].
exŒ®’
;

35 
Ën
 >= 3) {

36 ià(
exŒa
[1] =ğ
USB_DT_PIPE_USAGE
) {

37 
pe_id
 = 
exŒa
[2];

38 ià(
pe_id
 > 0 &&…ipe_id < 5)

39 
•s
[
pe_id
 - 1] = &
’dpošt
[
i
];

42 
Ën
 -ğ
exŒa
[0];

43 
exŒa
 +=ƒxtra[0];

47 ià(!
•s
[0] || !eps[1] || !eps[2] || !eps[3])

48  -
ENODEV
;

51 
	}
}

53 
	$uas_u£_uas_driv”
(
usb_š‹rçû
 *
štf
,

54 cÚ¡ 
usb_deviû_id
 *
id
,

55 *
æags_»t
)

57 
usb_ho¡_’dpošt
 *
•s
[4] = { };

58 
usb_deviû
 *
udev
 = 
	`š‹rçû_to_usbdev
(
štf
);

59 
usb_hcd
 *
hcd
 = 
	`bus_to_hcd
(
udev
->
bus
);

60 
æags
 = 
id
->
driv”_šfo
;

61 
r
, 
®t
;

64 
®t
 = 
	`uas_fšd_uas_®t_£‰šg
(
štf
);

65 ià(
®t
 < 0)

68 
r
 = 
	`uas_fšd_’dpošts
(&
štf
->
®t£‰šg
[
®t
], 
•s
);

69 ià(
r
 < 0)

96 ià(
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idV’dÜ
) == 0x174c &&

97 (
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idProduù
) == 0x5106 ||

98 
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idProduù
) == 0x55aa)) {

99 ià(
udev
->
aùcÚfig
->
desc
.
bMaxPow”
 == 0) {

101 } ià(
udev
->
¥“d
 < 
USB_SPEED_SUPER
) {

103 
æags
 |ğ
US_FL_IGNORE_UAS
;

104 } ià(
	`usb_ss_max_¡»ams
(&
•s
[1]->
ss_•_comp
) == 32) {

106 
æags
 |ğ
US_FL_IGNORE_UAS
;

109 
æags
 |ğ
US_FL_MAX_SECTORS_240
;

113 
	`usb_¡Ü_adju¡_quœks
(
udev
, &
æags
);

115 ià(
æags
 & 
US_FL_IGNORE_UAS
) {

116 
	`dev_w¬n
(&
udev
->
dev
,

121 ià(
udev
->
bus
->
sg_bËsize
 == 0) {

122 
	`dev_w¬n
(&
udev
->
dev
,

124 
hcd
->
driv”
->
desütiÚ
);

125 
	`dev_w¬n
(&
udev
->
dev
,

130 ià(
udev
->
¥“d
 >ğ
USB_SPEED_SUPER
 && !
hcd
->
ÿn_do_¡»ams
) {

131 
	`dev_w¬n
(&
udev
->
dev
,

133 
	`hcd_to_bus
(
hcd
)->
bus_Çme
);

134 
	`dev_w¬n
(&
udev
->
dev
,

139 ià(
æags_»t
)

140 *
æags_»t
 = 
æags
;

143 
	}
}

	@unusual_devs.h

64 #ià!
defšed
(
CONFIG_USB_STORAGE_SDDR09
) && \

65 !
	$defšed
(
CONFIG_USB_STORAGE_SDDR09_MODULE
)

66 
	#NO_SDDR09


	)

71 
	`UNUSUAL_DEV
( 0x03eb, 0x2002, 0x0100, 0x0100,

74 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

75 
US_FL_IGNORE_RESIDUE
),

78 
	`UNUSUAL_DEV
( 0x03ee, 0x6906, 0x0003, 0x0003,

81 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

82 
US_FL_IGNORE_RESIDUE
 ),

84 
	`UNUSUAL_DEV
( 0x03f0, 0x0107, 0x0200, 0x0200,

87 
USB_SC_8070
, 
USB_PR_CB
, 
NULL
, 0),

90 
	`UNUSUAL_DEV
( 0x03f0, 0x070c, 0x0000, 0x0000,

93 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

94 
US_FL_SANE_SENSE
 ),

99 
	`UNUSUAL_DEV
( 0x03f0, 0x4002, 0x0001, 0x0001,

102 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_FIX_CAPACITY
),

104 
	`UNUSUAL_DEV
( 0x03f3, 0x0001, 0x0000, 0x9999,

107 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

108 
US_FL_SCM_MULT_TARG
 ),

114 
	`UNUSUAL_DEV
( 0x0409, 0x0040, 0x0000, 0x9999,

117 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

118 
US_FL_SINGLE_LUN
 ),

121 
	`UNUSUAL_DEV
( 0x040d, 0x6205, 0x0003, 0x0003,

124 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

125 
US_FL_IGNORE_RESIDUE
 ),

131 
	`UNUSUAL_DEV
( 0x0411, 0x001c, 0x0113, 0x0113,

134 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

135 
US_FL_FIX_INQUIRY
 ),

138 
	`UNUSUAL_DEV
( 0x0419, 0x0100, 0x0100, 0x0100,

141 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

142 
US_FL_IGNORE_RESIDUE
 ),

145 
	`UNUSUAL_DEV
( 0x0419, 0xaace, 0x0100, 0x0100,

147 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

148 
US_FL_IGNORE_RESIDUE
 ),

151 
	`UNUSUAL_DEV
( 0x0419, 0xaaf5, 0x0100, 0x0100,

154 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

155 
US_FL_IGNORE_RESIDUE
 | 
US_FL_NOT_LOCKABLE
 ),

158 
	`UNUSUAL_DEV
( 0x0419, 0xaaf6, 0x0100, 0x0100,

161 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

162 
US_FL_IGNORE_RESIDUE
 ),

165 
	`UNUSUAL_DEV
( 0x0420, 0x0001, 0x0100, 0x0100,

167 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

168 
US_FL_IGNORE_RESIDUE
 ),

172 
	`UNUSUAL_DEV
( 0x0421, 0x0019, 0x0592, 0x0610,

175 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

176 
US_FL_MAX_SECTORS_64
 ),

179 
	`UNUSUAL_DEV
( 0x0421, 0x042e, 0x0100, 0x0100,

182 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

183 
US_FL_IGNORE_RESIDUE
 | 
US_FL_FIX_CAPACITY
 ),

186 
	`UNUSUAL_DEV
( 0x0421, 0x0433, 0x0100, 0x0100,

189 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

190 
US_FL_IGNORE_RESIDUE
 | 
US_FL_FIX_CAPACITY
 ),

193 
	`UNUSUAL_DEV
( 0x0421, 0x0434, 0x0100, 0x0100,

196 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

197 
US_FL_FIX_CAPACITY
 | 
US_FL_IGNORE_RESIDUE
 ),

201 
	`UNUSUAL_DEV
( 0x0421, 0x0444, 0x0100, 0x0100,

204 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

205 
US_FL_IGNORE_RESIDUE
 | 
US_FL_FIX_CAPACITY
 ),

209 
	`UNUSUAL_DEV
( 0x0421, 0x0446, 0x0100, 0x0100,

212 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

213 
US_FL_IGNORE_RESIDUE
 | 
US_FL_FIX_CAPACITY
 ),

216 
	`UNUSUAL_DEV
( 0x0421, 0x044e, 0x0100, 0x0100,

219 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

220 
US_FL_IGNORE_RESIDUE
 | 
US_FL_FIX_CAPACITY
 ),

223 
	`UNUSUAL_DEV
( 0x0421, 0x047c, 0x0370, 0x0610,

226 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

227 
US_FL_MAX_SECTORS_64
 ),

230 
	`UNUSUAL_DEV
( 0x0421, 0x0492, 0x0452, 0x9999,

233 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

234 
US_FL_MAX_SECTORS_64
 ),

237 
	`UNUSUAL_DEV
( 0x0421, 0x0495, 0x0370, 0x0370,

240 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

241 
US_FL_MAX_SECTORS_64
 ),

244 
	`UNUSUAL_DEV
( 0x0421, 0x04b9, 0x0350, 0x0350,

247 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

248 
US_FL_MAX_SECTORS_64
 ),

251 
	`UNUSUAL_DEV
( 0x0421, 0x05af, 0x0742, 0x0742,

254 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

255 
US_FL_MAX_SECTORS_64
),

258 
	`UNUSUAL_DEV
( 0x0421, 0x06aa, 0x1110, 0x1110,

261 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

262 
US_FL_MAX_SECTORS_64
 ),

264 #ifdeà
NO_SDDR09


265 
	`UNUSUAL_DEV
( 0x0436, 0x0005, 0x0100, 0x0100,

268 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

269 
US_FL_SINGLE_LUN
 ),

274 
	`UNUSUAL_DEV
( 0x0451, 0x5416, 0x0100, 0x0100,

277 
USB_SC_DEVICE
, 
USB_PR_BULK
, 
NULL
,

278 
US_FL_NEED_OVERRIDE
 ),

285 
	`UNUSUAL_DEV
( 0x0457, 0x0150, 0x0100, 0x0100,

288 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_NOT_LOCKABLE
 ),

295 
	`UNUSUAL_DEV
( 0x0457, 0x0151, 0x0100, 0x0100,

298 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

299 
US_FL_NOT_LOCKABLE
 ),

307 
	`UNUSUAL_DEV
( 0x045e, 0xffff, 0x0000, 0x0000,

310 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

311 
US_FL_MAX_SECTORS_64
 ),

319 
	`UNUSUAL_DEV
( 0x046b, 0xff40, 0x0100, 0x0100,

322 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

323 
US_FL_NO_WP_DETECT
),

326 
	`UNUSUAL_DEV
( 0x0482, 0x0100, 0x0100, 0x0100,

329 
USB_SC_8070
, 
USB_PR_CB
, 
NULL
, 
US_FL_FIX_INQUIRY
),

332 
	`UNUSUAL_DEV
( 0x0482, 0x0101, 0x0100, 0x0100,

335 
USB_SC_8070
, 
USB_PR_CB
, 
NULL
, 
US_FL_FIX_INQUIRY
),

338 
	`UNUSUAL_DEV
( 0x0482, 0x0103, 0x0100, 0x0100,

341 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_FIX_INQUIRY
),

344 
	`UNUSUAL_DEV
( 0x0482, 0x0107, 0x0100, 0x0100,

347 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

348 
US_FL_FIX_CAPACITY
 | 
US_FL_NOT_LOCKABLE
),

352 
	`UNUSUAL_DEV
( 0x04a4, 0x0004, 0x0001, 0x0001,

355 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
, 
US_FL_SINGLE_LUN
),

360 
	`UNUSUAL_DEV
( 0x04a5, 0x3010, 0x0100, 0x0100,

363 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

364 
US_FL_IGNORE_RESIDUE
 ),

368 
	`UNUSUAL_DEV
( 0x04b0, 0x0301, 0x0010, 0x0010,

371 
USB_SC_DEVICE
, 
USB_PR_DEVICE
,
NULL
,

372 
US_FL_NOT_LOCKABLE
 ),

375 
	`UNUSUAL_DEV
( 0x04b3, 0x4001, 0x0110, 0x0110,

378 
USB_SC_DEVICE
, 
USB_PR_CB
, 
NULL
,

379 
US_FL_MAX_SECTORS_MIN
),

383 
	`UNUSUAL_DEV
( 0x04b8, 0x0601, 0x0100, 0x0100,

386 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
, 
US_FL_FIX_INQUIRY
),

390 
	`UNUSUAL_DEV
( 0x04b8, 0x0602, 0x0110, 0x0110,

393 
USB_SC_SCSI
, 
USB_PR_BULK
, 
NULL
, 
US_FL_SINGLE_LUN
),

398 
	`UNUSUAL_DEV
( 0x04cb, 0x0100, 0x0000, 0x2210,

401 
USB_SC_UFI
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_FIX_INQUIRY
 | 
US_FL_SINGLE_LUN
),

406 
	`UNUSUAL_DEV
( 0x04ce, 0x0002, 0x026c, 0x026c,

409 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

410 
US_FL_FIX_CAPACITY
),

417 
	`UNUSUAL_DEV
( 0x04da, 0x0901, 0x0100, 0x0200,

420 
USB_SC_UFI
, 
USB_PR_DEVICE
, 
NULL
, 0),

424 
	`UNUSUAL_DEV
( 0x04da, 0x0d05, 0x0000, 0x0000,

427 
USB_SC_8070
, 
USB_PR_CB
, 
NULL
, 0),

430 
	`UNUSUAL_DEV
( 0x04da, 0x2372, 0x0000, 0x9999,

433 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

434 
US_FL_FIX_CAPACITY
 | 
US_FL_NOT_LOCKABLE
 ),

437 
	`UNUSUAL_DEV
( 0x04da, 0x2373, 0x0000, 0x9999,

440 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

441 
US_FL_FIX_CAPACITY
 | 
US_FL_NOT_LOCKABLE
 ),

446 
	`UNUSUAL_DEV
( 0x04e6, 0x0001, 0x0200, 0x0200,

449 
USB_SC_8020
, 
USB_PR_CB
, 
NULL
, 0),

451 
	`UNUSUAL_DEV
( 0x04e6, 0x0002, 0x0100, 0x0100,

454 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

455 
US_FL_SCM_MULT_TARG
 ),

457 #ifdeà
NO_SDDR09


458 
	`UNUSUAL_DEV
( 0x04e6, 0x0005, 0x0100, 0x0208,

461 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

462 
US_FL_SINGLE_LUN
),

466 
	`UNUSUAL_DEV
( 0x04e6, 0x0006, 0x0100, 0x0100,

469 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

470 
US_FL_SINGLE_LUN
),

473 
	`UNUSUAL_DEV
( 0x04e6, 0x0006, 0x0205, 0x0205,

476 
USB_SC_SCSI
, 
USB_PR_DEVICE
, 
NULL
,

477 
US_FL_SINGLE_LUN
),

479 
	`UNUSUAL_DEV
( 0x04e6, 0x0007, 0x0100, 0x0200,

482 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

483 
US_FL_SINGLE_LUN
),

485 
	`UNUSUAL_DEV
( 0x04e6, 0x0009, 0x0200, 0x0200,

488 
USB_SC_8020
, 
USB_PR_CB
, 
NULL
, 0),

490 
	`UNUSUAL_DEV
( 0x04e6, 0x000a, 0x0200, 0x0200,

493 
USB_SC_8020
, 
USB_PR_CB
, 
NULL
, 0),

495 
	`UNUSUAL_DEV
( 0x04e6, 0x000b, 0x0100, 0x0100,

498 
USB_SC_SCSI
, 
USB_PR_BULK
, 
usb_¡Ü_euscsi_š™
,

499 
US_FL_SCM_MULT_TARG
 ),

501 
	`UNUSUAL_DEV
( 0x04e6, 0x000c, 0x0100, 0x0100,

504 
USB_SC_SCSI
, 
USB_PR_BULK
, 
usb_¡Ü_euscsi_š™
,

505 
US_FL_SCM_MULT_TARG
 ),

507 
	`UNUSUAL_DEV
( 0x04e6, 0x000f, 0x0000, 0x9999,

510 
USB_SC_SCSI
, 
USB_PR_BULK
, 
usb_¡Ü_euscsi_š™
,

511 
US_FL_SCM_MULT_TARG
 ),

513 
	`UNUSUAL_DEV
( 0x04e6, 0x0101, 0x0200, 0x0200,

516 
USB_SC_8020
, 
USB_PR_CB
, 
NULL
, 0),

519 
	`UNUSUAL_DEV
( 0x04e8, 0x507c, 0x0220, 0x0220,

522 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

523 
US_FL_MAX_SECTORS_64
),

526 
	`UNUSUAL_DEV
( 0x04e8, 0x5122, 0x0000, 0x9999,

529 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

530 
US_FL_MAX_SECTORS_64
 | 
US_FL_BULK_IGNORE_TAG
),

533 
	`UNUSUAL_DEV
( 0x04e8, 0x5136, 0x0000, 0x9999,

536 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

537 
US_FL_MAX_SECTORS_64
),

543 
	`UNUSUAL_DEV
( 0x04fc, 0x80c2, 0x0100, 0x0100,

546 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

547 
US_FL_BULK32
),

550 
	`UNUSUAL_DEV
( 0x050d, 0x0115, 0x0133, 0x0133,

553 
USB_SC_SCSI
, 
USB_PR_BULK
, 
usb_¡Ü_euscsi_š™
,

554 
US_FL_SCM_MULT_TARG
 ),

560 
	`UNUSUAL_DEV
( 0x0525, 0xa140, 0x0100, 0x0100,

563 
USB_SC_8070
, 
USB_PR_DEVICE
, 
NULL
,

564 
US_FL_FIX_INQUIRY
 ),

567 
	`COMPLIANT_DEV
(0x0525, 0xa4a5, 0x0000, 0x9999,

570 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

571 
US_FL_CAPACITY_OK
 ),

575 
	`UNUSUAL_DEV
( 0x052b, 0x1801, 0x0100, 0x0100,

578 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

579 
US_FL_IGNORE_RESIDUE
 ),

583 
	`UNUSUAL_DEV
( 0x052b, 0x1804, 0x0100, 0x0100,

586 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

587 
US_FL_IGNORE_RESIDUE
 ),

590 
	`UNUSUAL_DEV
( 0x052b, 0x1807, 0x0100, 0x0100,

593 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

594 
US_FL_IGNORE_RESIDUE
 ),

598 
	`UNUSUAL_DEV
( 0x052b, 0x1905, 0x0100, 0x0100,

601 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

602 
US_FL_IGNORE_RESIDUE
 ),

606 
	`UNUSUAL_DEV
( 0x052b, 0x1911, 0x0100, 0x0100,

609 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

610 
US_FL_IGNORE_RESIDUE
 ),

612 
	`UNUSUAL_DEV
( 0x054c, 0x0010, 0x0106, 0x0450,

615 
USB_SC_SCSI
, 
USB_PR_DEVICE
, 
NULL
,

616 
US_FL_SINGLE_LUN
 | 
US_FL_NOT_LOCKABLE
 | 
US_FL_NO_WP_DETECT
 ),

620 
	`UNUSUAL_DEV
( 0x054c, 0x0010, 0x0500, 0x0610,

623 
USB_SC_8070
, 
USB_PR_DEVICE
, 
NULL
,

624 
US_FL_SINGLE_LUN
 ),

628 
	`UNUSUAL_DEV
( 0x054c, 0x0025, 0x0100, 0x0100,

631 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

632 
US_FL_SINGLE_LUN
 ),

635 
	`UNUSUAL_DEV
( 0x054c, 0x002c, 0x0501, 0x2000,

638 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

639 
US_FL_SINGLE_LUN
 ),

641 
	`UNUSUAL_DEV
( 0x054c, 0x002d, 0x0100, 0x0100,

644 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

645 
US_FL_SINGLE_LUN
 ),

648 
	`UNUSUAL_DEV
( 0x054c, 0x002e, 0x0106, 0x0310,

651 
USB_SC_SCSI
, 
USB_PR_DEVICE
, 
NULL
,

652 
US_FL_SINGLE_LUN
 ),

655 
	`UNUSUAL_DEV
( 0x054c, 0x002e, 0x0500, 0x0500,

658 
USB_SC_UFI
, 
USB_PR_DEVICE
, 
NULL
,

659 
US_FL_SINGLE_LUN
 ),

661 
	`UNUSUAL_DEV
( 0x054c, 0x0032, 0x0000, 0x9999,

664 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

665 
US_FL_SINGLE_LUN
 ),

668 
	`UNUSUAL_DEV
( 0x054c, 0x0058, 0x0000, 0x9999,

671 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

672 
US_FL_FIX_INQUIRY
 ),

674 
	`UNUSUAL_DEV
( 0x054c, 0x0069, 0x0000, 0x9999,

677 
USB_SC_UFI
, 
USB_PR_CB
, 
NULL
,

678 
US_FL_SINGLE_LUN
 ),

681 
	`UNUSUAL_DEV
( 0x054c, 0x006d, 0x0000, 0x9999,

684 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

685 
US_FL_FIX_INQUIRY
 ),

688 
	`UNUSUAL_DEV
( 0x054c, 0x0099, 0x0000, 0x9999,

691 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

692 
US_FL_FIX_INQUIRY
 ),

695 
	`UNUSUAL_DEV
( 0x054c, 0x016a, 0x0000, 0x9999,

698 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

699 
US_FL_FIX_INQUIRY
 ),

702 
	`UNUSUAL_DEV
( 0x054c, 0x02a5, 0x0100, 0x0100,

705 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

706 
US_FL_NO_READ_CAPACITY_16
 ),

709 
	`UNUSUAL_DEV
( 0x055d, 0x2020, 0x0000, 0x0210,

712 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

713 
US_FL_SINGLE_LUN
 ),

716 
	`UNUSUAL_DEV
( 0x057b, 0x0000, 0x0000, 0x0299,

719 
USB_SC_DEVICE
, 
USB_PR_CB
, 
NULL
,

720 
US_FL_SINGLE_LUN
),

726 
	`UNUSUAL_DEV
( 0x057b, 0x0022, 0x0000, 0x9999,

729 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 0),

732 
	`UNUSUAL_DEV
( 0x058f, 0x6387, 0x0141, 0x0141,

735 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

736 
US_FL_MAX_SECTORS_64
 ),

739 
	`UNUSUAL_DEV
( 0x0595, 0x4343, 0x0000, 0x2210,

742 
USB_SC_8070
, 
USB_PR_DEVICE
, 
NULL
, 0 ),

750 
	`UNUSUAL_DEV
( 0x059b, 0x0001, 0x0100, 0x0100,

753 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

754 
US_FL_SINGLE_LUN
 ),

756 
	`UNUSUAL_DEV
( 0x059b, 0x0040, 0x0100, 0x0100,

759 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

760 
US_FL_SINGLE_LUN
 ),

763 
	`UNUSUAL_DEV
( 0x059f, 0x0643, 0x0000, 0x0000,

766 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

767 
US_FL_GO_SLOW
 ),

770 
	`UNUSUAL_DEV
( 0x059f, 0x0651, 0x0000, 0x0000,

773 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

774 
US_FL_NO_WP_DETECT
 ),

780 
	`UNUSUAL_DEV
( 0x05ab, 0x0060, 0x1104, 0x1110,

783 
USB_SC_SCSI
, 
USB_PR_BULK
, 
NULL
,

784 
US_FL_NEED_OVERRIDE
 ),

792 
	`UNUSUAL_DEV
( 0x05ac, 0x1202, 0x0000, 0x9999,

795 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

796 
US_FL_FIX_CAPACITY
 ),

799 
	`UNUSUAL_DEV
( 0x05ac, 0x1203, 0x0000, 0x9999,

802 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

803 
US_FL_FIX_CAPACITY
 ),

805 
	`UNUSUAL_DEV
( 0x05ac, 0x1204, 0x0000, 0x9999,

808 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

809 
US_FL_FIX_CAPACITY
 | 
US_FL_NOT_LOCKABLE
 ),

811 
	`UNUSUAL_DEV
( 0x05ac, 0x1205, 0x0000, 0x9999,

814 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

815 
US_FL_FIX_CAPACITY
 ),

821 
	`UNUSUAL_DEV
( 0x05ac, 0x120a, 0x0000, 0x9999,

824 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

825 
US_FL_FIX_CAPACITY
 ),

833 
	`UNUSUAL_DEV
( 0x05c6, 0x1000, 0x0000, 0x9999,

836 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
İtiÚ_ms_š™
,

840 
	`UNUSUAL_DEV
( 0x05dc, 0xb002, 0x0000, 0x0113,

843 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

844 
US_FL_FIX_INQUIRY
 ),

857 
	`UNUSUAL_DEV
( 0x05e3, 0x0701, 0x0000, 0xffff,

860 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

861 
US_FL_GO_SLOW
 | 
US_FL_MAX_SECTORS_64
 | 
US_FL_IGNORE_RESIDUE
 ),

863 
	`UNUSUAL_DEV
( 0x05e3, 0x0702, 0x0000, 0xffff,

866 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

867 
US_FL_GO_SLOW
 | 
US_FL_MAX_SECTORS_64
 | 
US_FL_IGNORE_RESIDUE
 ),

870 
	`UNUSUAL_DEV
( 0x05e3, 0x0723, 0x9451, 0x9451,

873 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

874 
US_FL_SANE_SENSE
 ),

878 
	`UNUSUAL_DEV
( 0x0636, 0x0003, 0x0000, 0x9999,

881 
USB_SC_SCSI
, 
USB_PR_BULK
, 
NULL
,

882 
US_FL_FIX_INQUIRY
 ),

884 
	`UNUSUAL_DEV
( 0x0644, 0x0000, 0x0100, 0x0100,

887 
USB_SC_UFI
, 
USB_PR_CB
, 
NULL
, 0 ),

890 
	`UNUSUAL_DEV
( 0x066f, 0x8000, 0x0001, 0x0001,

893 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

894 
US_FL_FIX_CAPACITY
 ),

897 
	`UNUSUAL_DEV
( 0x067b, 0x1063, 0x0100, 0x0100,

900 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

901 
US_FL_BAD_SENSE
 ),

904 
	`UNUSUAL_DEV
( 0x067b, 0x2317, 0x0001, 0x001,

907 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

908 
US_FL_NOT_LOCKABLE
 ),

913 
	`UNUSUAL_DEV
( 0x067b, 0x2507, 0x0001, 0x0100,

916 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

917 
US_FL_FIX_CAPACITY
 | 
US_FL_GO_SLOW
 ),

920 
	`UNUSUAL_DEV
( 0x067b, 0x3507, 0x0001, 0x0101,

923 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

924 
US_FL_FIX_CAPACITY
 | 
US_FL_GO_SLOW
 ),

927 
	`UNUSUAL_DEV
( 0x0686, 0x4011, 0x0001, 0x0001,

930 
USB_SC_SCSI
, 
USB_PR_BULK
, 
NULL
, 0 ),

933 
	`UNUSUAL_DEV
( 0x0686, 0x4017, 0x0001, 0x0001,

936 
USB_SC_SCSI
, 
USB_PR_DEVICE
, 
NULL
, 0 ),

938 
	`UNUSUAL_DEV
( 0x0693, 0x0005, 0x0100, 0x0100,

941 
USB_SC_SCSI
, 
USB_PR_BULK
, 
NULL
, 0 ),

944 
	`UNUSUAL_DEV
( 0x069b, 0x3004, 0x0001, 0x0001,

947 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

948 
US_FL_FIX_CAPACITY
 ),

950 
	`UNUSUAL_DEV
( 0x06ca, 0x2003, 0x0100, 0x0100,

953 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

954 
US_FL_SCM_MULT_TARG
 ),

957 
	`UNUSUAL_DEV
( 0x071b, 0x3203, 0x0000, 0x0000,

960 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

961 
US_FL_NO_WP_DETECT
 | 
US_FL_MAX_SECTORS_64
 |

962 
US_FL_NO_READ_CAPACITY_16
),

968 
	`UNUSUAL_DEV
( 0x071b, 0x32bb, 0x0000, 0x0000,

971 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

972 
US_FL_NO_WP_DETECT
 | 
US_FL_MAX_SECTORS_64
),

984 
	`UNUSUAL_DEV
( 0x071b, 0x3203, 0x0100, 0x0100,

987 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

988 
US_FL_MAX_SECTORS_64
),

991 
	`UNUSUAL_DEV
( 0x0727, 0x0306, 0x0100, 0x0100,

994 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

995 
US_FL_IGNORE_RESIDUE
),

998 
	`UNUSUAL_DEV
( 0x0781, 0x0001, 0x0200, 0x0200,

1001 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

1002 
US_FL_SINGLE_LUN
 ),

1004 
	`UNUSUAL_DEV
( 0x0781, 0x0002, 0x0009, 0x0009,

1007 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1008 
US_FL_FIX_CAPACITY
 ),

1010 
	`UNUSUAL_DEV
( 0x0781, 0x0100, 0x0100, 0x0100,

1013 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

1014 
US_FL_SINGLE_LUN
 ),

1017 
	`UNUSUAL_DEV
( 0x07ab, 0xfccd, 0x0000, 0x9999,

1020 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1021 
US_FL_FIX_CAPACITY
),

1023 
	`UNUSUAL_DEV
( 0x07af, 0x0004, 0x0100, 0x0133,

1026 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

1027 
US_FL_SCM_MULT_TARG
 ),

1029 
	`UNUSUAL_DEV
( 0x07af, 0x0005, 0x0100, 0x0100,

1032 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

1033 
US_FL_SCM_MULT_TARG
 ),

1035 #ifdeà
NO_SDDR09


1036 
	`UNUSUAL_DEV
( 0x07af, 0x0006, 0x0100, 0x0100,

1039 
USB_SC_SCSI
, 
USB_PR_CB
, 
NULL
,

1040 
US_FL_SINGLE_LUN
 ),

1049 
	`UNUSUAL_DEV
( 0x07c4, 0xa400, 0x0000, 0xffff,

1052 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1053 
US_FL_FIX_INQUIRY
 | 
US_FL_FIX_CAPACITY
 ),

1058 
	`UNUSUAL_DEV
( 0x07c4, 0xa4a5, 0x0000, 0xffff,

1061 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1062 
US_FL_IGNORE_RESIDUE
 | 
US_FL_MAX_SECTORS_64
 ),

1075 
	`UNUSUAL_DEV
( 0x07cf, 0x1001, 0x1000, 0x9999,

1078 
USB_SC_8070
, 
USB_PR_CB
, 
NULL
,

1079 
US_FL_NEED_OVERRIDE
 | 
US_FL_FIX_INQUIRY
 ),

1082 
	`UNUSUAL_DEV
( 0x07cf, 0x1167, 0x0100, 0x0100,

1085 
USB_SC_8070
, 
USB_PR_DEVICE
, 
NULL
, 0),

1088 
	`UNUSUAL_DEV
( 0x0839, 0x000a, 0x0001, 0x0001,

1091 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1092 
US_FL_FIX_INQUIRY
),

1095 
	`UNUSUAL_DEV
( 0x0840, 0x0082, 0x0001, 0x0001,

1098 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1099 
US_FL_FIX_CAPACITY
),

1102 
	`UNUSUAL_DEV
( 0x0840, 0x0084, 0x0001, 0x0001,

1105 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1106 
US_FL_FIX_CAPACITY
),

1109 
	`UNUSUAL_DEV
( 0x0840, 0x0085, 0x0001, 0x0001,

1112 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1113 
US_FL_FIX_CAPACITY
),

1116 
	`UNUSUAL_DEV
( 0x084b, 0xa001, 0x0000, 0x9999,

1119 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

1120 
US_FL_SCM_MULT_TARG
 ),

1128 
	`UNUSUAL_DEV
( 0x084d, 0x0011, 0x0110, 0x0110,

1131 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1132 
US_FL_BULK32
),

1138 
	`UNUSUAL_DEV
( 0x0851, 0x1542, 0x0002, 0x0002,

1141 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 0),

1148 
	`UNUSUAL_DEV
( 0x0851, 0x1543, 0x0200, 0x0200,

1151 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1152 
US_FL_NOT_LOCKABLE
),

1154 
	`UNUSUAL_DEV
( 0x085a, 0x0026, 0x0100, 0x0133,

1157 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

1158 
US_FL_SCM_MULT_TARG
 ),

1160 
	`UNUSUAL_DEV
( 0x085a, 0x0028, 0x0100, 0x0133,

1163 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

1164 
US_FL_SCM_MULT_TARG
 ),

1167 
	`UNUSUAL_DEV
( 0x08bd, 0x1100, 0x0000, 0x0000,

1170 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1171 
US_FL_SINGLE_LUN
),

1176 
	`UNUSUAL_DEV
( 0x08ca, 0x3103, 0x0100, 0x0100,

1179 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1180 
US_FL_IGNORE_RESIDUE
),

1187 
	`UNUSUAL_DEV
( 0x090a, 0x1001, 0x0100, 0x0100,

1190 
USB_SC_DEVICE
, 
USB_PR_BULK
, 
NULL
,

1191 
US_FL_NEED_OVERRIDE
 ),

1196 
	`UNUSUAL_DEV
( 0x090a, 0x1050, 0x0100, 0x0100,

1199 
USB_SC_UFI
, 
USB_PR_DEVICE
, 
NULL
,

1203 
	`UNUSUAL_DEV
( 0x090a, 0x1200, 0x0000, 0x9999,

1206 
USB_SC_RBC
, 
USB_PR_BULK
, 
NULL
,

1210 
	`UNUSUAL_DEV
( 0x090c, 0x1132, 0x0000, 0xffff,

1213 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1214 
US_FL_FIX_CAPACITY
 ),

1220 
	`UNUSUAL_DEV
( 0x090c, 0x6000, 0x0100, 0x0100,

1223 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1224 
US_FL_INITIAL_READ10
 ),

1233 
	`UNUSUAL_DEV
( 0x0a17, 0x0004, 0x1000, 0x1000,

1236 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1237 
US_FL_FIX_INQUIRY
 ),

1241 
	`UNUSUAL_DEV
( 0x0ace, 0x2011, 0x0101, 0x0101,

1244 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1245 
US_FL_IGNORE_DEVICE
 ),

1247 
	`UNUSUAL_DEV
( 0x0ace, 0x20ff, 0x0101, 0x0101,

1250 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1251 
US_FL_IGNORE_DEVICE
 ),

1259 
	`UNUSUAL_DEV
( 0x0af0, 0x6971, 0x0000, 0x9999,

1262 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
İtiÚ_ms_š™
,

1269 
	`UNUSUAL_DEV
( 0x0af0, 0x7401, 0x0000, 0x0000,

1272 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1279 
	`UNUSUAL_DEV
( 0x0af0, 0x7501, 0x0000, 0x0000,

1282 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1285 
	`UNUSUAL_DEV
( 0x0af0, 0x7701, 0x0000, 0x0000,

1288 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1291 
	`UNUSUAL_DEV
( 0x0af0, 0x7706, 0x0000, 0x0000,

1294 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1297 
	`UNUSUAL_DEV
( 0x0af0, 0x7901, 0x0000, 0x0000,

1300 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1303 
	`UNUSUAL_DEV
( 0x0af0, 0x7A01, 0x0000, 0x0000,

1306 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1309 
	`UNUSUAL_DEV
( 0x0af0, 0x7A05, 0x0000, 0x0000,

1312 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1315 
	`UNUSUAL_DEV
( 0x0af0, 0x8300, 0x0000, 0x0000,

1318 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1321 
	`UNUSUAL_DEV
( 0x0af0, 0x8302, 0x0000, 0x0000,

1324 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1327 
	`UNUSUAL_DEV
( 0x0af0, 0x8304, 0x0000, 0x0000,

1330 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1333 
	`UNUSUAL_DEV
( 0x0af0, 0xc100, 0x0000, 0x0000,

1336 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1339 
	`UNUSUAL_DEV
( 0x0af0, 0xd057, 0x0000, 0x0000,

1342 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1345 
	`UNUSUAL_DEV
( 0x0af0, 0xd058, 0x0000, 0x0000,

1348 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1351 
	`UNUSUAL_DEV
( 0x0af0, 0xd157, 0x0000, 0x0000,

1354 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1357 
	`UNUSUAL_DEV
( 0x0af0, 0xd257, 0x0000, 0x0000,

1360 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1363 
	`UNUSUAL_DEV
( 0x0af0, 0xd357, 0x0000, 0x0000,

1366 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1370 
	`UNUSUAL_DEV
(0x0bc2, 0x2300, 0x0000, 0x9999,

1373 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_WRITE_CACHE
),

1376 
	`UNUSUAL_DEV
( 0x0bc2, 0x3010, 0x0000, 0x0000,

1379 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1380 
US_FL_SANE_SENSE
 ),

1382 
	`UNUSUAL_DEV
( 0x0d49, 0x7310, 0x0000, 0x9999,

1385 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1386 
US_FL_SANE_SENSE
),

1392 
	`UNUSUAL_DEV
( 0x0c45, 0x1060, 0x0100, 0x0100,

1395 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1396 
US_FL_SINGLE_LUN
 ),

1399 
	`UNUSUAL_DEV
( 0x0d96, 0x410a, 0x0001, 0xffff,

1402 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1403 
US_FL_FIX_INQUIRY
),

1410 
	`UNUSUAL_DEV
( 0x0d96, 0x5200, 0x0001, 0x0200,

1413 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_FIX_INQUIRY
),

1416 
	`UNUSUAL_DEV
( 0x0dc4, 0x0073, 0x0000, 0x0000,

1419 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1420 
US_FL_FIX_CAPACITY
),

1427 
	`UNUSUAL_DEV
( 0x0dd8, 0x1060, 0x0000, 0xffff,

1430 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1431 
US_FL_FIX_INQUIRY
 ),

1435 
	`UNUSUAL_DEV
( 0x0dd8, 0xd202, 0x0000, 0x9999,

1438 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1439 
US_FL_IGNORE_RESIDUE
 ),

1444 
	`UNUSUAL_DEV
( 0x0dda, 0x0001, 0x0012, 0x0012,

1447 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1448 
US_FL_IGNORE_RESIDUE
 ),

1451 
	`UNUSUAL_DEV
( 0x0dda, 0x0301, 0x0012, 0x0012,

1454 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1455 
US_FL_IGNORE_RESIDUE
 ),

1458 
	`UNUSUAL_DEV
( 0x0e21, 0x0520, 0x0100, 0x0100,

1461 
USB_SC_DEVICE
, 
USB_PR_BULK
, 
NULL
,

1462 
US_FL_NEED_OVERRIDE
 ),

1465 
	`UNUSUAL_DEV
( 0x0ed1, 0x6660, 0x0100, 0x0300,

1468 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1469 
US_FL_FIX_INQUIRY
 ),

1473 
	`UNUSUAL_DEV
( 0x0ea0, 0x2168, 0x0110, 0x0110,

1476 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1477 
US_FL_IGNORE_RESIDUE
 ),

1480 
	`UNUSUAL_DEV
( 0x0ea0, 0x6828, 0x0110, 0x0110,

1483 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1484 
US_FL_IGNORE_RESIDUE
 ),

1488 
	`UNUSUAL_DEV
( 0x0ed1, 0x7636, 0x0103, 0x0103,

1491 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1492 
US_FL_IGNORE_RESIDUE
 | 
US_FL_GO_SLOW
 | 
US_FL_MAX_SECTORS_64
),

1499 
	`UNUSUAL_DEV
( 0x0f19, 0x0103, 0x0100, 0x0100,

1502 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1503 
US_FL_IGNORE_RESIDUE
 ),

1509 
	`UNUSUAL_DEV
( 0x0f19, 0x0105, 0x0100, 0x0100,

1512 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1513 
US_FL_IGNORE_RESIDUE
 ),

1516 
	`UNUSUAL_DEV
( 0x0f88, 0x042e, 0x0100, 0x0100,

1519 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1520 
US_FL_FIX_CAPACITY
 ),

1523 
	`UNUSUAL_DEV
( 0x0fca, 0x8004, 0x0201, 0x0201,

1526 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1527 
US_FL_MAX_SECTORS_64
 ),

1530 
	`UNUSUAL_DEV
( 0x0fce, 0xd008, 0x0000, 0x0000,

1533 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1534 
US_FL_NO_WP_DETECT
 ),

1537 
	`UNUSUAL_DEV
( 0x0fce, 0xd0e1, 0x0000, 0x0000,

1540 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1541 
US_FL_IGNORE_DEVICE
),

1545 
	`UNUSUAL_DEV
( 0x0fce, 0xe030, 0x0000, 0x0000,

1548 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1549 
US_FL_FIX_CAPACITY
 | 
US_FL_IGNORE_RESIDUE
 ),

1552 
	`UNUSUAL_DEV
( 0x0fce, 0xe031, 0x0000, 0x0000,

1555 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1556 
US_FL_IGNORE_RESIDUE
 | 
US_FL_FIX_CAPACITY
 ),

1559 
	`UNUSUAL_DEV
( 0x0fce, 0xe092, 0x0000, 0x0000,

1562 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1563 
US_FL_IGNORE_RESIDUE
 ),

1571 
	`UNUSUAL_DEV
( 0x1019, 0x0c55, 0x0000, 0x0110,

1574 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_uü61s2b_š™
,

1577 
	`UNUSUAL_DEV
( 0x1058, 0x0704, 0x0000, 0x9999,

1580 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1581 
US_FL_SANE_SENSE
),

1584 
	`UNUSUAL_DEV
(0x1058, 0x070a, 0x0000, 0x9999,

1587 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_WRITE_CACHE
),

1592 
	`UNUSUAL_DEV
( 0x10d6, 0x2200, 0x0100, 0x0100,

1595 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1601 
	`UNUSUAL_DEV
( 0x1186, 0x3e04, 0x0000, 0x0000,

1604 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
İtiÚ_ms_š™
, 
US_FL_IGNORE_DEVICE
),

1611 
	`UNUSUAL_DEV
( 0x1199, 0x0fff, 0x0000, 0x9999,

1614 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
s›¼a_ms_š™
,

1621 
	`UNUSUAL_DEV
( 0x1210, 0x0003, 0x0100, 0x0100,

1624 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1625 
US_FL_IGNORE_RESIDUE
 ),

1630 
	`UNUSUAL_DEV
( 0x12d1, 0x1001, 0x0000, 0x0000,

1633 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1635 
	`UNUSUAL_DEV
( 0x12d1, 0x1003, 0x0000, 0x0000,

1638 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1640 
	`UNUSUAL_DEV
( 0x12d1, 0x1004, 0x0000, 0x0000,

1643 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1645 
	`UNUSUAL_DEV
( 0x12d1, 0x1401, 0x0000, 0x0000,

1648 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1650 
	`UNUSUAL_DEV
( 0x12d1, 0x1402, 0x0000, 0x0000,

1653 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1655 
	`UNUSUAL_DEV
( 0x12d1, 0x1403, 0x0000, 0x0000,

1658 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1660 
	`UNUSUAL_DEV
( 0x12d1, 0x1404, 0x0000, 0x0000,

1663 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1665 
	`UNUSUAL_DEV
( 0x12d1, 0x1405, 0x0000, 0x0000,

1668 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1670 
	`UNUSUAL_DEV
( 0x12d1, 0x1406, 0x0000, 0x0000,

1673 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1675 
	`UNUSUAL_DEV
( 0x12d1, 0x1407, 0x0000, 0x0000,

1678 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1680 
	`UNUSUAL_DEV
( 0x12d1, 0x1408, 0x0000, 0x0000,

1683 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1685 
	`UNUSUAL_DEV
( 0x12d1, 0x1409, 0x0000, 0x0000,

1688 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1690 
	`UNUSUAL_DEV
( 0x12d1, 0x140A, 0x0000, 0x0000,

1693 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1695 
	`UNUSUAL_DEV
( 0x12d1, 0x140B, 0x0000, 0x0000,

1698 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1700 
	`UNUSUAL_DEV
( 0x12d1, 0x140C, 0x0000, 0x0000,

1703 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1705 
	`UNUSUAL_DEV
( 0x12d1, 0x140D, 0x0000, 0x0000,

1708 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1710 
	`UNUSUAL_DEV
( 0x12d1, 0x140E, 0x0000, 0x0000,

1713 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1715 
	`UNUSUAL_DEV
( 0x12d1, 0x140F, 0x0000, 0x0000,

1718 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1720 
	`UNUSUAL_DEV
( 0x12d1, 0x1410, 0x0000, 0x0000,

1723 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1725 
	`UNUSUAL_DEV
( 0x12d1, 0x1411, 0x0000, 0x0000,

1728 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1730 
	`UNUSUAL_DEV
( 0x12d1, 0x1412, 0x0000, 0x0000,

1733 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1735 
	`UNUSUAL_DEV
( 0x12d1, 0x1413, 0x0000, 0x0000,

1738 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1740 
	`UNUSUAL_DEV
( 0x12d1, 0x1414, 0x0000, 0x0000,

1743 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1745 
	`UNUSUAL_DEV
( 0x12d1, 0x1415, 0x0000, 0x0000,

1748 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1750 
	`UNUSUAL_DEV
( 0x12d1, 0x1416, 0x0000, 0x0000,

1753 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1755 
	`UNUSUAL_DEV
( 0x12d1, 0x1417, 0x0000, 0x0000,

1758 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1760 
	`UNUSUAL_DEV
( 0x12d1, 0x1418, 0x0000, 0x0000,

1763 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1765 
	`UNUSUAL_DEV
( 0x12d1, 0x1419, 0x0000, 0x0000,

1768 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1770 
	`UNUSUAL_DEV
( 0x12d1, 0x141A, 0x0000, 0x0000,

1773 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1775 
	`UNUSUAL_DEV
( 0x12d1, 0x141B, 0x0000, 0x0000,

1778 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1780 
	`UNUSUAL_DEV
( 0x12d1, 0x141C, 0x0000, 0x0000,

1783 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1785 
	`UNUSUAL_DEV
( 0x12d1, 0x141D, 0x0000, 0x0000,

1788 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1790 
	`UNUSUAL_DEV
( 0x12d1, 0x141E, 0x0000, 0x0000,

1793 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1795 
	`UNUSUAL_DEV
( 0x12d1, 0x141F, 0x0000, 0x0000,

1798 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1800 
	`UNUSUAL_DEV
( 0x12d1, 0x1420, 0x0000, 0x0000,

1803 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1805 
	`UNUSUAL_DEV
( 0x12d1, 0x1421, 0x0000, 0x0000,

1808 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1810 
	`UNUSUAL_DEV
( 0x12d1, 0x1422, 0x0000, 0x0000,

1813 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1815 
	`UNUSUAL_DEV
( 0x12d1, 0x1423, 0x0000, 0x0000,

1818 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1820 
	`UNUSUAL_DEV
( 0x12d1, 0x1424, 0x0000, 0x0000,

1823 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1825 
	`UNUSUAL_DEV
( 0x12d1, 0x1425, 0x0000, 0x0000,

1828 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1830 
	`UNUSUAL_DEV
( 0x12d1, 0x1426, 0x0000, 0x0000,

1833 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1835 
	`UNUSUAL_DEV
( 0x12d1, 0x1427, 0x0000, 0x0000,

1838 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1840 
	`UNUSUAL_DEV
( 0x12d1, 0x1428, 0x0000, 0x0000,

1843 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1845 
	`UNUSUAL_DEV
( 0x12d1, 0x1429, 0x0000, 0x0000,

1848 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1850 
	`UNUSUAL_DEV
( 0x12d1, 0x142A, 0x0000, 0x0000,

1853 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1855 
	`UNUSUAL_DEV
( 0x12d1, 0x142B, 0x0000, 0x0000,

1858 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1860 
	`UNUSUAL_DEV
( 0x12d1, 0x142C, 0x0000, 0x0000,

1863 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1865 
	`UNUSUAL_DEV
( 0x12d1, 0x142D, 0x0000, 0x0000,

1868 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1870 
	`UNUSUAL_DEV
( 0x12d1, 0x142E, 0x0000, 0x0000,

1873 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1875 
	`UNUSUAL_DEV
( 0x12d1, 0x142F, 0x0000, 0x0000,

1878 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1880 
	`UNUSUAL_DEV
( 0x12d1, 0x1430, 0x0000, 0x0000,

1883 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1885 
	`UNUSUAL_DEV
( 0x12d1, 0x1431, 0x0000, 0x0000,

1888 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1890 
	`UNUSUAL_DEV
( 0x12d1, 0x1432, 0x0000, 0x0000,

1893 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1895 
	`UNUSUAL_DEV
( 0x12d1, 0x1433, 0x0000, 0x0000,

1898 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1900 
	`UNUSUAL_DEV
( 0x12d1, 0x1434, 0x0000, 0x0000,

1903 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1905 
	`UNUSUAL_DEV
( 0x12d1, 0x1435, 0x0000, 0x0000,

1908 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1910 
	`UNUSUAL_DEV
( 0x12d1, 0x1436, 0x0000, 0x0000,

1913 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1915 
	`UNUSUAL_DEV
( 0x12d1, 0x1437, 0x0000, 0x0000,

1918 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1920 
	`UNUSUAL_DEV
( 0x12d1, 0x1438, 0x0000, 0x0000,

1923 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1925 
	`UNUSUAL_DEV
( 0x12d1, 0x1439, 0x0000, 0x0000,

1928 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1930 
	`UNUSUAL_DEV
( 0x12d1, 0x143A, 0x0000, 0x0000,

1933 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1935 
	`UNUSUAL_DEV
( 0x12d1, 0x143B, 0x0000, 0x0000,

1938 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1940 
	`UNUSUAL_DEV
( 0x12d1, 0x143C, 0x0000, 0x0000,

1943 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1945 
	`UNUSUAL_DEV
( 0x12d1, 0x143D, 0x0000, 0x0000,

1948 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1950 
	`UNUSUAL_DEV
( 0x12d1, 0x143E, 0x0000, 0x0000,

1953 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1955 
	`UNUSUAL_DEV
( 0x12d1, 0x143F, 0x0000, 0x0000,

1958 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_huawei_e220_š™
,

1962 
	`UNUSUAL_DEV
( 0x132b, 0x000b, 0x0001, 0x0001,

1965 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1969 
	`UNUSUAL_DEV
( 0x1370, 0x6828, 0x0110, 0x0110,

1972 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1973 
US_FL_IGNORE_RESIDUE
 ),

1976 
	`UNUSUAL_DEV
( 0x13fe, 0x3600, 0x0100, 0x0100,

1979 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1980 
US_FL_BULK_IGNORE_TAG
 ),

1983 
	`UNUSUAL_DEV
( 0x14cd, 0x6600, 0x0201, 0x0201,

1986 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1987 
US_FL_IGNORE_RESIDUE
 ),

1990 
	`UNUSUAL_DEV
( 0x152d, 0x0567, 0x0114, 0x0116,

1993 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

1994 
US_FL_BROKEN_FUA
 ),

1999 
	`UNUSUAL_DEV
( 0x152d, 0x2329, 0x0100, 0x0100,

2002 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2003 
US_FL_IGNORE_RESIDUE
 | 
US_FL_SANE_SENSE
 ),

2006 
	`UNUSUAL_DEV
( 0x152d, 0x2566, 0x0114, 0x0114,

2009 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2010 
US_FL_BROKEN_FUA
 ),

2014 
	`UNUSUAL_DEV
( 0x1645, 0x0007, 0x0100, 0x0133,

2017 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

2018 
US_FL_SCM_MULT_TARG
 ),

2022 
	`UNUSUAL_DEV
( 0x1652, 0x6600, 0x0201, 0x0201,

2025 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2026 
US_FL_IGNORE_RESIDUE
 ),

2029 
	`UNUSUAL_DEV
( 0x174c, 0x55aa, 0x0100, 0x0100,

2032 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2033 
US_FL_NEEDS_CAP16
),

2036 
	`UNUSUAL_DEV
( 0x177f, 0x0400, 0x0000, 0x0000,

2039 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2040 
US_FL_BULK_IGNORE_TAG
 | 
US_FL_MAX_SECTORS_64
 ),

2042 
	`UNUSUAL_DEV
( 0x1822, 0x0001, 0x0000, 0x9999,

2045 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

2046 
US_FL_SCM_MULT_TARG
 ),

2052 
	`UNUSUAL_DEV
( 0x1908, 0x1315, 0x0000, 0x0000,

2055 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2056 
US_FL_BAD_SENSE
 ),

2057 
	`UNUSUAL_DEV
( 0x1908, 0x1320, 0x0000, 0x0000,

2060 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2061 
US_FL_BAD_SENSE
 ),

2062 
	`UNUSUAL_DEV
( 0x1908, 0x3335, 0x0200, 0x0200,

2065 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2066 
US_FL_NO_READ_DISC_INFO
 ),

2074 
	`UNUSUAL_DEV
( 0x19d2, 0x1225, 0x0000, 0xffff,

2077 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2078 
US_FL_SINGLE_LUN
 ),

2083 
	`UNUSUAL_DEV
( 0x1b1c, 0x1ab5, 0x0200, 0x0200,

2086 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2087 
US_FL_INITIAL_READ10
 ),

2092 
	`UNUSUAL_DEV
( 0x1e68, 0x001b, 0x0000, 0x0000,

2095 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2096 
US_FL_IGNORE_RESIDUE
 | 
US_FL_SANE_SENSE
 ),

2099 
	`UNUSUAL_DEV
( 0x1e74, 0x4621, 0x0000, 0x0000,

2102 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2103 
US_FL_BULK_IGNORE_TAG
 | 
US_FL_MAX_SECTORS_64
 ),

2106 
	`UNUSUAL_DEV
( 0x2027, 0xa001, 0x0000, 0x9999,

2109 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
usb_¡Ü_euscsi_š™
,

2110 
US_FL_SCM_MULT_TARG
 ),

2112 
	`UNUSUAL_DEV
( 0x2116, 0x0320, 0x0001, 0x0001,

2115 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2116 
US_FL_FIX_CAPACITY
),

2121 
	`UNUSUAL_DEV
( 0x22b8, 0x3010, 0x0001, 0x0001,

2124 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2125 
US_FL_FIX_CAPACITY
 | 
US_FL_IGNORE_RESIDUE
 ),

2132 
	`UNUSUAL_DEV
( 0x22b8, 0x6426, 0x0101, 0x0101,

2135 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2136 
US_FL_FIX_INQUIRY
 | 
US_FL_FIX_CAPACITY
 | 
US_FL_BULK_IGNORE_TAG
),

2139 
	`UNUSUAL_DEV
( 0x2735, 0x100b, 0x0000, 0x9999,

2142 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2143 
US_FL_GO_SLOW
 ),

2148 
	`UNUSUAL_DEV
( 0x3340, 0xffff, 0x0000, 0x0000,

2151 
USB_SC_DEVICE
,
USB_PR_DEVICE
,
NULL
,

2152 
US_FL_MAX_SECTORS_64
 ),

2155 
	`UNUSUAL_DEV
( 0x4102, 0x1020, 0x0100, 0x0100,

2158 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2159 
US_FL_IGNORE_RESIDUE
 ),

2162 
	`UNUSUAL_DEV
( 0x4102, 0x1059, 0x0000, 0x0000,

2165 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2166 
US_FL_MAX_SECTORS_64
 ),

2172 
	`UNUSUAL_DEV
( 0x4146, 0xba01, 0x0100, 0x0100,

2175 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_NOT_LOCKABLE
 ),

2181 
	`UNUSUAL_DEV
( 0xc251, 0x4003, 0x0100, 0x0100,

2184 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2185 
US_FL_NOT_LOCKABLE
),

2188 
	`UNUSUAL_DEV
( 0xed06, 0x4500, 0x0001, 0x0001,

2191 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

2192 
US_FL_CAPACITY_HEURISTICS
),

2195 
	`UNUSUAL_DEV
( 0xed10, 0x7636, 0x0001, 0x0001,

2198 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
, 
US_FL_NOT_LOCKABLE
 ),

2201 #ià
	`IS_ENABLED
(
CONFIG_USB_UAS
)

2202 
	~"unusu®_uas.h
"

2206 
	`USUAL_DEV
(
USB_SC_RBC
, 
USB_PR_CB
),

2207 
	`USUAL_DEV
(
USB_SC_8020
, 
USB_PR_CB
),

2208 
	`USUAL_DEV
(
USB_SC_QIC
, 
USB_PR_CB
),

2209 
	`USUAL_DEV
(
USB_SC_UFI
, 
USB_PR_CB
),

2210 
	`USUAL_DEV
(
USB_SC_8070
, 
USB_PR_CB
),

2211 
	`USUAL_DEV
(
USB_SC_SCSI
, 
USB_PR_CB
),

2214 
	`USUAL_DEV
(
USB_SC_RBC
, 
USB_PR_CBI
),

2215 
	`USUAL_DEV
(
USB_SC_8020
, 
USB_PR_CBI
),

2216 
	`USUAL_DEV
(
USB_SC_QIC
, 
USB_PR_CBI
),

2217 
	`USUAL_DEV
(
USB_SC_UFI
, 
USB_PR_CBI
),

2218 
	`USUAL_DEV
(
USB_SC_8070
, 
USB_PR_CBI
),

2219 
	`USUAL_DEV
(
USB_SC_SCSI
, 
USB_PR_CBI
),

2222 
	`USUAL_DEV
(
USB_SC_RBC
, 
USB_PR_BULK
),

2223 
	`USUAL_DEV
(
USB_SC_8020
, 
USB_PR_BULK
),

2224 
	`USUAL_DEV
(
USB_SC_QIC
, 
USB_PR_BULK
),

2225 
	`USUAL_DEV
(
USB_SC_UFI
, 
USB_PR_BULK
),

2226 
	`USUAL_DEV
(
USB_SC_8070
, 
USB_PR_BULK
),

2227 
	`USUAL_DEV
(
USB_SC_SCSI
, 
USB_PR_BULK
),

	@unusual_uas.h

47 
UNUSUAL_DEV
(0x0984, 0x0301, 0x0128, 0x0128,

50 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

51 
US_FL_IGNORE_UAS
),

54 
UNUSUAL_DEV
(0x0bc2, 0x2312, 0x0000, 0x9999,

57 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

58 
US_FL_NO_ATA_1X
),

61 
UNUSUAL_DEV
(0x0bc2, 0x3312, 0x0000, 0x9999,

64 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

65 
US_FL_NO_ATA_1X
),

68 
UNUSUAL_DEV
(0x0bc2, 0x3320, 0x0000, 0x9999,

71 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

72 
US_FL_NO_ATA_1X
),

75 
UNUSUAL_DEV
(0x0bc2, 0xa003, 0x0000, 0x9999,

78 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

79 
US_FL_NO_ATA_1X
),

82 
UNUSUAL_DEV
(0x0bc2, 0xa013, 0x0000, 0x9999,

85 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

86 
US_FL_NO_ATA_1X
),

89 
UNUSUAL_DEV
(0x0bc2, 0xa0a4, 0x0000, 0x9999,

92 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

93 
US_FL_NO_ATA_1X
),

96 
UNUSUAL_DEV
(0x0bc2, 0xab20, 0x0000, 0x9999,

99 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

100 
US_FL_NO_ATA_1X
),

103 
UNUSUAL_DEV
(0x0bc2, 0xab21, 0x0000, 0x9999,

106 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

107 
US_FL_NO_ATA_1X
),

110 
UNUSUAL_DEV
(0x0bc2, 0xab2a, 0x0000, 0x9999,

113 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

114 
US_FL_NO_ATA_1X
),

117 
UNUSUAL_DEV
(0x13fd, 0x3940, 0x0000, 0x9999,

120 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

121 
US_FL_NO_ATA_1X
),

124 
UNUSUAL_DEV
(0x152d, 0x0539, 0x0000, 0x9999,

127 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

128 
US_FL_NO_REPORT_OPCODES
),

131 
UNUSUAL_DEV
(0x152d, 0x0567, 0x0000, 0x9999,

134 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

135 
US_FL_BROKEN_FUA
 | 
US_FL_NO_REPORT_OPCODES
),

138 
UNUSUAL_DEV
(0x2109, 0x0711, 0x0000, 0x9999,

141 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

142 
US_FL_NO_ATA_1X
),

145 
UNUSUAL_DEV
(0x357d, 0x7788, 0x0000, 0x9999,

148 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

149 
US_FL_NO_REPORT_OPCODES
),

152 
UNUSUAL_DEV
(0x4971, 0x1012, 0x0000, 0x9999,

155 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

156 
US_FL_IGNORE_UAS
),

159 
UNUSUAL_DEV
(0x4971, 0x8017, 0x0000, 0x9999,

162 
USB_SC_DEVICE
, 
USB_PR_DEVICE
, 
NULL
,

163 
US_FL_NO_REPORT_OPCODES
),

	@usb.c

48 #ifdeà
CONFIG_USB_STORAGE_DEBUG


49 
	#DEBUG


	)

52 
	~<lšux/sched.h
>

53 
	~<lšux/”ºo.h
>

54 
	~<lšux/ä“z”.h
>

55 
	~<lšux/moduË.h
>

56 
	~<lšux/¦ab.h
>

57 
	~<lšux/kth»ad.h
>

58 
	~<lšux/mu‹x.h
>

59 
	~<lšux/ut¢ame.h
>

61 
	~<scsi/scsi.h
>

62 
	~<scsi/scsi_cmnd.h
>

63 
	~<scsi/scsi_deviû.h
>

65 
	~"usb.h
"

66 
	~"scsiglue.h
"

67 
	~"Œª¥Üt.h
"

68 
	~"´ÙocŞ.h
"

69 
	~"debug.h
"

75 #ià
IS_ENABLED
(
CONFIG_USB_UAS
)

80 
MODULE_AUTHOR
("Matthew Dharm <mdharm-usb@one-eyed-alien.net>");

81 
MODULE_DESCRIPTION
("USB Mass Storage driver for Linux");

82 
MODULE_LICENSE
("GPL");

84 
	gd–ay_u£
 = 1;

85 
moduË_·¿m
(
d–ay_u£
, 
ušt
, 
S_IRUGO
 | 
S_IWUSR
);

86 
MODULE_PARM_DESC
(
d–ay_u£
, "secondso delay before using‡‚ew device");

88 
	gquœks
[128];

89 
moduË_·¿m_¡ršg
(
quœks
, quœks, (quœks), 
S_IRUGO
 | 
S_IWUSR
);

90 
MODULE_PARM_DESC
(
quœks
, "supplemental†ist of device IDs‡ndheir quirks");

107 
	#UNUSUAL_DEV
(
idV’dÜ
, 
idProduù
, 
bcdDeviûMš
, 
bcdDeviûMax
, \

108 
v’dÜ_Çme
, 
´oduù_Çme
, 
u£_´ÙocŞ
, 
u£_Œª¥Üt
, \

109 
š™_funùiÚ
, 
FÏgs
) \

111 .
v’dÜName
 = 
v’dÜ_Çme
, \

112 .
´oduùName
 = 
´oduù_Çme
, \

113 .
u£PrÙocŞ
 = 
u£_´ÙocŞ
, \

114 .
u£T¿n¥Üt
 = 
u£_Œª¥Üt
, \

115 .
š™FunùiÚ
 = 
š™_funùiÚ
, \

116 }

	)

118 
	#COMPLIANT_DEV
 
UNUSUAL_DEV


	)

120 
	#USUAL_DEV
(
u£_´ÙocŞ
, 
u£_Œª¥Üt
) \

122 .
u£PrÙocŞ
 = 
u£_´ÙocŞ
, \

123 .
u£T¿n¥Üt
 = 
u£_Œª¥Üt
, \

124 }

	)

138 
us_unusu®_dev
 
	gus_unusu®_dev_li¡
[] = {

143 
us_unusu®_dev
 
	gfÜ_dyÇmic_ids
 =

144 
USUAL_DEV
(
USB_SC_SCSI
, 
USB_PR_BULK
);

146 #undeà
UNUSUAL_DEV


147 #undeà
COMPLIANT_DEV


148 #undeà
USUAL_DEV


149 #undeà
UNUSUAL_VENDOR_INTF


151 #ifdeà
CONFIG_LOCKDEP


153 
lock_şass_key
 
	gus_š‹rçû_key
[
USB_MAXINTERFACES
];

155 
	$us_£t_lock_şass
(
mu‹x
 *mutex,

156 
usb_š‹rçû
 *
štf
)

158 
usb_deviû
 *
udev
 = 
	`š‹rçû_to_usbdev
(
štf
);

159 
usb_ho¡_cÚfig
 *
cÚfig
 = 
udev
->
aùcÚfig
;

160 
i
;

162 
i
 = 0; i < 
cÚfig
->
desc
.
bNumIÁ”çûs
; i++) {

163 ià(
cÚfig
->
š‹rçû
[
i
] =ğ
štf
)

167 
	`BUG_ON
(
i
 =ğ
cÚfig
->
desc
.
bNumIÁ”çûs
);

169 
	`lockd•_£t_şass
(
mu‹x
, &
us_š‹rçû_key
[
i
]);

170 
	}
}

174 
	$us_£t_lock_şass
(
mu‹x
 *mutex,

175 
usb_š‹rçû
 *
štf
)

177 
	}
}

181 #ifdeà
CONFIG_PM


183 
	$usb_¡Ü_su¥’d
(
usb_š‹rçû
 *
içû
, 
pm_mes§ge_t
 
mes§ge
)

185 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
içû
);

188 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

190 ià(
us
->
su¥’d_»sume_hook
)

191 (
us
->
su¥’d_»sume_hook
)(us, 
US_SUSPEND
);

196 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

198 
	}
}

199 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_su¥’d
);

201 
	$usb_¡Ü_»sume
(
usb_š‹rçû
 *
içû
)

203 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
içû
);

205 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

207 ià(
us
->
su¥’d_»sume_hook
)

208 (
us
->
su¥’d_»sume_hook
)(us, 
US_RESUME
);

210 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

212 
	}
}

213 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_»sume
);

215 
	$usb_¡Ü_»£t_»sume
(
usb_š‹rçû
 *
içû
)

217 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
içû
);

220 
	`usb_¡Ü_»pÜt_bus_»£t
(
us
);

225 
	}
}

226 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_»£t_»sume
);

235 
	$usb_¡Ü_´e_»£t
(
usb_š‹rçû
 *
içû
)

237 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
içû
);

240 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

242 
	}
}

243 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_´e_»£t
);

245 
	$usb_¡Ü_po¡_»£t
(
usb_š‹rçû
 *
içû
)

247 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
içû
);

250 
	`usb_¡Ü_»pÜt_bus_»£t
(
us
);

255 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

257 
	}
}

258 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_po¡_»£t
);

269 
	$fl_šquœy_»¥Ú£
(
us_d©a
 *
us
, *
d©a
,

270 
d©a_Ën
)

272 ià(
d©a_Ën
 < 36)

275 
	`mem£t
(
d©a
+8, ' ', 28);

276 ià(
d©a
[0]&0x20) {

286 
u16
 
bcdDeviû
 = 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.bcdDevice);

287 
n
;

289 
n
 = 
	`¡¾’
(
us
->
unusu®_dev
->
v’dÜName
);

290 
	`memıy
(
d©a
+8, 
us
->
unusu®_dev
->
v’dÜName
, 
	`mš
(8, 
n
));

291 
n
 = 
	`¡¾’
(
us
->
unusu®_dev
->
´oduùName
);

292 
	`memıy
(
d©a
+16, 
us
->
unusu®_dev
->
´oduùName
, 
	`mš
(16, 
n
));

294 
d©a
[32] = 0x30 + ((
bcdDeviû
>>12) & 0x0F);

295 
d©a
[33] = 0x30 + ((
bcdDeviû
>>8) & 0x0F);

296 
d©a
[34] = 0x30 + ((
bcdDeviû
>>4) & 0x0F);

297 
d©a
[35] = 0x30 + ((
bcdDeviû
) & 0x0F);

301 
	}
}

302 
EXPORT_SYMBOL_GPL
(
fl_šquœy_»¥Ú£
);

304 
	$usb_¡Ü_cÚŒŞ_th»ad
(* 
__us
)

306 
us_d©a
 *
us
 = (us_d©¨*)
__us
;

307 
Scsi_Ho¡
 *
ho¡
 = 
	`us_to_ho¡
(
us
);

310 
	`usb_¡Ü_dbg
(
us
, "***hread sleeping\n");

311 ià(
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË
(&
us
->
cmnd_»ady
))

314 
	`usb_¡Ü_dbg
(
us
, "***hread‡wakened\n");

317 
	`mu‹x_lock
(&(
us
->
dev_mu‹x
));

320 
	`scsi_lock
(
ho¡
);

323 ià(
us
->
¤b
 =ğ
NULL
) {

324 
	`scsi_uÆock
(
ho¡
);

325 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

326 
	`usb_¡Ü_dbg
(
us
, "--ƒxiting\n");

331 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

332 
us
->
¤b
->
»suÉ
 = 
DID_ABORT
 << 16;

333 
SkFÜAbÜt
;

336 
	`scsi_uÆock
(
ho¡
);

341 ià(
us
->
¤b
->
sc_d©a_dœeùiÚ
 =ğ
DMA_BIDIRECTIONAL
) {

342 
	`usb_¡Ü_dbg
(
us
, "UNKNOWN data direction\n");

343 
us
->
¤b
->
»suÉ
 = 
DID_ERROR
 << 16;

349 ià(
us
->
¤b
->
deviû
->
id
 &&

350 !(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
)) {

351 
	`usb_¡Ü_dbg
(
us
, "Badarget‚umber (%d:%llu)\n",

352 
us
->
¤b
->
deviû
->
id
,

353 
us
->
¤b
->
deviû
->
lun
);

354 
us
->
¤b
->
»suÉ
 = 
DID_BAD_TARGET
 << 16;

357 ià(
us
->
¤b
->
deviû
->
lun
 > us->
max_lun
) {

358 
	`usb_¡Ü_dbg
(
us
, "Bad LUN (%d:%llu)\n",

359 
us
->
¤b
->
deviû
->
id
,

360 
us
->
¤b
->
deviû
->
lun
);

361 
us
->
¤b
->
»suÉ
 = 
DID_BAD_TARGET
 << 16;

366 ià((
us
->
¤b
->
cmnd
[0] =ğ
INQUIRY
) &&

367 (
us
->
fæags
 & 
US_FL_FIX_INQUIRY
)) {

368 
d©a_±r
[36] = {

372 
	`usb_¡Ü_dbg
(
us
, "Faking INQUIRY command\n");

374 
us
->
¤b
->
»suÉ
 = 
SAM_STAT_GOOD
;

379 
	`US_DEBUG
(
	`usb_¡Ü_show_commªd
(
us
, us->
¤b
));

380 
us
->
	`´Ùo_hªdËr
(us->
¤b
, us);

381 
	`usb_m¬k_Ï¡_busy
(
us
->
pusb_dev
);

385 
	`scsi_lock
(
ho¡
);

388 ià(
us
->
¤b
->
»suÉ
 !ğ
DID_ABORT
 << 16) {

389 
	`usb_¡Ü_dbg
(
us
, "scsi cmd done,„esult=0x%x\n",

390 
us
->
¤b
->
»suÉ
);

391 
us
->
¤b
->
	`scsi_dÚe
(us->srb);

393 
SkFÜAbÜt
:

394 
	`usb_¡Ü_dbg
(
us
, "scsi command‡borted\n");

402 ià(
	`‹¡_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
)) {

403 
	`com¶‘e
(&(
us
->
nÙify
));

406 
	`ş—r_b™
(
US_FLIDX_ABORTING
, &
us
->
dæags
);

407 
	`ş—r_b™
(
US_FLIDX_TIMED_OUT
, &
us
->
dæags
);

411 
us
->
¤b
 = 
NULL
;

412 
	`scsi_uÆock
(
ho¡
);

415 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

420 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

421 ià(
	`kth»ad_should_¡İ
())

423 
	`scheduË
();

425 
	`__£t_cu¼’t_¡©e
(
TASK_RUNNING
);

427 
	}
}

434 
	$assocŸ‹_dev
(
us_d©a
 *
us
, 
usb_š‹rçû
 *
štf
)

437 
us
->
pusb_dev
 = 
	`š‹rçû_to_usbdev
(
štf
);

438 
us
->
pusb_štf
 = 
štf
;

439 
us
->
iâum
 = 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
;

440 
	`usb_¡Ü_dbg
(
us
, "Vendor: 0x%04x, Product: 0x%04x, Revision: 0x%04x\n",

441 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
idV’dÜ
),

442 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
idProduù
),

443 
	`Ë16_to_ıu
(
us
->
pusb_dev
->
desütÜ
.
bcdDeviû
));

444 
	`usb_¡Ü_dbg
(
us
, "Interface Subclass: 0x%02x, Protocol: 0x%02x\n",

445 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûSubCÏss
,

446 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûPrÙocŞ
);

449 
	`usb_£t_štfd©a
(
štf
, 
us
);

452 
us
->
ü
 = 
	`km®loc
((*us->ü), 
GFP_KERNEL
);

453 ià(!
us
->
ü
)

454  -
ENOMEM
;

456 
us
->
iobuf
 = 
	`usb_®loc_coh”’t
(us->
pusb_dev
, 
US_IOBUF_SIZE
,

457 
GFP_KERNEL
, &
us
->
iobuf_dma
);

458 ià(!
us
->
iobuf
) {

459 
	`usb_¡Ü_dbg
(
us
, "I/O buffer‡llocation failed\n");

460  -
ENOMEM
;

463 
	}
}

466 
	#TOLOWER
(
x
è((xè| 0x20)

	)

469 
	$usb_¡Ü_adju¡_quœks
(
usb_deviû
 *
udev
, *
fæags
)

471 *
p
;

472 
u16
 
vid
 = 
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idV’dÜ
);

473 
u16
 
pid
 = 
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idProduù
);

474 
f
 = 0;

475 
mask
 = (
US_FL_SANE_SENSE
 | 
US_FL_BAD_SENSE
 |

476 
US_FL_FIX_CAPACITY
 | 
US_FL_IGNORE_UAS
 |

477 
US_FL_CAPACITY_HEURISTICS
 | 
US_FL_IGNORE_DEVICE
 |

478 
US_FL_NOT_LOCKABLE
 | 
US_FL_MAX_SECTORS_64
 |

479 
US_FL_CAPACITY_OK
 | 
US_FL_IGNORE_RESIDUE
 |

480 
US_FL_SINGLE_LUN
 | 
US_FL_NO_WP_DETECT
 |

481 
US_FL_NO_READ_DISC_INFO
 | 
US_FL_NO_READ_CAPACITY_16
 |

482 
US_FL_INITIAL_READ10
 | 
US_FL_WRITE_CACHE
 |

483 
US_FL_NO_ATA_1X
 | 
US_FL_NO_REPORT_OPCODES
 |

484 
US_FL_MAX_SECTORS_240
);

486 
p
 = 
quœks
;

487 *
p
) {

489 ià(
vid
 =ğ
	`sim¶e_¡¹oul
(
p
, &p, 16) &&

490 *
p
 == ':' &&

491 
pid
 =ğ
	`sim¶e_¡¹oul
(
p
+1, &p, 16) &&

492 *
p
 == ':')

496 *
p
) {

497 ià(*
p
++ == ',')

501 ià(!*
p
)

505 *++
p
 && *p != ',') {

506 
	`TOLOWER
(*
p
)) {

508 
f
 |ğ
US_FL_SANE_SENSE
;

511 
f
 |ğ
US_FL_BAD_SENSE
;

514 
f
 |ğ
US_FL_FIX_CAPACITY
;

517 
f
 |ğ
US_FL_NO_READ_DISC_INFO
;

520 
f
 |ğ
US_FL_NO_READ_CAPACITY_16
;

523 
f
 |ğ
US_FL_NO_REPORT_OPCODES
;

526 
f
 |ğ
US_FL_MAX_SECTORS_240
;

529 
f
 |ğ
US_FL_CAPACITY_HEURISTICS
;

532 
f
 |ğ
US_FL_IGNORE_DEVICE
;

535 
f
 |ğ
US_FL_NOT_LOCKABLE
;

538 
f
 |ğ
US_FL_MAX_SECTORS_64
;

541 
f
 |ğ
US_FL_INITIAL_READ10
;

544 
f
 |ğ
US_FL_CAPACITY_OK
;

547 
f
 |ğ
US_FL_WRITE_CACHE
;

550 
f
 |ğ
US_FL_IGNORE_RESIDUE
;

553 
f
 |ğ
US_FL_SINGLE_LUN
;

556 
f
 |ğ
US_FL_NO_ATA_1X
;

559 
f
 |ğ
US_FL_IGNORE_UAS
;

562 
f
 |ğ
US_FL_NO_WP_DETECT
;

567 *
fæags
 = (*fæag & ~
mask
è| 
f
;

568 
	}
}

569 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_adju¡_quœks
);

572 
	$g‘_deviû_šfo
(
us_d©a
 *
us
, cÚ¡ 
usb_deviû_id
 *
id
,

573 
us_unusu®_dev
 *
unusu®_dev
)

575 
usb_deviû
 *
dev
 = 
us
->
pusb_dev
;

576 
usb_š‹rçû_desütÜ
 *
idesc
 =

577 &
us
->
pusb_štf
->
cur_®t£‰šg
->
desc
;

578 
deviû
 *
pdev
 = &
us
->
pusb_štf
->
dev
;

582 
us
->
unusu®_dev
 = unusual_dev;

583 
us
->
subşass
 = (
unusu®_dev
->
u£PrÙocŞ
 =ğ
USB_SC_DEVICE
) ?

584 
idesc
->
bIÁ”çûSubCÏss
 :

585 
unusu®_dev
->
u£PrÙocŞ
;

586 
us
->
´ÙocŞ
 = (
unusu®_dev
->
u£T¿n¥Üt
 =ğ
USB_PR_DEVICE
) ?

587 
idesc
->
bIÁ”çûPrÙocŞ
 :

588 
unusu®_dev
->
u£T¿n¥Üt
;

590 
	`´_šfo
("unusu®_dev->u£PrÙocŞ: %d\n", 
unusu®_dev
->
u£PrÙocŞ
);

591 
	`´_šfo
("unusu®_dev->u£T¿n¥Üt: %d\n", 
unusu®_dev
->
u£T¿n¥Üt
);

593 
	`´_šfo
("USB_SC_DEVICE: %d\tUSB_PR_DEVICE:%d\n", 
USB_SC_DEVICE
, 
USB_PR_DEVICE
);

594 
	`´_šfo
("us->subşass: %d\tus->´ÙocŞ: %d\n", 
us
->
subşass
, us->
´ÙocŞ
);

596 
us
->
fæags
 = 
id
->
driv”_šfo
;

597 
	`usb_¡Ü_adju¡_quœks
(
us
->
pusb_dev
, &us->
fæags
);

599 ià(
us
->
fæags
 & 
US_FL_IGNORE_DEVICE
) {

600 
	`dev_šfo
(
pdev
, "device ignored\n");

601  -
ENODEV
;

608 ià(
dev
->
¥“d
 !ğ
USB_SPEED_HIGH
)

609 
us
->
fæags
 &ğ~
US_FL_GO_SLOW
;

611 ià(
us
->
fæags
)

612 
	`dev_šfo
(
pdev
, "Quirks match for vid %04x…id %04x: %lx\n",

613 
	`Ë16_to_ıu
(
dev
->
desütÜ
.
idV’dÜ
),

614 
	`Ë16_to_ıu
(
dev
->
desütÜ
.
idProduù
),

615 
us
->
fæags
);

622 ià(
id
->
idV’dÜ
 || id->
idProduù
) {

623 cÚ¡ *
msgs
[3] = {

627 
usb_deviû_desütÜ
 *
ddesc
 = &
dev
->
desütÜ
;

628 
msg
 = -1;

630 ià(
unusu®_dev
->
u£PrÙocŞ
 !ğ
USB_SC_DEVICE
 &&

631 
us
->
subşass
 =ğ
idesc
->
bIÁ”çûSubCÏss
)

632 
msg
 += 1;

633 ià(
unusu®_dev
->
u£T¿n¥Üt
 !ğ
USB_PR_DEVICE
 &&

634 
us
->
´ÙocŞ
 =ğ
idesc
->
bIÁ”çûPrÙocŞ
)

635 
msg
 += 2;

636 ià(
msg
 >ğ0 && !(
us
->
fæags
 & 
US_FL_NEED_OVERRIDE
))

637 
	`dev_nÙiû
(
pdev
, "This device "

644 
	`Ë16_to_ıu
(
ddesc
->
idV’dÜ
),

645 
	`Ë16_to_ıu
(
ddesc
->
idProduù
),

646 
	`Ë16_to_ıu
(
ddesc
->
bcdDeviû
),

647 
idesc
->
bIÁ”çûSubCÏss
,

648 
idesc
->
bIÁ”çûPrÙocŞ
,

649 
msgs
[
msg
],

650 
	`ut¢ame
()->
»Ëa£
);

654 
	}
}

657 
	$g‘_Œª¥Üt
(
us_d©a
 *
us
)

659 
us
->
´ÙocŞ
) {

674 
USB_PR_BULK
:

675 
us
->
Œª¥Üt_Çme
 = "Bulk";

676 
us
->
Œª¥Üt
 = 
usb_¡Ü_Bulk_Œª¥Üt
;

677 
us
->
Œª¥Üt_»£t
 = 
usb_¡Ü_Bulk_»£t
;

680 
	}
}

683 
	$g‘_´ÙocŞ
(
us_d©a
 *
us
)

685 
us
->
subşass
) {

709 
USB_SC_SCSI
:

710 
us
->
´ÙocŞ_Çme
 = "Transparent SCSI";

711 
us
->
´Ùo_hªdËr
 = 
usb_¡Ü_Œª¥¬’t_scsi_commªd
;

719 
	}
}

722 
	$g‘_pes
(
us_d©a
 *
us
)

724 
usb_ho¡_š‹rçû
 *
®t£‰šg
 =

725 
us
->
pusb_štf
->
cur_®t£‰šg
;

726 
i
;

727 
usb_’dpošt_desütÜ
 *
•
;

728 
usb_’dpošt_desütÜ
 *
•_š
 = 
NULL
;

729 
usb_’dpošt_desütÜ
 *
•_out
 = 
NULL
;

730 
usb_’dpošt_desütÜ
 *
•_št
 = 
NULL
;

738 
i
 = 0; i < 
®t£‰šg
->
desc
.
bNumEndpošts
; i++) {

739 
•
 = &
®t£‰šg
->
’dpošt
[
i
].
desc
;

741 ià(
	`usb_’dpošt_xãr_bulk
(
•
)) {

742 ià(
	`usb_’dpošt_dœ_š
(
•
)) {

743 ià(!
•_š
)

744 
•_š
 = 
•
;

746 ià(!
•_out
)

747 
•_out
 = 
•
;

751 ià(
	`usb_’dpošt_is_št_š
(
•
)) {

752 ià(!
•_št
)

753 
•_št
 = 
•
;

757 ià(!
•_š
 || !
•_out
 || (
us
->
´ÙocŞ
 =ğ
USB_PR_CBI
 && !
•_št
)) {

758 
	`usb_¡Ü_dbg
(
us
, "Endpoint sanity check failed! Rejecting dev.\n");

759  -
EIO
;

763 
us
->
£nd_ù¾_pe
 = 
	`usb_¢dù¾pe
(us->
pusb_dev
, 0);

764 
us
->
»cv_ù¾_pe
 = 
	`usb_rcvù¾pe
(us->
pusb_dev
, 0);

765 
us
->
£nd_bulk_pe
 = 
	`usb_¢dbulkpe
(us->
pusb_dev
,

766 
	`usb_’dpošt_num
(
•_out
));

767 
us
->
»cv_bulk_pe
 = 
	`usb_rcvbulkpe
(us->
pusb_dev
,

768 
	`usb_’dpošt_num
(
•_š
));

769 ià(
•_št
) {

770 
us
->
»cv_šŒ_pe
 = 
	`usb_rcvše
(us->
pusb_dev
,

771 
	`usb_’dpošt_num
(
•_št
));

772 
us
->
•_bIÁ”v®
 = 
•_št
->
bIÁ”v®
;

775 
	}
}

778 
	$usb_¡Ü_acquœe_»sourûs
(
us_d©a
 *
us
)

780 
p
;

781 
sk_¡ruù
 *
th
;

783 
us
->
cu¼’t_urb
 = 
	`usb_®loc_urb
(0, 
GFP_KERNEL
);

784 ià(!
us
->
cu¼’t_urb
) {

785 
	`usb_¡Ü_dbg
(
us
, "URB‡llocation failed\n");

786  -
ENOMEM
;

791 ià(
us
->
unusu®_dev
->
š™FunùiÚ
) {

792 
p
 = 
us
->
unusu®_dev
->
	`š™FunùiÚ
(us);

793 ià(
p
)

794  
p
;

798 
th
 = 
	`kth»ad_run
(
usb_¡Ü_cÚŒŞ_th»ad
, 
us
, "usb-storage");

799 ià(
	`IS_ERR
(
th
)) {

800 
	`dev_w¬n
(&
us
->
pusb_štf
->
dev
,

802  
	`PTR_ERR
(
th
);

804 
us
->
ùl_th»ad
 = 
th
;

807 
	}
}

810 
	$usb_¡Ü_»Ëa£_»sourûs
(
us_d©a
 *
us
)

816 
	`usb_¡Ü_dbg
(
us
, "-- sendingƒxit commandohread\n");

817 
	`com¶‘e
(&
us
->
cmnd_»ady
);

818 ià(
us
->
ùl_th»ad
)

819 
	`kth»ad_¡İ
(
us
->
ùl_th»ad
);

822 ià(
us
->
exŒa_de¡ruùÜ
) {

823 
	`usb_¡Ü_dbg
(
us
, "-- callingƒxtra_destructor()\n");

824 
us
->
	`exŒa_de¡ruùÜ
(us->
exŒa
);

828 
	`kä“
(
us
->
exŒa
);

829 
	`usb_ä“_urb
(
us
->
cu¼’t_urb
);

830 
	}
}

833 
	$dissocŸ‹_dev
(
us_d©a
 *
us
)

836 
	`kä“
(
us
->
ü
);

837 
	`usb_ä“_coh”’t
(
us
->
pusb_dev
, 
US_IOBUF_SIZE
, us->
iobuf
, us->
iobuf_dma
);

840 
	`usb_£t_štfd©a
(
us
->
pusb_štf
, 
NULL
);

841 
	}
}

846 
	$qu›sû_ªd_»move_ho¡
(
us_d©a
 *
us
)

848 
Scsi_Ho¡
 *
ho¡
 = 
	`us_to_ho¡
(
us
);

851 ià(
us
->
pusb_dev
->
¡©e
 =ğ
USB_STATE_NOTATTACHED
) {

852 
	`£t_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
);

853 
	`wake_up
(&
us
->
d–ay_wa™
);

859 
	`ÿnûl_d–ayed_wÜk_sync
(&
us
->
sÿn_dwÜk
);

862 ià(
	`‹¡_b™
(
US_FLIDX_SCAN_PENDING
, &
us
->
dæags
))

863 
	`usb_autİm_put_š‹rçû_no_su¥’d
(
us
->
pusb_štf
);

868 
	`scsi_»move_ho¡
(
ho¡
);

873 
	`scsi_lock
(
ho¡
);

874 
	`£t_b™
(
US_FLIDX_DISCONNECTING
, &
us
->
dæags
);

875 
	`scsi_uÆock
(
ho¡
);

876 
	`wake_up
(&
us
->
d–ay_wa™
);

877 
	}
}

880 
	$»Ëa£_ev”ythšg
(
us_d©a
 *
us
)

882 
	`usb_¡Ü_»Ëa£_»sourûs
(
us
);

883 
	`dissocŸ‹_dev
(
us
);

887 
	`scsi_ho¡_put
(
	`us_to_ho¡
(
us
));

888 
	}
}

891 
	$usb_¡Ü_sÿn_dwÜk
(
wÜk_¡ruù
 *
wÜk
)

893 
us_d©a
 *
us
 = 
	`cÚš”_of
(
wÜk
, us_data,

894 
sÿn_dwÜk
.
wÜk
);

895 
deviû
 *
dev
 = &
us
->
pusb_štf
->dev;

897 
	`dev_dbg
(
dev
, "starting scan\n");

899 
	`´_šfo
("Thi i % funùiÚ:0\n", 
__func__
);

901 ià(
us
->
´ÙocŞ
 =ğ
USB_PR_BULK
 &&

902 !(
us
->
fæags
 & 
US_FL_SINGLE_LUN
) &&

903 !(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
)) {

904 
	`mu‹x_lock
(&
us
->
dev_mu‹x
);

905 
us
->
max_lun
 = 
	`usb_¡Ü_Bulk_max_lun
(us);

910 ià(
us
->
max_lun
 >= 8)

911 
	`us_to_ho¡
(
us
)->
max_lun
 = us->max_lun+1;

912 
	`mu‹x_uÆock
(&
us
->
dev_mu‹x
);

914 
	`scsi_sÿn_ho¡
(
	`us_to_ho¡
(
us
));

915 
	`dev_dbg
(
dev
, "scan complete\n");

919 
	`usb_autİm_put_š‹rçû
(
us
->
pusb_štf
);

920 
	`ş—r_b™
(
US_FLIDX_SCAN_PENDING
, &
us
->
dæags
);

921 
	}
}

923 
	$usb_¡Ü_sg_bËsize
(
usb_š‹rçû
 *
štf
)

925 
usb_deviû
 *
usb_dev
 = 
	`š‹rçû_to_usbdev
(
štf
);

927 ià(
usb_dev
->
bus
->
sg_bËsize
) {

928  
usb_dev
->
bus
->
sg_bËsize
;

930  
SG_ALL
;

931 
	}
}

934 
	$usb_¡Ü_´obe1
(
us_d©a
 **
pus
,

935 
usb_š‹rçû
 *
štf
,

936 cÚ¡ 
usb_deviû_id
 *
id
,

937 
us_unusu®_dev
 *
unusu®_dev
)

939 
Scsi_Ho¡
 *
ho¡
;

940 
us_d©a
 *
us
;

941 
»suÉ
;

943 
	`dev_šfo
(&
štf
->
dev
, "USB Mass Storage device detected\n");

949 
ho¡
 = 
	`scsi_ho¡_®loc
(&
usb_¡Ü_‹m¶©e
, (*
us
));

950 ià(!
ho¡
) {

951 
	`dev_w¬n
(&
štf
->
dev
, "Unableo‡llocatehe scsi host\n");

952  -
ENOMEM
;

958 
ho¡
->
max_cmd_Ën
 = 16;

959 
ho¡
->
sg_bËsize
 = 
	`usb_¡Ü_sg_bËsize
(
štf
);

960 
	`´_šfo
("sg_bËsizis: %d\n", 
ho¡
->
sg_bËsize
);

961 *
pus
 = 
us
 = 
	`ho¡_to_us
(
ho¡
);

962 
	`mu‹x_š™
(&(
us
->
dev_mu‹x
));

963 
	`us_£t_lock_şass
(&
us
->
dev_mu‹x
, 
štf
);

964 
	`š™_com¶‘iÚ
(&
us
->
cmnd_»ady
);

965 
	`š™_com¶‘iÚ
(&(
us
->
nÙify
));

966 
	`š™_wa™queue_h—d
(&
us
->
d–ay_wa™
);

967 
	`INIT_DELAYED_WORK
(&
us
->
sÿn_dwÜk
, 
usb_¡Ü_sÿn_dwÜk
);

970 
»suÉ
 = 
	`assocŸ‹_dev
(
us
, 
štf
);

971 ià(
»suÉ
)

972 
BadDeviû
;

975 
»suÉ
 = 
	`g‘_deviû_šfo
(
us
, 
id
, 
unusu®_dev
);

976 ià(
»suÉ
)

977 
BadDeviû
;

980 
	`g‘_Œª¥Üt
(
us
);

981 
	`g‘_´ÙocŞ
(
us
);

988 
BadDeviû
:

989 
	`usb_¡Ü_dbg
(
us
, "storage_probe() failed\n");

990 
	`»Ëa£_ev”ythšg
(
us
);

991  
»suÉ
;

992 
	}
}

993 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_´obe1
);

996 
	$usb_¡Ü_´obe2
(
us_d©a
 *
us
)

998 
»suÉ
;

999 
deviû
 *
dev
 = &
us
->
pusb_štf
->dev;

1002 ià(!
us
->
Œª¥Üt
 || !us->
´Ùo_hªdËr
) {

1003 
»suÉ
 = -
ENXIO
;

1004 
BadDeviû
;

1006 
	`usb_¡Ü_dbg
(
us
, "T¿n¥Üt: %s\n", us->
Œª¥Üt_Çme
);

1007 
	`usb_¡Ü_dbg
(
us
, "PrÙocŞ: %s\n", us->
´ÙocŞ_Çme
);

1009 ià(
us
->
fæags
 & 
US_FL_SCM_MULT_TARG
) {

1014 
us
->
max_lun
 = 7;

1016 
	`us_to_ho¡
(
us
)->
this_id
 = 7;

1020 
	`us_to_ho¡
(
us
)->
max_id
 = 1;

1026 ià(
us
->
Œª¥Üt
 =ğ
usb_¡Ü_Bulk_Œª¥Üt
)

1027 
	`us_to_ho¡
(
us
)->
no_scsi2_lun_š_cdb
 = 1;

1031 ià(
us
->
fæags
 & 
US_FL_SINGLE_LUN
)

1032 
us
->
max_lun
 = 0;

1035 
»suÉ
 = 
	`g‘_pes
(
us
);

1036 ià(
»suÉ
)

1037 
BadDeviû
;

1043 ià(
us
->
fæags
 & 
US_FL_INITIAL_READ10
)

1044 
	`£t_b™
(
US_FLIDX_REDO_READ10
, &
us
->
dæags
);

1047 
»suÉ
 = 
	`usb_¡Ü_acquœe_»sourûs
(
us
);

1048 ià(
»suÉ
)

1049 
BadDeviû
;

1050 
	`¢´štf
(
us
->
scsi_Çme
, (us->scsi_name), "usb-storage %s",

1051 
	`dev_Çme
(&
us
->
pusb_štf
->
dev
));

1052 
»suÉ
 = 
	`scsi_add_ho¡
(
	`us_to_ho¡
(
us
), 
dev
);

1053 ià(
»suÉ
) {

1054 
	`dev_w¬n
(
dev
,

1056 
BadDeviû
;

1059 
	`usb_autİm_g‘_š‹rçû_no_»sume
(
us
->
pusb_štf
);

1060 
	`£t_b™
(
US_FLIDX_SCAN_PENDING
, &
us
->
dæags
);

1062 ià(
d–ay_u£
 > 0)

1063 
	`dev_dbg
(
dev
, "waiting for deviceo settle before scanning\n");

1064 
	`queue_d–ayed_wÜk
(
sy¡em_ä“zabË_wq
, &
us
->
sÿn_dwÜk
,

1065 
d–ay_u£
 * 
HZ
);

1069 
BadDeviû
:

1070 
	`usb_¡Ü_dbg
(
us
, "storage_probe() failed\n");

1071 
	`»Ëa£_ev”ythšg
(
us
);

1072  
»suÉ
;

1073 
	}
}

1074 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_´obe2
);

1077 
	$usb_¡Ü_discÚÃù
(
usb_š‹rçû
 *
štf
)

1079 
us_d©a
 *
us
 = 
	`usb_g‘_štfd©a
(
štf
);

1081 
	`qu›sû_ªd_»move_ho¡
(
us
);

1082 
	`»Ëa£_ev”ythšg
(
us
);

1083 
	}
}

1084 
EXPORT_SYMBOL_GPL
(
usb_¡Ü_discÚÃù
);

1087 
	$¡Üage_´obe
(
usb_š‹rçû
 *
štf
,

1088 cÚ¡ 
usb_deviû_id
 *
id
)

1090 
us_unusu®_dev
 *
unusu®_dev
;

1091 
us_d©a
 *
us
;

1092 
»suÉ
;

1093 
size
;

1105 ià(
	`usb_usu®_ignÜe_deviû
(
štf
))

1106  -
ENXIO
;

1116 
size
 = 
	`ARRAY_SIZE
(
us_unusu®_dev_li¡
);

1117 ià(
id
 >ğ
usb_¡Üage_usb_ids
 && id < usb_¡Üage_usb_id + 
size
) {

1118 
unusu®_dev
 = (
id
 - 
usb_¡Üage_usb_ids
è+ 
us_unusu®_dev_li¡
;

1120 
	`´_šfo
("Hello_bye\n");

1121 
unusu®_dev
 = &
fÜ_dyÇmic_ids
;

1123 
	`dev_dbg
(&
štf
->
dev
, "Use Bulk-Onlyransport withhe Transparent SCSI…rotocol for dynamic id: 0x%04x 0x%04x\n",

1124 
id
->
idV’dÜ
, id->
idProduù
);

1127 
	`´_šfo
("USB_PR_BULK: %d\n", 
USB_PR_BULK
);

1128 
	`´_šfo
("USB_SC_SCSI: %d\n", 
USB_SC_SCSI
);

1130 
»suÉ
 = 
	`usb_¡Ü_´obe1
(&
us
, 
štf
, 
id
, 
unusu®_dev
);

1131 ià(
»suÉ
)

1132  
»suÉ
;

1136 
»suÉ
 = 
	`usb_¡Ü_´obe2
(
us
);

1137  
»suÉ
;

1138 
	}
}

1140 
usb_driv”
 
	gusb_¡Üage_driv”
 = {

1141 .
Çme
 = "usb-storage",

1142 .
	g´obe
 = 
¡Üage_´obe
,

1143 .
	gdiscÚÃù
 = 
usb_¡Ü_discÚÃù
,

1144 .
	gsu¥’d
 = 
usb_¡Ü_su¥’d
,

1145 .
	g»sume
 = 
usb_¡Ü_»sume
,

1146 .
	g»£t_»sume
 = 
usb_¡Ü_»£t_»sume
,

1147 .
	g´e_»£t
 = 
usb_¡Ü_´e_»£t
,

1148 .
	gpo¡_»£t
 = 
usb_¡Ü_po¡_»£t
,

1149 .
	gid_bË
 = 
usb_¡Üage_usb_ids
,

1150 .
	gsuµÜts_autosu¥’d
 = 1,

1151 .
	gsoá_unbšd
 = 1,

1154 
__š™
 
	$usb_¡Üage_š™
()

1156 
»tv®
;

1158 
	`´_šfo
("Registeringhe USB mass storage driver...\n");

1159 
»tv®
 = 
	`usb_»gi¡”
(&
usb_¡Üage_driv”
);

1160 ià(
»tv®
)

1161 
	`´_šfo
("USB device„egistration failed\n");

1162  
»tv®
;

1163 
	}
}

1165 
__ex™
 
	$usb_¡Üage_ex™
()

1167 
	`´_šfo
("De-registeringhe USB driver...\n");

1168 
	`usb_d”egi¡”
(&
usb_¡Üage_driv”
);

1169 
	}
}

1172 
moduË_š™
(
usb_¡Üage_š™
);

1173 
moduË_ex™
(
usb_¡Üage_ex™
);

	@usb.h

42 #iâdeà
_USB_H_


43 
	#_USB_H_


	)

45 
	~<lšux/usb.h
>

46 
	~<lšux/usb_usu®.h
>

47 
	~<lšux/blkdev.h
>

48 
	~<lšux/com¶‘iÚ.h
>

49 
	~<lšux/mu‹x.h
>

50 
	~<lšux/wÜkqueue.h
>

51 
	~<scsi/scsi_ho¡.h
>

53 
	gus_d©a
;

54 
	gscsi_cmnd
;

60 
	sus_unusu®_dev
 {

61 cÚ¡ * 
	mv’dÜName
;

62 cÚ¡ * 
	m´oduùName
;

63 
__u8
 
	mu£PrÙocŞ
;

64 
__u8
 
	mu£T¿n¥Üt
;

65 (*
	mš™FunùiÚ
)(
	mus_d©a
 *);

70 
	#US_FLIDX_URB_ACTIVE
 0

	)

71 
	#US_FLIDX_SG_ACTIVE
 1

	)

72 
	#US_FLIDX_ABORTING
 2

	)

73 
	#US_FLIDX_DISCONNECTING
 3

	)

74 
	#US_FLIDX_RESETTING
 4

	)

75 
	#US_FLIDX_TIMED_OUT
 5

	)

76 
	#US_FLIDX_SCAN_PENDING
 6

	)

77 
	#US_FLIDX_REDO_READ10
 7

	)

78 
	#US_FLIDX_READ10_WORKED
 8

	)

80 
	#USB_STOR_STRING_LEN
 32

	)

89 
	#US_IOBUF_SIZE
 64

	)

90 
	#US_SENSE_SIZE
 18

	)

92 (*
	tŒªs_cmnd
)(
	tscsi_cmnd
 *, 
	tus_d©a
*);

93 (*
	tŒªs_»£t
)(
	tus_d©a
*);

94 (*
	t´Ùo_cmnd
)(
	tscsi_cmnd
*, 
	tus_d©a
*);

95 (*
	texŒa_d©a_de¡ruùÜ
)(*);

96 (*
	tpm_hook
)(
	tus_d©a
 *, );

98 
	#US_SUSPEND
 0

	)

99 
	#US_RESUME
 1

	)

102 
	sus_d©a
 {

107 
mu‹x
 
dev_mu‹x
;

108 
usb_deviû
 *
pusb_dev
;

109 
usb_š‹rçû
 *
pusb_štf
;

110 
us_unusu®_dev
 *
unusu®_dev
;

111 
fæags
;

112 
dæags
;

113 
£nd_bulk_pe
;

114 
»cv_bulk_pe
;

115 
£nd_ù¾_pe
;

116 
»cv_ù¾_pe
;

117 
»cv_šŒ_pe
;

120 *
Œª¥Üt_Çme
;

121 *
´ÙocŞ_Çme
;

122 
__Ë32
 
bcs_sigÇtu»
;

123 
u8
 
subşass
;

124 
u8
 
´ÙocŞ
;

125 
u8
 
max_lun
;

127 
u8
 
iâum
;

128 
u8
 
•_bIÁ”v®
;

131 
Œªs_cmnd
 
Œª¥Üt
;

132 
Œªs_»£t
 
Œª¥Üt_»£t
;

133 
´Ùo_cmnd
 
´Ùo_hªdËr
;

136 
scsi_cmnd
 *
¤b
;

137 
g
;

138 
scsi_Çme
[32];

141 
urb
 *
cu¼’t_urb
;

142 
usb_ù¾»que¡
 *
ü
;

143 
usb_sg_»que¡
 
cu¼’t_sg
;

144 *
iobuf
;

145 
dma_addr_t
 
iobuf_dma
;

146 
sk_¡ruù
 *
ùl_th»ad
;

149 
com¶‘iÚ
 
cmnd_»ady
;

150 
com¶‘iÚ
 
nÙify
;

151 
wa™_queue_h—d_t
 
d–ay_wa™
;

152 
d–ayed_wÜk
 
sÿn_dwÜk
;

155 *
exŒa
;

156 
exŒa_d©a_de¡ruùÜ
 
exŒa_de¡ruùÜ
;

157 #ifdeà
CONFIG_PM


158 
pm_hook
 
su¥’d_»sume_hook
;

162 
u£_Ï¡_£ùÜ_hacks
;

163 
Ï¡_£ùÜ_»Œ›s
;

167 
šlše
 
Scsi_Ho¡
 *
	$us_to_ho¡
(
us_d©a
 *
us
) {

168  
	`cÚš”_of
((*è
us
, 
Scsi_Ho¡
, 
ho¡d©a
);

169 
	}
}

170 
šlše
 
us_d©a
 *
	$ho¡_to_us
(
Scsi_Ho¡
 *
ho¡
) {

171  (
us_d©a
 *è
ho¡
->
ho¡d©a
;

172 
	}
}

175 
fl_šquœy_»¥Ú£
(
us_d©a
 *
us
,

176 *
d©a
, 
d©a_Ën
);

180 
	#scsi_uÆock
(
ho¡
è
	`¥š_uÆock_œq
(ho¡->
ho¡_lock
)

	)

181 
	#scsi_lock
(
ho¡
è
	`¥š_lock_œq
(ho¡->
ho¡_lock
)

	)

184 #ifdeà
CONFIG_PM


185 
usb_¡Ü_su¥’d
(
usb_š‹rçû
 *
içû
, 
pm_mes§ge_t
 
mes§ge
);

186 
usb_¡Ü_»sume
(
usb_š‹rçû
 *
içû
);

187 
usb_¡Ü_»£t_»sume
(
usb_š‹rçû
 *
içû
);

189 
	#usb_¡Ü_su¥’d
 
NULL


	)

190 
	#usb_¡Ü_»sume
 
NULL


	)

191 
	#usb_¡Ü_»£t_»sume
 
NULL


	)

194 
usb_¡Ü_´e_»£t
(
usb_š‹rçû
 *
içû
);

195 
usb_¡Ü_po¡_»£t
(
usb_š‹rçû
 *
içû
);

197 
usb_¡Ü_´obe1
(
us_d©a
 **
pus
,

198 
usb_š‹rçû
 *
štf
,

199 cÚ¡ 
usb_deviû_id
 *
id
,

200 
us_unusu®_dev
 *
unusu®_dev
);

201 
usb_¡Ü_´obe2
(
us_d©a
 *
us
);

202 
usb_¡Ü_discÚÃù
(
usb_š‹rçû
 *
štf
);

204 
usb_¡Ü_adju¡_quœks
(
usb_deviû
 *
dev
,

205 *
fæags
);

	@usual-tables.c

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/moduË.h
>

26 
	~<lšux/usb.h
>

27 
	~<lšux/usb_usu®.h
>

33 
	#UNUSUAL_DEV
(
id_v’dÜ
, 
id_´oduù
, 
bcdDeviûMš
, 
bcdDeviûMax
, \

34 
v’dÜName
, 
´oduùName
, 
u£PrÙocŞ
, 
u£T¿n¥Üt
, \

35 
š™FunùiÚ
, 
æags
) \

36 { 
	`USB_DEVICE_VER
(
id_v’dÜ
, 
id_´oduù
, 
bcdDeviûMš
, 
bcdDeviûMax
), \

37 .
driv”_šfo
 = (
æags
è}

	)

39 
	#COMPLIANT_DEV
 
UNUSUAL_DEV


	)

41 
	#USUAL_DEV
(
u£PrÙo
, 
u£T¿ns
) \

42 { 
	`USB_INTERFACE_INFO
(
USB_CLASS_MASS_STORAGE
, 
u£PrÙo
, 
u£T¿ns
è}

	)

45 
	#UNUSUAL_VENDOR_INTF
(
id_v’dÜ
, 
ş
, 
sc
, 
´
, \

46 
v’dÜName
, 
´oduùName
, 
u£PrÙocŞ
, 
u£T¿n¥Üt
, \

47 
š™FunùiÚ
, 
æags
) \

49 .
m©ch_æags
 = 
USB_DEVICE_ID_MATCH_INT_INFO
 \

50 | 
USB_DEVICE_ID_MATCH_VENDOR
, \

51 .
idV’dÜ
 = (
id_v’dÜ
), \

52 .
bIÁ”çûCÏss
 = (
ş
), \

53 .
bIÁ”çûSubCÏss
 = (
sc
), \

54 .
bIÁ”çûPrÙocŞ
 = (
´
), \

55 .
driv”_šfo
 = (
æags
) \

56 }

	)

58 
usb_deviû_id
 
	gusb_¡Üage_usb_ids
[] = {

59 
	~"unusu®_devs.h
"

62 
MODULE_DEVICE_TABLE
(
usb
, 
usb_¡Üage_usb_ids
);

64 #undeà
UNUSUAL_DEV


65 #undeà
COMPLIANT_DEV


66 #undeà
USUAL_DEV


67 #undeà
UNUSUAL_VENDOR_INTF


72 
	signÜe_’Œy
 {

73 
u16
 
	mvid
, 
	mpid
, 
	mbcdmš
, 
	mbcdmax
;

76 
	#UNUSUAL_DEV
(
id_v’dÜ
, 
id_´oduù
, 
bcdDeviûMš
, 
bcdDeviûMax
, \

77 
v’dÜName
, 
´oduùName
, 
u£PrÙocŞ
, 
u£T¿n¥Üt
, \

78 
š™FunùiÚ
, 
æags
) \

80 .
vid
 = 
id_v’dÜ
, \

81 .
pid
 = 
id_´oduù
, \

82 .
bcdmš
 = 
bcdDeviûMš
, \

83 .
bcdmax
 = 
bcdDeviûMax
, \

84 }

	)

86 
ignÜe_’Œy
 
	gignÜe_ids
[] = {

104 #undeà
UNUSUAL_DEV


107 
	$usb_usu®_ignÜe_deviû
(
usb_š‹rçû
 *
štf
)

109 
usb_deviû
 *
udev
;

110 
vid
, 
pid
, 
bcd
;

111 
ignÜe_’Œy
 *
p
;

113 
udev
 = 
	`š‹rçû_to_usbdev
(
štf
);

114 
vid
 = 
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idV’dÜ
);

115 
pid
 = 
	`Ë16_to_ıu
(
udev
->
desütÜ
.
idProduù
);

116 
bcd
 = 
	`Ë16_to_ıu
(
udev
->
desütÜ
.
bcdDeviû
);

118 
p
 = 
ignÜe_ids
;…->
vid
; ++p) {

119 ià(
p
->
vid
 =ğvid &&…->
pid
 ==…id &&

120 
p
->
bcdmš
 <ğ
bcd
 &&…->
bcdmax
 >= bcd)

121  -
ENXIO
;

124 
	}
}

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<lšux/sysšfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000fà

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

43 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

	@/usr/include/linux/utsname.h

1 #iâdeà
_LINUX_UTSNAME_H


2 
	#_LINUX_UTSNAME_H


	)

4 
	#__OLD_UTS_LEN
 8

	)

6 
	sŞdŞd_ut¢ame
 {

7 
	msy¢ame
[9];

8 
	mnod’ame
[9];

9 
	m»Ëa£
[9];

10 
	mv”siÚ
[9];

11 
	mmachše
[9];

14 
	#__NEW_UTS_LEN
 64

	)

16 
	sŞd_ut¢ame
 {

17 
	msy¢ame
[65];

18 
	mnod’ame
[65];

19 
	m»Ëa£
[65];

20 
	mv”siÚ
[65];

21 
	mmachše
[65];

24 
	sÃw_ut¢ame
 {

25 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

26 
	mnod’ame
[
__NEW_UTS_LEN
 + 1];

27 
	m»Ëa£
[
__NEW_UTS_LEN
 + 1];

28 
	mv”siÚ
[
__NEW_UTS_LEN
 + 1];

29 
	mmachše
[
__NEW_UTS_LEN
 + 1];

30 
	mdomašÇme
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/scsi/scsi.h

23 #iâdeà
_SCSI_SCSI_H


24 
	#_SCSI_SCSI_H
 1

	)

26 
	~<ã©u»s.h
>

32 
	#TEST_UNIT_READY
 0x00

	)

33 
	#REZERO_UNIT
 0x01

	)

34 
	#REQUEST_SENSE
 0x03

	)

35 
	#FORMAT_UNIT
 0x04

	)

36 
	#READ_BLOCK_LIMITS
 0x05

	)

37 
	#REASSIGN_BLOCKS
 0x07

	)

38 
	#READ_6
 0x08

	)

39 
	#WRITE_6
 0x0a

	)

40 
	#SEEK_6
 0x0b

	)

41 
	#READ_REVERSE
 0x0f

	)

42 
	#WRITE_FILEMARKS
 0x10

	)

43 
	#SPACE
 0x11

	)

44 
	#INQUIRY
 0x12

	)

45 
	#RECOVER_BUFFERED_DATA
 0x14

	)

46 
	#MODE_SELECT
 0x15

	)

47 
	#RESERVE
 0x16

	)

48 
	#RELEASE
 0x17

	)

49 
	#COPY
 0x18

	)

50 
	#ERASE
 0x19

	)

51 
	#MODE_SENSE
 0x1a

	)

52 
	#START_STOP
 0x1b

	)

53 
	#RECEIVE_DIAGNOSTIC
 0x1c

	)

54 
	#SEND_DIAGNOSTIC
 0x1d

	)

55 
	#ALLOW_MEDIUM_REMOVAL
 0x1e

	)

57 
	#SET_WINDOW
 0x24

	)

58 
	#READ_CAPACITY
 0x25

	)

59 
	#READ_10
 0x28

	)

60 
	#WRITE_10
 0x2a

	)

61 
	#SEEK_10
 0x2b

	)

62 
	#WRITE_VERIFY
 0x2e

	)

63 
	#VERIFY
 0x2f

	)

64 
	#SEARCH_HIGH
 0x30

	)

65 
	#SEARCH_EQUAL
 0x31

	)

66 
	#SEARCH_LOW
 0x32

	)

67 
	#SET_LIMITS
 0x33

	)

68 
	#PRE_FETCH
 0x34

	)

69 
	#READ_POSITION
 0x34

	)

70 
	#SYNCHRONIZE_CACHE
 0x35

	)

71 
	#LOCK_UNLOCK_CACHE
 0x36

	)

72 
	#READ_DEFECT_DATA
 0x37

	)

73 
	#MEDIUM_SCAN
 0x38

	)

74 
	#COMPARE
 0x39

	)

75 
	#COPY_VERIFY
 0x3a

	)

76 
	#WRITE_BUFFER
 0x3b

	)

77 
	#READ_BUFFER
 0x3c

	)

78 
	#UPDATE_BLOCK
 0x3d

	)

79 
	#READ_LONG
 0x3e

	)

80 
	#WRITE_LONG
 0x3f

	)

81 
	#CHANGE_DEFINITION
 0x40

	)

82 
	#WRITE_SAME
 0x41

	)

83 
	#READ_TOC
 0x43

	)

84 
	#LOG_SELECT
 0x4c

	)

85 
	#LOG_SENSE
 0x4d

	)

86 
	#MODE_SELECT_10
 0x55

	)

87 
	#RESERVE_10
 0x56

	)

88 
	#RELEASE_10
 0x57

	)

89 
	#MODE_SENSE_10
 0x5a

	)

90 
	#PERSISTENT_RESERVE_IN
 0x5e

	)

91 
	#PERSISTENT_RESERVE_OUT
 0x5f

	)

92 
	#MOVE_MEDIUM
 0xa5

	)

93 
	#READ_12
 0xa8

	)

94 
	#WRITE_12
 0x¯

	)

95 
	#WRITE_VERIFY_12
 0x«

	)

96 
	#SEARCH_HIGH_12
 0xb0

	)

97 
	#SEARCH_EQUAL_12
 0xb1

	)

98 
	#SEARCH_LOW_12
 0xb2

	)

99 
	#READ_ELEMENT_STATUS
 0xb8

	)

100 
	#SEND_VOLUME_TAG
 0xb6

	)

101 
	#WRITE_LONG_2
 0x—

	)

107 
	#GOOD
 0x00

	)

108 
	#CHECK_CONDITION
 0x01

	)

109 
	#CONDITION_GOOD
 0x02

	)

110 
	#BUSY
 0x04

	)

111 
	#INTERMEDIATE_GOOD
 0x08

	)

112 
	#INTERMEDIATE_C_GOOD
 0x0a

	)

113 
	#RESERVATION_CONFLICT
 0x0c

	)

114 
	#COMMAND_TERMINATED
 0x11

	)

115 
	#QUEUE_FULL
 0x14

	)

117 
	#STATUS_MASK
 0x3e

	)

123 
	#NO_SENSE
 0x00

	)

124 
	#RECOVERED_ERROR
 0x01

	)

125 
	#NOT_READY
 0x02

	)

126 
	#MEDIUM_ERROR
 0x03

	)

127 
	#HARDWARE_ERROR
 0x04

	)

128 
	#ILLEGAL_REQUEST
 0x05

	)

129 
	#UNIT_ATTENTION
 0x06

	)

130 
	#DATA_PROTECT
 0x07

	)

131 
	#BLANK_CHECK
 0x08

	)

132 
	#COPY_ABORTED
 0x0a

	)

133 
	#ABORTED_COMMAND
 0x0b

	)

134 
	#VOLUME_OVERFLOW
 0x0d

	)

135 
	#MISCOMPARE
 0x0e

	)

142 
	#TYPE_DISK
 0x00

	)

143 
	#TYPE_TAPE
 0x01

	)

144 
	#TYPE_PROCESSOR
 0x03

	)

145 
	#TYPE_WORM
 0x04

	)

146 
	#TYPE_ROM
 0x05

	)

147 
	#TYPE_SCANNER
 0x06

	)

148 
	#TYPE_MOD
 0x07

	)

150 
	#TYPE_MEDIUM_CHANGER
 0x08

	)

151 
	#TYPE_ENCLOSURE
 0x0d

	)

152 
	#TYPE_NO_LUN
 0x7f

	)

160 
	sccs_mode£l_h—d


162 
	m_r1
;

163 
	mmedium
;

164 
	m_r2
;

165 
	mblock_desc_Ëngth
;

166 
	md’s™y
;

167 
	mnumb”_blocks_hi
;

169 
	mnumb”_blocks_med
;

170 
	mnumb”_blocks_lo
;

171 
	m_r3
;

172 
	mblock_Ëngth_hi
;

174 
	mblock_Ëngth_med
;

175 
	mblock_Ëngth_lo
;

182 
	#COMMAND_COMPLETE
 0x00

	)

183 
	#EXTENDED_MESSAGE
 0x01

	)

184 
	#EXTENDED_MODIFY_DATA_POINTER
 0x00

	)

185 
	#EXTENDED_SDTR
 0x01

	)

186 
	#EXTENDED_EXTENDED_IDENTIFY
 0x02

	)

187 
	#EXTENDED_WDTR
 0x03

	)

188 
	#SAVE_POINTERS
 0x02

	)

189 
	#RESTORE_POINTERS
 0x03

	)

190 
	#DISCONNECT
 0x04

	)

191 
	#INITIATOR_ERROR
 0x05

	)

192 
	#ABORT
 0x06

	)

193 
	#MESSAGE_REJECT
 0x07

	)

194 
	#NOP
 0x08

	)

195 
	#MSG_PARITY_ERROR
 0x09

	)

196 
	#LINKED_CMD_COMPLETE
 0x0a

	)

197 
	#LINKED_FLG_CMD_COMPLETE
 0x0b

	)

198 
	#BUS_DEVICE_RESET
 0x0c

	)

200 
	#INITIATE_RECOVERY
 0x0à

	)

201 
	#RELEASE_RECOVERY
 0x10

	)

203 
	#SIMPLE_QUEUE_TAG
 0x20

	)

204 
	#HEAD_OF_QUEUE_TAG
 0x21

	)

205 
	#ORDERED_QUEUE_TAG
 0x22

	)

212 
	#SCSI_IOCTL_GET_IDLUN
 0x5382

	)

216 
	#SCSI_IOCTL_TAGGED_ENABLE
 0x5383

	)

217 
	#SCSI_IOCTL_TAGGED_DISABLE
 0x5384

	)

220 
	#SCSI_IOCTL_PROBE_HOST
 0x5385

	)

223 
	#SCSI_IOCTL_GET_BUS_NUMBER
 0x5386

	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #undeà
__USE_ISOC11


102 #undeà
__USE_ISOC99


103 #undeà
__USE_ISOC95


104 #undeà
__USE_ISOCXX11


105 #undeà
__USE_POSIX


106 #undeà
__USE_POSIX2


107 #undeà
__USE_POSIX199309


108 #undeà
__USE_POSIX199506


109 #undeà
__USE_XOPEN


110 #undeà
__USE_XOPEN_EXTENDED


111 #undeà
__USE_UNIX98


112 #undeà
__USE_XOPEN2K


113 #undeà
__USE_XOPEN2KXSI


114 #undeà
__USE_XOPEN2K8


115 #undeà
__USE_XOPEN2K8XSI


116 #undeà
__USE_LARGEFILE


117 #undeà
__USE_LARGEFILE64


118 #undeà
__USE_FILE_OFFSET64


119 #undeà
__USE_BSD


120 #undeà
__USE_SVID


121 #undeà
__USE_MISC


122 #undeà
__USE_ATFILE


123 #undeà
__USE_GNU


124 #undeà
__USE_REENTRANT


125 #undeà
__USE_FORTIFY_LEVEL


126 #undeà
__KERNEL_STRICT_NAMES


130 #iâdeà
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

143 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

150 #ifdeà
_GNU_SOURCE


151 #undeà
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #undeà
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #undeà
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #undeà
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #undeà
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #undeà
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #undeà
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #undeà
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #undeà
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #undeà
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #undeà
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #undeà
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #ià(
defšed
 
_DEFAULT_SOURCE
 \

180 || (!
defšed
 
	g__STRICT_ANSI__
 \

181 && !
defšed
 
	g_ISOC99_SOURCE
 \

182 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

183 && !
defšed
 
	g_XOPEN_SOURCE
 \

184 && !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
))

185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #undeà
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #undeà
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #ià(
defšed
 
_ISOC11_SOURCE
 \

195 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

201 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

207 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

216 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifdeà
_DEFAULT_SOURCE


224 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #undeà
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #undeà
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #undeà
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #undeà
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #undeà
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #ià(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #undeà
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #ià(
_XOPEN_SOURCE
 - 0) >= 600

285 #ià(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #undeà
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #undeà
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifdeà
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifdeà
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifdeà
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #ià
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<¡dc-´edef.h
>

360 #undeà
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

369 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

372 #iâdeà
__ASSEMBLER__


373 #iâdeà
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

388 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

389 && 
defšed
 
	g__ex‹º_šlše


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/¡ubs.h
>

	@/usr/include/linux/sysinfo.h

1 #iâdeà
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<lšux/ty³s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysšfo
 {

8 
__k”Ãl_lÚg_t
 
	mu±ime
;

9 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

10 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

11 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

12 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

13 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

14 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

15 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

16 
__u16
 
	m´ocs
;

17 
__u16
 
	m·d
;

18 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

19 
__k”Ãl_ulÚg_t
 
	mä“high
;

20 
__u32
 
	mmem_un™
;

21 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__k”Ãl_fd_£t
;

29 (*
	t__k”Ãl_sighªdËr_t
)();

32 
	t__k”Ãl_key_t
;

33 
	t__k”Ãl_mqd_t
;

35 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/stddef.h

	@
1
.
1
/usr/include
27
476
debug.h
driver.c
protocol.c
protocol.h
scsiglue.c
scsiglue.h
sd.h
transport.c
transport.h
transport1.c
uas-detect.h
unusual_devs.h
unusual_uas.h
usb.c
usb.h
usual-tables.c
/usr/include/linux/errno.h
/usr/include/linux/kernel.h
/usr/include/linux/sched.h
/usr/include/linux/utsname.h
/usr/include/scsi/scsi.h
/usr/include/features.h
/usr/include/linux/sysinfo.h
/usr/include/linux/types.h
/usr/include/stdc-predef.h
/usr/include/linux/posix_types.h
/usr/include/linux/stddef.h
